/*!
 * Cropper v0.3.2
 * https://github.com/fengyuanchen/cropper
 *
 * Copyright 2014 Fengyuan Chen
 * Released under the MIT license
 */

(function(e){typeof define=="function"&&define.amd?define(["jquery"],e):e(jQuery)})(function(e){"use strict";var t=e(window),n=function(t,r){r=e.isPlainObject(r)?r:{},this.$image=e(t),this.defaults=e.extend({},n.defaults,this.$image.data(),r),this.init()};n.prototype={construstor:n,init:function(){this.setAspectRatio(this.defaults.aspectRatio),this.render()},render:function(t){var r=this,i=this.$image,s,o;if(this.active)return;this.$clone&&this.$clone.remove(),o=i.attr("src"),s=e('<img src="'+o+'">'),s.on("load",function(){var e;s.off("load"),this.naturalWidth&&this.naturalHeight?e={naturalHeight:this.naturalHeight,naturalWidth:this.naturalWidth}:(n.fn.size(s,{height:"auto",width:"auto"}),e=n.fn.size(s),e={naturalHeight:e.height,naturalWidth:e.width}),n.fn.size(s,{height:"100%",width:"100%"}),e.aspectRatio=e.naturalWidth/e.naturalHeight,r.src=o,r.image=e,r.active=!0,r.createCropper()}),e.isFunction(t)&&i.on("ready.cropper",t),this.$clone=s,i.after(s)},unrender:function(){this.active&&(this.active=!1,this.removeCropper(),this.src="",this.image=null,this.cropper=null,this.dragger=null)},rerender:function(){this.unrender(),this.render()},resize:function(){clearTimeout(this.resizing),this.resizing=setTimeout(e.proxy(this.rerender,this),200)},createCropper:function(){this.$cropper=e(n.template),this.$dragger=this.$cropper.find(".cropper-dragger"),n.fn.toggle(this.$image),this.$image.after(this.$cropper),this.$cropper.prepend(this.$clone),this.defaults.modal||n.fn.toggle(this.$cropper.find(".cropper-modal")),this.setPreview(),this.addListener()},removeCropper:function(){this.removeListener(),this.$preview=null,this.$clone.remove(),this.$clone=null,this.$dragger=null,this.$cropper.remove(),this.$cropper=null,n.fn.toggle(this.$image)},addListener:function(){this.$cropper.bind("mousedown touchstart",e.proxy(this.dragstart,this)),this.$cropper.bind("mousemove touchmove",e.proxy(this.dragmove,this)),this.$cropper.bind("mouseup mouseleave touchend touchleave",e.proxy(this.dragend,this)),t.on("resize",e.proxy(this.resize,this))},removeListener:function(){this.$cropper.unbind("mousedown touchstart",this.dragstart),this.$cropper.unbind("mousemove touchmove",this.dragmove),this.$cropper.unbind("mouseup mouseleave touchend touchleave",this.dragend),t.off("resize",this.resize)},setPreview:function(){var e=this.defaults.preview;this.$preview=this.$cropper.find(".cropper-preview"),typeof e=="string"&&e.length>0&&(this.$preview=this.$preview.add(e)),this.$preview.html('<img src="'+this.src+'">'),this.setCropper()},setCropper:function(){var t=this.$image.parent(),r=n.fn.size(t),i=this.image,s;i.naturalWidth*r.height/i.naturalHeight-r.width>=0?(s={height:r.width/i.aspectRatio,width:r.width,left:0},s.top=(r.height-s.height)/2):(s={height:r.height,width:r.height*i.aspectRatio,top:0},s.left=(r.width-s.width)/2),e.each(s,function(e,t){s[e]=Math.round(t)}),i.height=s.height,i.width=s.width,i.ratio=i.width/i.naturalWidth,n.fn.position(t),this.$cropper.css({height:s.height,left:s.left,top:s.top,width:s.width}),this.cropper=s,this.setDragger()},setDragger:function(){var e=this.cropper,t=this.defaults.aspectRatio||this.image.aspectRatio,r;e.height*t-e.width>=0?r={height:e.width/t,width:e.width,left:0,top:(e.height-e.width/t)/2,maxWidth:e.width,maxHeight:e.width/t}:r={height:e.height,width:e.height*t,left:(e.width-e.height*t)/2,top:0,maxHeight:e.height,maxWidth:e.height*t},r.height*=.8,r.width*=.8,r.left=(e.width-r.width)/2,r.top=(e.height-r.height)/2,this.dragger=n.fn.round(r),this.setData(this.defaults.data),this.$image.trigger("ready.cropper").off("ready.cropper")},resetDragger:function(){var e=this.dragger,t=this.cropper;e.width=e.width>e.maxWidth?e.maxWidth:Math.abs(e.width),e.height=e.height>e.maxHeight?e.maxHeight:Math.abs(e.height),e.maxLeft=t.width-e.width,e.maxTop=t.height-e.height,e.left=e.left<0?0:e.left>e.maxLeft?e.maxLeft:e.left,e.top=e.top<0?0:e.top>e.maxTop?e.maxTop:e.top,e=n.fn.round(e),this.$dragger.css({height:e.height,left:e.left,top:e.top,width:e.width}),this.dragger=e,this.preview(),this.output()},dragging:function(){var e=this.direction,t=this.dragger,n=this.defaults.aspectRatio,r={x:this.endX-this.startX,y:this.endY-this.startY};n&&(r.X=r.y*n,r.Y=r.x/n);switch(e){case"e":t.width+=r.x,n&&(t.height=t.width/n,t.top-=r.Y/2),t.width<0&&(this.direction="w",t.width=0);break;case"n":t.height-=r.y,t.top+=r.y,n&&(t.width=t.height*n,t.left+=r.X/2),t.height<0&&(this.direction="s",t.height=0);break;case"w":t.width-=r.x,t.left+=r.x,n&&(t.height=t.width/n,t.top+=r.Y/2),t.width<0&&(this.direction="e",t.width=0);break;case"s":t.height+=r.y,n&&(t.width=t.height*n,t.left-=r.X/2),t.height<0&&(this.direction="n",t.height=0);break;case"ne":t.height-=r.y,t.top+=r.y,n?t.width=t.height*n:t.width+=r.x,t.height<0&&(this.direction="sw",t.height=0,t.width=0);break;case"nw":t.height-=r.y,t.top+=r.y,n?(t.width=t.height*n,t.left+=r.X):(t.width-=r.x,t.left+=r.x),t.height<0&&(this.direction="se",t.height=0,t.width=0);break;case"sw":t.width-=r.x,t.left+=r.x,n?t.height=t.width/n:t.height+=r.y,t.width<0&&(this.direction="ne",t.height=0,t.width=0);break;case"se":t.width+=r.x,n?t.height=t.width/n:t.height+=r.y,t.width<0&&(this.direction="nw",t.height=0,t.width=0);break;default:t.left+=r.x,t.top+=r.y}this.resetDragger(),this.startX=this.endX,this.startY=this.endY},output:function(){this.defaults.done(this.getData())},preview:function(){var t=this,r=t.cropper,i=t.dragger;this.$preview.each(function(){var t=e(this),s=t.outerWidth()/i.width,o={height:r.height,marginLeft:-i.left,marginTop:-i.top,width:r.width};t.css({overflow:"hidden"}),t.find("img").css(n.fn.round(o,function(e){return e*s}))})},enable:function(e){this.render(e)},disable:function(){this.unrender()},setAspectRatio:function(t){if(t==="auto"||e.isNumeric(t)&&t>0)this.defaults.aspectRatio=t==="auto"?NaN:t,this.active&&this.setDragger()},setData:function(t){var r=this.cropper,i=this.dragger,s=this.defaults.aspectRatio,o=function(e){return typeof e=="number"};if(!this.active)return;e.isPlainObject(t)&&!e.isEmptyObject(t)&&(t=n.fn.transformData(t,this.image.ratio),o(t.x1)&&t.x1<=r.width&&(i.left=t.x1),o(t.y1)&&t.y1<=r.height&&(i.top=t.y1),s?o(t.width)&&t.width<=r.width?(i.width=t.width,i.height=i.width/s):o(t.height)&&t.height<=r.height?(i.height=t.height,i.width=i.height*s):o(t.x2)&&t.x2<=r.width?(i.width=t.x2-i.left,i.height=i.width/s):o(t.y2)&&t.y2<=r.height&&(i.height=t.y2-i.top,i.width=i.height*s):(o(t.width)&&t.width<=r.width?i.width=t.width:o(t.x2)&&t.x2<=r.width&&(i.width=t.x2-i.left),o(t.height)&&t.height<=r.height?i.height=t.height:o(t.y2)&&t.height<=r.height&&(i.height=t.y2-i.top))),this.dragger=i,this.resetDragger()},getData:function(){var e=this.dragger,t={};return this.active&&(t={x1:e.left,y1:e.top,width:e.width,height:e.height,x2:e.left+e.width,y2:e.top+e.height},t=n.fn.transformData(t,1/this.image.ratio)),t},setImgSrc:function(e){typeof e=="string"&&e.length>0&&e!==this.src&&(this.$image.attr("src",e),this.rerender())},getImgInfo:function(){return this.image||{}},dragstart:function(t){var r=n.fn.getOriginalEvent(t).touches,i=t,s,o;r&&r.length===1&&(i=r[0],this.touchId=i.identifier,s=!0),o=e(i.target).data().direction,n.fn.isDirection(o)&&(this.startX=i.pageX,this.startY=i.pageY,this.direction=o,this.$image.trigger("dragstart"),s&&t.preventDefault())},dragmove:function(e){var t=n.fn.getOriginalEvent(e).changedTouches,r=e,i;if(t&&t.length===1){r=t[0],i=!0;if(r.identifier!==this.touchId)return}this.direction&&(this.$image.trigger("dragmove"),i&&e.preventDefault(),this.endX=r.pageX,this.endY=r.pageY,this.dragging())},dragend:function(e){var t=n.fn.getOriginalEvent(e).changedTouches,r=e,i;if(t&&t.length===1){r=t[0],i=!0;if(r.identifier!==this.touchId)return}this.direction&&(this.direction="",this.$image.trigger("dragend"),i&&e.preventDefault())}},n.fn={toggle:function(e){e.toggleClass("cropper-hidden")},position:function(e,t){var n=e.css("position");n==="static"&&e.css("position",t||"relative")},size:function(t,n){if(!e.isPlainObject(n))return{height:t.height(),width:t.width()};t.css(n)},round:function(t,n){var r,i;for(i in t)r=t[i],t.hasOwnProperty(i)&&typeof r=="number"&&(t[i]=Math.round(e.isFunction(n)?n(r):r));return t},transformData:function(t,n){var r=this,i={};return e.each(t,function(t,s){r.isDataOption(t)&&e.isNumeric(s)&&s>=0&&(i[t]=Math.round(s*n))}),i},getOriginalEvent:function(e){return e&&typeof e.originalEvent!="undefined"&&(e=e.originalEvent),e},isDataOption:function(e){return/^(x1|y1|x2|y2|width|height)$/i.test(e)},isDirection:function(e){return/^(\*|e|n|w|s|ne|nw|sw|se)$/i.test(e)}},n.template=['<div class="cropper-container">','<div class="cropper-modal"></div>','<div class="cropper-dragger">','<span class="cropper-preview"></span>','<span class="cropper-dashed dashed-h"></span>','<span class="cropper-dashed dashed-v"></span>','<span class="cropper-face" data-direction="*"></span>','<span class="cropper-line line-e" data-direction="e"></span>','<span class="cropper-line line-n" data-direction="n"></span>','<span class="cropper-line line-w" data-direction="w"></span>','<span class="cropper-line line-s" data-direction="s"></span>','<span class="cropper-point point-e" data-direction="e"></span>','<span class="cropper-point point-n" data-direction="n"></span>','<span class="cropper-point point-w" data-direction="w"></span>','<span class="cropper-point point-s" data-direction="s"></span>','<span class="cropper-point point-ne" data-direction="ne"></span>','<span class="cropper-point point-nw" data-direction="nw"></span>','<span class="cropper-point point-sw" data-direction="sw"></span>','<span class="cropper-point point-se" data-direction="se"></span>',"</div>","</div>"].join(""),n.defaults={aspectRatio:"auto",data:{},done:function(){},modal:!0,preview:""},n.setDefaults=function(t){e.extend(n.defaults,t)},e.fn.cropper=function(t,r){var i=this;return this.each(function(){var s=e(this),o=s.data("cropper");o||(o=new n(this,t),s.data("cropper",o)),typeof t=="string"&&e.isFunction(o[t])&&(i=o[t](r))}),typeof i!="undefined"?i:this},e.fn.cropper.Constructor=n,e.fn.cropper.setDefaults=n.setDefaults,e(function(){e("img[cropper]").cropper()})});