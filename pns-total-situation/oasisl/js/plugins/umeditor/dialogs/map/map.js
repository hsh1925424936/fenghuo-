(function(){var e="map";UM.registerWidget(e,{tpl:'<style type="text/css">.edui-dialog-map .edui-map-content{width:530px; height: 350px;margin: 10px auto;}.edui-dialog-map .edui-map-content table{width: 100%}.edui-dialog-map .edui-map-content table td{vertical-align: middle;}.edui-dialog-map .edui-map-button { border: 1px solid #ccc; float: left; cursor: default; height: 23px; width: 70px; cursor: pointer; margin: 0; font-size: 12px; line-height: 24px; text-align: center; }.edui-dialog-map .edui-map-button:hover {background:#eee;}.edui-dialog-map .edui-map-city,.edui-dialog-map .edui-map-address{height:21px;background: #FFF;border:1px solid #d7d7d7; line-height: 21px;}.edui-dialog-map .edui-map-city{width:90px}.edui-dialog-map .edui-map-address{width:150px}.edui-dialog-map .edui-map-dynamic-label span{vertical-align:middle;margin: 3px 0px 3px 3px;}.edui-dialog-map .edui-map-dynamic-label input{vertical-align:middle;margin: 3px;}</style><div class="edui-map-content"><table><tr><td><%=lang_city%>:</td><td><input class="edui-map-city" type="text" value="<%=city.value%>"/></td><td><%=lang_address%>:</td><td><input class="edui-map-address" type="text" value="" /></td><td><a class="edui-map-button"><%=lang_search%></a></td><td><label class="edui-map-dynamic-label"><input class="edui-map-dynamic" type="checkbox" name="edui-map-dynamic" /><span><%=lang_dynamicmap%></span></label></td></tr></table><div style="width:100%;height:340px;margin:5px auto;border:1px solid gray" class="edui-map-container"></div></div><script class="edui-tpl-container" type="text/plain"><!DOCTYPE html><html><head><title></title></head><body><scr_ipt>window.onload = function(){var scripts = document.scripts || document.getElementsByTagName("script"),src = [];for( var i = 1, len = scripts.length; i<len; i++ ) {src.push( scripts[i].src );}parent.UM.getEditor(<<id>>).getWidgetData(\'map\').requestMapApi( src );};function mapReadyStateChange ( state ) {  if ( state === \'complete\' || state === \'loaded\' ) { document.close();  } }</scr_ipt><scr_ipt onreadystatechange=\'mapReadyStateChange(this.readyState);\' onload=\'mapReadyStateChange("loaded");\' src="http://api.map.baidu.com/api?v=2.0&ak=6b6c1a67eaa7db1ca6d6da28e590e343&services=true"></scr_ipt></body></html></script>',initContent:function(t,n){var r=this,i=t.getLang(e),s=t.options.themePath+t.options.theme;if(r.inited)return r.preventDefault(),!1;r.inited=!0,r.lang=i,r.editor=t,r.root().html($.parseTmpl(r.tpl,$.extend({},i["static"],{theme_url:s}))),r.initRequestApi()},initRequestApi:function(){var e=null;window.BMap&&window.BMap.Map?this.initBaiduMap():(e=$('<iframe style="display: none;"></iframe>'),e.appendTo(this.root()),e=e[0].contentWindow.document,e.open(),e.write(this.root().find(".edui-tpl-container").html().replace(/scr_ipt/g,"script").replace("<<id>>","'"+this.editor.id+"'")))},requestMapApi:function(e){var t=this;if(e.length){var n=e[0];e=e.slice(1),n?$.getScript(n,function(){t.requestMapApi(e)}):t.requestMapApi(e)}else t.initBaiduMap()},initBaiduMap:function(){var e=this.root(),t=new BMap.Map(e.find(".edui-map-container")[0]),n=this,r,i,s,o=$(n.editor.selection.getRange().getClosedNode());t.enableInertialDragging(),t.enableScrollWheelZoom(),t.enableContinuousZoom();if(o.length&&/api[.]map[.]baidu[.]com/ig.test(o.attr("src"))){var u=o.attr("src"),a=n.getPars(u,"center").split(","),f=n.getPars(u,"markers").split(",");i=new BMap.Point(Number(a[0]),Number(a[1])),r=new BMap.Marker(new BMap.Point(Number(f[0]),Number(f[1]))),t.addControl(new BMap.NavigationControl),t.centerAndZoom(i,Number(n.getPars(u,"zoom"))),s=o.attr("style")}else i=new BMap.Point(116.404,39.915),r=new BMap.Marker(i),t.addControl(new BMap.NavigationControl),t.centerAndZoom(i,10);r.enableDragging(),t.addOverlay(r),n.map=t,n.marker=r,n.imgcss=s},doSearch:function(){var e=this,t=e.root().find(".edui-map-city").val(),n=e.root().find(".edui-map-address").val();if(!t){alert(e.lang.cityMsg);return}var r=new BMap.LocalSearch(t,{onSearchComplete:function(t){if(t&&t.getNumPois()){var n=[];for(var r=0;r<t.getCurrentNumPois();r++)n.push(t.getPoi(r).point);n.length>1?e.map.setViewport(n):e.map.centerAndZoom(n[0],13),point=e.map.getCenter(),e.marker.setPoint(point)}else alert(e.lang.errorMsg)}});r.search(n||t)},getPars:function(e,t){var n=new RegExp(t+"=((\\d+|[.,])*)","g");return n.exec(e)[1]},reset:function(){this.map&&this.map.reset()},initEvent:function(){var e=this,t=e.root();t.find(".edui-map-address").on("keydown",function(t){t=t||event;if(t.keyCode==13)return e.doSearch(),!1}),t.find(".edui-map-button").on("click",function(t){e.doSearch()}),t.find(".edui-map-address").focus(),t.on("mousewheel DOMMouseScroll",function(e){return!1})},width:580,height:408,buttons:{ok:{exec:function(t){var n=t.getWidgetData(e),r=n.map.getCenter(),i=n.map.getZoom(),s=n.map.getSize(),o=n.marker.P;if(n.root().find(".edui-map-dynamic")[0].checked){var u=t.getOpt("UMEDITOR_HOME_URL"),a=[u+(/\/$/.test(u)?"":"/")+"dialogs/map/map.html"+"#center="+r.lng+","+r.lat,"&zoom="+i,"&width="+s.width,"&height="+s.height,"&markers="+o.lng+","+o.lat].join("");t.execCommand("inserthtml",'<iframe class="ueditor_baidumap" src="'+a+'" frameborder="0" width="'+(s.width+4)+'" height="'+(s.height+4)+'"></iframe>')}else a="http://api.map.baidu.com/staticimage?center="+r.lng+","+r.lat+"&zoom="+i+"&width="+s.width+"&height="+s.height+"&markers="+o.lng+","+o.lat,t.execCommand("inserthtml",'<img width="'+s.width+'"height="'+s.height+'" src="'+a+'"'+(n.imgcss?' style="'+n.imgcss+'"':"")+"/>",!0);n.reset()}},cancel:{exec:function(t){t.getWidgetData(e).reset()}}}})})();