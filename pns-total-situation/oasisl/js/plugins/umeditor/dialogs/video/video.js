(function(){var e=UM.dom.domUtils,t="video";UM.registerWidget(t,{tpl:'<link rel="stylesheet" type="text/css" href="<%=video_url%>video.css" /><div class="edui-video-wrapper"><div id="eduiVideoTab"><div id="eduiVideoTabHeads" class="edui-video-tabhead"><span tabSrc="video" class="edui-video-focus"><%=lang_tab_insertV%></span></div><div id="eduiVideoTabBodys" class="edui-video-tabbody"><div id="eduiVideoPanel" class="edui-video-panel"><table><tr><td><label for="eduiVideoUrl" class="edui-video-url"><%=lang_video_url%></label></td><td><input id="eduiVideoUrl" type="text"></td></tr></table><div id="eduiVideoPreview"></div><div id="eduiVideoInfo"><fieldset><legend><%=lang_video_size%></legend><table><tr><td><label for="eduiVideoWidth"><%=lang_videoW%></label></td><td><input class="edui-video-txt" id="eduiVideoWidth" type="text"/></td></tr><tr><td><label for="eduiVideoHeight"><%=lang_videoH%></label></td><td><input class="edui-video-txt" id="eduiVideoHeight" type="text"/></td></tr></table></fieldset><fieldset><legend><%=lang_alignment%></legend><div id="eduiVideoFloat"></div></fieldset></div></div></div></div></div>',initContent:function(e,n){var r=this,i=e.getLang(t),s=UMEDITOR_CONFIG.UMEDITOR_HOME_URL+"dialogs/video/";r.lang=i,r.editor=e,r.$widget=n,r.root().html($.parseTmpl(r.tpl,$.extend({video_url:s},i["static"]))),r.initController(i)},initEvent:function(){var e=this,t=$("#eduiVideoUrl",e.$widget)[0];"oninput"in t?t.oninput=function(){e.createPreviewVideo(this.value)}:t.onpropertychange=function(){e.createPreviewVideo(this.value)}},initController:function(t){var n=this,r=n.editor.selection.getRange().getClosedNode(),i;n.createAlignButton(["eduiVideoFloat"]);if(r&&r.className=="edui-faked-video"){$("#eduiVideoUrl",n.$widget)[0].value=i=r.getAttribute("_url"),$("#eduiVideoWidth",n.$widget)[0].value=r.width,$("#eduiVideoHeight",n.$widget)[0].value=r.height;var s=e.getComputedStyle(r,"float"),o=e.getComputedStyle(r.parentNode,"text-align");n.updateAlignButton(o==="center"?"center":s)}n.createPreviewVideo(i)},createPreviewVideo:function(e){if(!e)return;var t=this,n=t.lang,r=t.convert_url(e);if(!t.endWith(r,[".swf",".flv",".wmv"])){$("#eduiVideoPreview",t.$widget).html(n.urlError);return}$("#eduiVideoPreview",t.$widget)[0].innerHTML='<embed type="application/x-shockwave-flash" pluginspage="http://www.macromedia.com/go/getflashplayer" src="'+e+'"'+' width="'+420+'"'+' height="'+280+'"'+' wmode="transparent" play="true" loop="false" menu="false" allowscriptaccess="never" allowfullscreen="true" ></embed>'},insertSingle:function(){var e=this,t=$("#eduiVideoWidth",e.$widget)[0],n=$("#eduiVideoHeight",e.$widget)[0],r=$("#eduiVideoUrl",e.$widget)[0].value,i=this.findFocus("eduiVideoFloat","name");if(!r)return!1;if(!e.checkNum([t,n]))return!1;this.editor.execCommand("insertvideo",{url:e.convert_url(r),width:t.value,height:n.value,align:i})},convert_url:function(e){if(!e)return"";var t=e.match(/youtu.be\/(\w+)$/)||e.match(/youtube\.com\/watch\?v=(\w+)/)||e.match(/youtube.com\/v\/(\w+)/),n=e.match(/youku\.com\/v_show\/id_(\w+)/),r=/player\.youku\.com/ig.test(e);return r?e=e.replace(/\?f=.*/,""):t?e="https://www.youtube.com/v/"+t[1]+"?version=3&feature=player_embedded":n?e="http://player.youku.com/player.php/sid/"+n[1]+"/v.swf":e=e.replace(/http:\/\/www\.tudou\.com\/programs\/view\/([\w\-]+)\/?/i,"http://www.tudou.com/v/$1").replace(/http:\/\/www\.youtube\.com\/watch\?v=([\w\-]+)/i,"http://www.youtube.com/v/$1").replace(/http:\/\/v\.youku\.com\/v_show\/id_([\w\-=]+)\.html/i,"http://player.youku.com/player.php/sid/$1").replace(/http:\/\/www\.56\.com\/u\d+\/v_([\w\-]+)\.html/i,"http://player.56.com/v_$1.swf").replace(/http:\/\/www.56.com\/w\d+\/play_album\-aid\-\d+_vid\-([^.]+)\.html/i,"http://player.56.com/v_$1.swf").replace(/http:\/\/v\.ku6\.com\/.+\/([^.]+)\.html/i,"http://player.ku6.com/refer/$1/v.swf").replace(/\?f=.*/,""),e},checkNum:function(t){var n=this;for(var r=0,i;i=t[r++];){var s=i.value;if(!n.isNumber(s)&&s)return alert(n.lang.numError),i.value="",i.focus(),!1}return!0},isNumber:function(e){return/(0|^[1-9]\d*$)/.test(e)},updateAlignButton:function(e){var t=$("#eduiVideoFloat",this.$widget)[0].children;for(var n=0,r;r=t[n++];)r.getAttribute("name")==e?r.className!="edui-video-focus"&&(r.className="edui-video-focus"):r.className=="edui-video-focus"&&(r.className="")},createAlignButton:function(e){var t=this.lang,n=UMEDITOR_CONFIG.UMEDITOR_HOME_URL+"dialogs/video/";for(var r=0,i;i=e[r++];){var s=$("#"+i,this.$widget)[0],o={none:t["default"],left:t.floatLeft,right:t.floatRight};for(var u in o){var a=document.createElement("div");a.setAttribute("name",u),u=="none"&&(a.className="edui-video-focus"),a.style.cssText="background:url("+n+"images/"+u+"_focus.jpg);",a.setAttribute("title",o[u]),s.appendChild(a)}this.switchSelect(i)}},switchSelect:function(e){var t=$("#"+e,this.$widget)[0].children;for(var n=0,r;r=t[n++];)$(r).on("click",function(){for(var e=0,n;n=t[e++];)n.className="",n.removeAttribute&&n.removeAttribute("class");this.className="edui-video-focus"})},findFocus:function(e,t){var n=$("#"+e,this.$widget)[0].children,r;for(var i=0,s;s=n[i++];)if(s.className=="edui-video-focus"){r=s.getAttribute(t);break}return r},endWith:function(e,t){for(var n=0,r=t.length;n<r;n++){var i=t[n];if(e.length-i.length<0)return!1;if(e.substring(e.length-i.length)==i)return!0}return!1},width:610,height:498,buttons:{ok:{exec:function(e,n){$("#eduiVideoPreview",n).html(""),e.getWidgetData(t).insertSingle()}},cancel:{exec:function(){$("#eduiVideoPreview").html("")}}}})})();