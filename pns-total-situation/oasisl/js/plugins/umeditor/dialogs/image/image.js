(function(){var utils=UM.utils,browser=UM.browser,Base={checkURL:function(e){return e?(e=utils.trim(e),e.length<=0?!1:(e.search(/http:\/\/|https:\/\//)!==0&&(e+="http://"),e=e.replace(/\?[\s\S]*$/,""),/(.gif|.jpg|.jpeg|.png)$/i.test(e)?e:!1)):!1},getAllPic:function(e,t,n){var r=this,i=[],s=$(e,t);return $.each(s,function(e,t){return $(t).removeAttr("width").removeAttr("height"),i.push({_src:t.src,src:t.src})}),i},scale:function(e,t,n,r){var i=0,s=0,o,u=e.width||n,a=e.height||r;if(u>t||a>t)if(u>=a){if(i=u-t)o=(i/u).toFixed(2),e.height=a-a*o,e.width=t}else if(s=a-t)o=(s/a).toFixed(2),e.width=u-u*o,e.height=t;return this},close:function(e){return e.css({top:(e.parent().height()-e.height())/2,left:(e.parent().width()-e.width())/2}).prev().on("click",function(){$(this).parent().remove().hasClass("edui-image-upload-item")&&(Upload.showCount--,Upload.updateView())}),this},createImgBase64:function(e,t,n){if(browser.webkit)e.src=window.webkitURL.createObjectURL(t);else if(browser.gecko)e.src=window.URL.createObjectURL(t);else{var r=new FileReader;r.onload=function(t){e.src=this.result,n.append(e)},r.readAsDataURL(t)}},callback:function(e,t,n,r){if(r=="SUCCESS"){Upload.showCount++;var i=$("<img src='"+e.options.imagePath+n+"' class='edui-image-pic' />"),s=$("<div class='edui-image-item edui-image-upload-item'><div class='edui-image-close'></div></div>").append(i);$(".edui-image-upload2",t).length<1?($(".edui-image-content",t).append(s),Upload.render(".edui-image-content",2).config(".edui-image-upload2")):$(".edui-image-upload2",t).before(s).show(),i.on("load",function(){Base.scale(this,120),Base.close($(this)),$(".edui-image-content",t).focus()})}else currentDialog.showTip(r),window.setTimeout(function(){currentDialog.hideTip()},3e3);Upload.toggleMask()}},Upload={showCount:0,uploadTpl:'<div class="edui-image-upload%%"><span class="edui-image-icon"></span><form class="edui-image-form" method="post" enctype="multipart/form-data" target="up"><input style="filter: alpha(opacity=0);" class="edui-image-file" type="file" hidefocus name="upfile" accept="image/gif,image/jpeg,image/png,image/jpg,image/bmp"/></form></div>',init:function(e,t){var n=this;return n.editor=e,n.dialog=t,n.render(".edui-image-local",1),n.config(".edui-image-upload1"),n.submit(),n.drag(),$(".edui-image-upload1").hover(function(){$(".edui-image-icon",this).toggleClass("hover")}),UM.browser.ie&&UM.browser.version<=9||$(".edui-image-dragTip",n.dialog).css("display","block"),n},render:function(e,t){var n=this;return $(e,n.dialog).append($(n.uploadTpl.replace(/%%/g,t))),n},config:function(e){var t=this,n=t.editor.options.imageUrl;return n=n+(n.indexOf("?")==-1?"?":"&")+"editorid="+t.editor.id,$("form",$(e,t.dialog)).attr("action",n),t},uploadComplete:function(r){var me=this;try{var json=eval("("+r+")");Base.callback(me.editor,me.dialog,json.url,json.state)}catch(e){var lang=me.editor.getLang("image");Base.callback(me.editor,me.dialog,"",lang&&lang.uploadError||"Error!")}},submit:function(e){var t=this,n=$('<input style="filter: alpha(opacity=0);" class="edui-image-file" type="file" hidefocus="" name="upfile" accept="image/gif,image/jpeg,image/png,image/jpg,image/bmp">'),n=n[0];return $(t.dialog).delegate(".edui-image-file","change",function(r){if(!this.parentNode)return;$('<iframe name="up"  style="display: none"></iframe>').insertBefore(t.dialog).on("load",function(){var e=this.contentWindow.document.body.innerHTML;if(e=="")return;t.uploadComplete(e),$(this).unbind("load"),$(this).remove()}),$(this).parent()[0].submit(),Upload.updateInput(n),t.toggleMask("Loading...."),e&&e()}),t},updateInput:function(e){$(".edui-image-file",this.dialog).each(function(t,n){n.parentNode.replaceChild(e.cloneNode(!0),n)})},updateView:function(){if(Upload.showCount!==0)return;$(".edui-image-upload2",this.dialog).hide(),$(".edui-image-dragTip",this.dialog).show(),$(".edui-image-upload1",this.dialog).show()},drag:function(){var e=this;UM.browser.ie9below||e.dialog.find(".edui-image-content").on("drop",function(t){var n=t.originalEvent.dataTransfer.files,r=document.createElement("img"),i=!1;$.each(n,function(t,s){if(/^image/.test(s.type)){Base.createImgBase64(r,s,e.dialog);var o=new XMLHttpRequest;o.open("post",e.editor.getOpt("imageUrl")+"?type=ajax",!0),o.setRequestHeader("X-Requested-With","XMLHttpRequest");var u=new FormData;u.append(e.editor.getOpt("imageFieldName"),s),o.send(u),o.addEventListener("load",function(i){var s=i.target.response,o;e.uploadComplete(s),t==n.length-1&&$(r).remove()}),i=!0}}),i&&(t.preventDefault(),e.toggleMask("Loading...."))}).on("dragover",function(e){e.preventDefault()})},toggleMask:function(e){var t=this,n=$(".edui-image-mask",t.dialog);if(e)UM.browser.ie&&UM.browser.version<=9||$(".edui-image-dragTip",t.dialog).css("display","none"),$(".edui-image-upload1",t.dialog).css("display","none"),n.addClass("edui-active").html(e);else{n.removeClass("edui-active").html();if(Upload.showCount>0)return t;UM.browser.ie&&UM.browser.version<=9||$(".edui-image-dragTip",t.dialog).css("display","block"),$(".edui-image-upload1",t.dialog).css("display","block")}return t}},NetWork={init:function(e,t){var n=this;n.editor=e,n.dialog=t,n.initEvt()},initEvt:function(){var e=this,t,n=$(".edui-image-searchTxt",e.dialog);$(".edui-image-searchAdd",e.dialog).on("click",function(){t=Base.checkURL(n.val()),t&&$("<img src='"+t+"' class='edui-image-pic' />").on("load",function(){var t=$("<div class='edui-image-item'><div class='edui-image-close'></div></div>").append(this);$(".edui-image-searchRes",e.dialog).append(t),Base.scale(this,120),t.width($(this).width()),Base.close($(this)),n.val("")})}).hover(function(){$(this).toggleClass("hover")})}},$tab=null,currentDialog=null;UM.registerWidget("image",{tpl:'<link rel="stylesheet" type="text/css" href="<%=image_url%>image.css"><div class="edui-image-wrapper"><ul class="edui-tab-nav"><li class="edui-tab-item edui-active"><a data-context=".edui-image-local" class="edui-tab-text"><%=lang_tab_local%></a></li><li  class="edui-tab-item"><a data-context=".edui-image-JimgSearch" class="edui-tab-text"><%=lang_tab_imgSearch%></a></li></ul><div class="edui-tab-content"><div class="edui-image-local edui-tab-pane edui-active"><div class="edui-image-content"></div><div class="edui-image-mask"></div><div class="edui-image-dragTip"><%=lang_input_dragTip%></div></div><div class="edui-image-JimgSearch edui-tab-pane"><div class="edui-image-searchBar"><table><tr><td><input class="edui-image-searchTxt" type="text"></td><td><div class="edui-image-searchAdd"><%=lang_btn_add%></div></td></tr></table></div><div class="edui-image-searchRes"></div></div></div></div>',initContent:function(e,t){var n=e.getLang("image")["static"],r=$.extend({},n,{image_url:UMEDITOR_CONFIG.UMEDITOR_HOME_URL+"dialogs/image/"});Upload.showCount=0;if(n)var i=$.parseTmpl(this.tpl,r);currentDialog=t.edui(),this.root().html(i)},initEvent:function(e,t){$tab=$.eduitab({selector:".edui-image-wrapper"}).edui().on("beforeshow",function(e){e.stopPropagation()}),Upload.init(e,t),NetWork.init(e,t)},buttons:{ok:{exec:function(e,t){var n="",r=$tab.activate();r==0?n=".edui-image-content .edui-image-pic":r==1&&(n=".edui-image-searchRes .edui-image-pic");var i=Base.getAllPic(n,t,e);r!=-1&&e.execCommand("insertimage",i)}},cancel:{}},width:700,height:408},function(e,t,n,r){Base.callback(e,t,n,r)})})();