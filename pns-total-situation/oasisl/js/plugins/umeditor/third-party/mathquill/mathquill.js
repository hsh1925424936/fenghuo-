/**
 * Copyleft 2010-2011 Jay and Han (laughinghan@gmail.com)
 *   under the GNU Lesser General Public License
 *     http://www.gnu.org/licenses/lgpl.html
 * Project Website: http://mathquill.com
 */

(function(){function a(){}function f(e){var t=u.call(arguments,1);return function(){return e.apply(this,t)}}function l(e,t){if(!t)throw new Error("prayer failed: "+e)}function m(e){l("a direction was passed",e===d||e===v)}function k(e,n,r,s){function p(){c=t;var e=u.selection?"$"+u.selection.latex()+"$":"";w.select(e)}var o=e.contents().detach();r||e.addClass("mathquill-rendered-math"),n.jQ=e.attr(i,n.id),n.revert=function(){e.empty().unbind(".mathquill").removeClass("mathquill-rendered-math mathquill-editable mathquill-textbox").append(o)};var u=n.cursor=vt(n);n.renderLatex(o.text());var f=n.textarea=g('<span class="textarea"><textarea></textarea></span>'),l=f.children(),c;n.selectionChanged=function(){c===t&&(c=setTimeout(p)),P(e[0])},e.bind("selectstart.mathquill",function(e){e.target!==l[0]&&e.preventDefault(),e.stopPropagation()});var m,b=u.blink;e.bind("mousedown.mathquill",function(n){function r(e){return u.seek(g(e.target),e.pageX,e.pageY),(u[d]!==m[d]||u.parent!==m.parent)&&u.selectFrom(m),!1}function i(e){return delete e.target,r(e)}function o(n){m=t,u.blink=b,u.selection||(s?u.show():f.detach()),e.unbind("mousemove",r),g(n.target.ownerDocument).unbind("mousemove",i).unbind("mouseup",o)}return setTimeout(function(){l.focus()}),u.blink=a,u.seek(g(n.target),n.pageX,n.pageY),m=y(u.parent,u[d],u[v]),s||e.prepend(f),e.mousemove(r),g(n.target.ownerDocument).mousemove(i).mouseup(o),!1});if(!s){var w=h(l,{container:e});e.bind("cut paste",!1).bind("copy",p).prepend('<span class="selectable">$'+n.latex()+"$</span>"),l.blur(function(){u.clearSelection(),setTimeout(E)});function E(){f.detach()}return}var w=h(l,{container:e,key:function(e,t){u.parent.bubble("onKey",e,t)},text:function(e){u.parent.bubble("onText",e)},cut:function(e){u.selection&&setTimeout(function(){u.prepareEdit(),u.parent.bubble("redraw")}),e.stopPropagation()},paste:function(e){e.slice(0,1)==="$"&&e.slice(-1)==="$"?e=e.slice(1,-1):e="\\text{"+e+"}",u.writeLatex(e).show()}});e.prepend(f),e.addClass("mathquill-editable"),r&&e.addClass("mathquill-textbox"),l.focus(function(e){u.parent||u.insAtRightEnd(n),u.parent.jQ.addClass("hasCursor"),u.selection?(u.selection.jQ.removeClass("blur"),setTimeout(n.selectionChanged)):u.show(),e.stopPropagation()}).blur(function(e){u.hide().parent.blur(),u.selection&&u.selection.jQ.addClass("blur"),e.stopPropagation()}),e.bind("focus.mathquill blur.mathquill",function(e){l.trigger(e)}).blur()}function tt(e,t,n){return c(Z,{ctrlSeq:e,htmlTemplate:"<"+t+" "+n+">&0</"+t+">"})}var e=window.jQuery,t,n,r="mathquill-command-id",i="mathquill-block-id",s=Math.min,o=Math.max,u=[].slice,c=function(e,t,n){function r(e){return typeof e=="object"}function i(e){return typeof e=="function"}function s(){}function o(u,a){function f(){var e=new l;return i(e.init)&&e.init.apply(e,arguments),e}function l(){}a===n&&(a=u,u=Object),f.Bare=l;var c=s[e]=u[e],h=l[e]=f[e]=new s,p;return h.constructor=f,f.mixin=function(t){return l[e]=f[e]=o(f,t)[e],f},(f.open=function(e){p={},i(e)?p=e.call(f,h,c,f,u):r(e)&&(p=e);if(r(p))for(var n in p)t.call(p,n)&&(h[n]=p[n]);return i(h.init)||(h.init=u),f})(a)}return o}("prototype",{}.hasOwnProperty),h=function(){function n(e){var n=e.which||e.keyCode,r=t[n],i,s=[];return e.ctrlKey&&s.push("Ctrl"),e.originalEvent&&e.originalEvent.metaKey&&s.push("Meta"),e.altKey&&s.push("Alt"),e.shiftKey&&s.push("Shift"),i=r||String.fromCharCode(n),!s.length&&!r?i:(s.push(i),s.join("-"))}var t={8:"Backspace",9:"Tab",10:"Enter",13:"Enter",16:"Shift",17:"Control",18:"Alt",20:"CapsLock",27:"Esc",32:"Spacebar",33:"PageUp",34:"PageDown",35:"End",36:"Home",37:"Left",38:"Up",39:"Right",40:"Down",45:"Insert",46:"Del",144:"NumLock"};return function(r,i){function m(e){d=e,clearTimeout(v),v=setTimeout(e)}function g(e){d(),d=a,clearTimeout(v),h.val(e),e&&h[0].select()}function y(){var e=h[0];return"selectionStart"in e?e.selectionStart!==e.selectionEnd:!1}function b(e){var t=h.val();h.val(""),t&&e(t)}function w(){f(n(s),s)}function E(e){s=e,o=null,w()}function S(e){s&&o&&w(),o=e,m(x)}function x(){if(y())return;b(u)}function T(){s=o=null}function N(e){h.focus(),m(C)}function C(){b(l)}var s=null,o=null;i||(i={});var u=i.text||a,f=i.key||a,l=i.paste||a,c=i.cut||a,h=e(r),p=e(i.container||h),d=a,v;return p.bind("keydown keypress input keyup focusout paste",function(){d()}),p.bind({keydown:E,keypress:S,focusout:T,cut:c,paste:N}),{select:g}}}(),p=c(function(e,t,n){function r(e,t){throw e?e="'"+e+"'":e="EOF","Parse Error: "+t+" at "+e}e.init=function(e){this._=e},e.parse=function(e){function t(e,t){return t}return this.skip(g)._(e,t,r)},e.or=function(e){l("or is passed a parser",e instanceof n);var t=this;return n(function(n,r,i){function s(t){return e._(n,r,i)}return t._(n,r,s)})},e.then=function(e){var t=this;return n(function(r,i,s){function o(t,r){var o=e instanceof n?e:e(r);return l("a parser is returned",o instanceof n),o._(t,i,s)}return t._(r,o,s)})},e.many=function(){var e=this;return n(function(t,n,r){function s(e,n){return t=e,i.push(n),!0}function o(){return!1}var i=[];while(e._(t,s,o));return n(t,i)})},e.times=function(e,t){arguments.length<2&&(t=e);var r=this;return n(function(n,i,s){function l(e,t){return o.push(t),n=e,!0}function c(e,t){return a=t,n=e,!1}function h(e,t){return!1}var o=[],u=!0,a;for(var f=0;f<e;f+=1){u=r._(n,l,c);if(!u)return s(n,a)}for(;f<t&&u;f+=1)u=r._(n,l,h);return i(n,o)})},e.result=function(e){return this.then(o(e))},e.atMost=function(e){return this.times(0,e)},e.atLeast=function(e){var t=this;return t.times(e).then(function(e){return t.many().map(function(t){return e.concat(t)})})},e.map=function(e){return this.then(function(t){return o(e(t))})},e.skip=function(e){return this.then(function(t){return e.result(t)})};var i=this.string=function(e){var t=e.length,r="expected '"+e+"'";return n(function(n,i,s){var o=n.slice(0,t);return o===e?i(n.slice(t),o):s(n,r)})},s=this.regex=function(e){l("regexp parser is anchored",e.toString().charAt(1)==="^");var t="expected "+e;return n(function(n,r,i){var s=e.exec(n);if(s){var o=s[0];return r(n.slice(o.length),o)}return i(n,t)})},o=n.succeed=function(e){return n(function(t,n){return n(t,e)})},u=n.fail=function(e){return n(function(t,n,r){return r(t,e)})},a=n.letter=s(/^[a-z]/i),f=n.letters=s(/^[a-z]*/i),c=n.digit=s(/^[0-9]/),h=n.digits=s(/^[0-9]*/),p=n.whitespace=s(/^\s+/),d=n.optWhitespace=s(/^\s*/),v=n.any=n(function(e,t,n){return e?t(e.slice(1),e.charAt(0)):n(e,"expected any character")}),m=n.all=n(function(e,t,n){return t("",e)}),g=n.eof=n(function(e,t,n){return e?n(e,"expected EOF"):t(e,e)})}),d=-1,v=1,g=c(e,function(e){e.insDirOf=function(e,t){return e===d?this.insertBefore(t.first()):this.insertAfter(t.last())},e.insAtDirEnd=function(e,t){return e===d?this.prependTo(t):this.appendTo(t)}}),y=c(function(e){e.parent=0,e[d]=0,e[v]=0,e.init=function(e,t,n){this.parent=e,this[d]=t,this[v]=n}}),b=c(function(e){e[d]=0,e[v]=0,e.parent=0,e.init=function(){this.ends={},this.ends[d]=0,this.ends[v]=0},e.children=function(){return w(this.ends[d],this.ends[v])},e.eachChild=function(e){return this.children().each(e)},e.foldChildren=function(e,t){return this.children().fold(e,t)},e.adopt=function(e,t,n){return w(this,this).adopt(e,t,n),this},e.disown=function(){return w(this,this).disown(),this}}),w=c(function(e){function t(e,t,n){l("a parent is always present",e),l("leftward is properly set up",function(){return t?t[v]===n&&t.parent===e:e.ends[d]===n}()),l("rightward is properly set up",function(){return n?n[d]===t&&n.parent===e:e.ends[v]===t}())}e.init=function(e,t){l("no half-empty fragments",!e==!t),this.ends={};if(!e)return;l("left end node is passed to Fragment",e instanceof b),l("right end node is passed to Fragment",t instanceof b),l("leftEnd and rightEnd have the same parent",e.parent===t.parent),this.ends[d]=e,this.ends[v]=t},e.adopt=function(e,n,r){t(e,n,r);var i=this;i.disowned=!1;var s=i.ends[d];if(!s)return this;var o=i.ends[v];return n||(e.ends[d]=s),r?r[d]=o:e.ends[v]=o,i.ends[v][v]=r,i.each(function(t){t[d]=n,t.parent=e,n&&(n[v]=t),n=t}),i},e.disown=function(){var e=this,n=e.ends[d];if(!n||e.disowned)return e;e.disowned=!0;var r=e.ends[v],i=n.parent;return t(i,n[d],n),t(i,r,r[v]),n[d]?n[d][v]=r[v]:i.ends[d]=r[v],r[v]?r[v][d]=n[d]:i.ends[v]=n[d],e},e.each=function(e){var t=this,n=t.ends[d];if(!n)return t;for(;n!==t.ends[v][v];n=n[v])if(e.call(t,n)===!1)break;return t},e.fold=function(e,t){return this.each(function(n){e=t.call(this,e,n)}),e}}),E=function(){var e=0;return function(){return e+=1}}(),S=c(b,function(e,t){e.init=function(e){t.init.call(this),this.id=E(),S[this.id]=this},e.toString=function(){return"[MathElement "+this.id+"]"},e.bubble=function(e){var t=u.call(arguments,1);for(var n=this;n;n=n.parent){var r=n[e]&&n[e].apply(n,t);if(r===!1)break}return this},e.postOrder=function(e){var t=u.call(arguments,1);if(typeof e=="string"){var n=e;e=function(e){n in e&&e[n].apply(e,t)}}(function r(t){t.eachChild(r),e(t)})(this)},e.jQ=g(),e.jQadd=function(e){this.jQ=this.jQ.add(e)},this.jQize=function(e){var t=g(e);return t.find("*").andSelf().each(function(){var e=g(this),t=e.attr("mathquill-command-id"),n=e.attr("mathquill-block-id");t&&S[t].jQadd(e),n&&S[n].jQadd(e)}),t},e.finalizeInsert=function(){var e=this;e.postOrder("finalizeTree"),e.postOrder("blur"),e.postOrder("respace"),e[v].respace&&e[v].respace(),e[d].respace&&e[d].respace(),e.postOrder("redraw"),e.bubble("redraw")}}),x=c(S,function(e,t){e.init=function(e,n,r){var i=this;t.init.call(i),i.ctrlSeq||(i.ctrlSeq=e),n&&(i.htmlTemplate=n),r&&(i.textTemplate=r)},e.replaces=function(e){e.disown(),this.replacedFragment=e},e.isEmpty=function(){return this.foldChildren(!0,function(e,t){return e&&t.isEmpty()})},e.parser=function(){var e=dt.block,t=this;return e.times(t.numBlocks()).map(function(e){t.blocks=e;for(var n=0;n<e.length;n+=1)e[n].adopt(t,t.ends[v],0);return t})},e.createLeftOf=function(e){var t=this,n=t.replacedFragment;t.createBlocks(),S.jQize(t.html()),n&&(n.adopt(t.ends[d],0,0),n.jQ.appendTo(t.ends[d].jQ)),e.jQ.before(t.jQ),e[d]=t.adopt(e.parent,e[d],e[v]),t.finalizeInsert(e),t.placeCursor(e)},e.createBlocks=function(){var e=this,t=e.numBlocks(),n=e.blocks=Array(t);for(var r=0;r<t;r+=1){var i=n[r]=N();i.adopt(e,e.ends[v],0)}},e.respace=a,e.placeCursor=function(e){e.insAtRightEnd(this.foldChildren(this.ends[d],function(e,t){return e.isEmpty()?e:t}))},e.remove=function(){return this.disown(),this.jQ.remove(),this.postOrder(function(e){delete S[e.id]}),this},e.numBlocks=function(){var e=this.htmlTemplate.match(/&\d+/g);return e?e.length:0},e.html=function(){var e=this,t=e.blocks,n=" mathquill-command-id="+e.id,r=e.htmlTemplate.match(/<[^<>]+>|[^<>]+/g);l("no unmatched angle brackets",r.join("")===this.htmlTemplate);for(var i=0,s=r[0];s;i+=1,s=r[i])if(s.slice(-2)==="/>")r[i]=s.slice(0,-2)+n+"/>";else if(s.charAt(0)==="<"){l("not an unmatched top-level close tag",s.charAt(1)!=="/"),r[i]=s.slice(0,-1)+n+">";var o=1;do i+=1,s=r[i],l("no missing close tags",s),s.slice(0,2)==="</"?o-=1:s.charAt(0)==="<"&&s.slice(-2)!=="/>"&&(o+=1);while(o>0)}return r.join("").replace(/>&(\d+)/g,function(e,n){return" mathquill-block-id="+t[n].id+">"+t[n].join("html")})},e.latex=function(){return this.foldChildren(this.ctrlSeq,function(e,t){return e+"{"+(t.latex()||" ")+"}"})},e.textTemplate=[""],e.text=function(){var e=this,t=0;return e.foldChildren(e.textTemplate[t],function(n,r){t+=1;var i=r.text();return n&&e.textTemplate[t]==="("&&i[0]==="("&&i.slice(-1)===")"?n+i.slice(1,-1)+e.textTemplate[t]:n+r.text()+(e.textTemplate[t]||"")})}}),T=c(x,function(e,t){e.init=function(e,n,r){r||(r=e&&e.length>1?e.slice(1):e),t.init.call(this,e,n,[r])},e.parser=function(){return p.succeed(this)},e.numBlocks=function(){return 0},e.replaces=function(e){e.remove()},e.createBlocks=a,e.latex=function(){return this.ctrlSeq},e.text=function(){return this.textTemplate},e.placeCursor=a,e.isEmpty=function(){return!0}}),N=c(S,function(e){e.join=function(e){return this.foldChildren("",function(t,n){return t+n[e]()})},e.latex=function(){return this.join("latex")},e.text=function(){return this.ends[d]===this.ends[v]?this.ends[d].text():"("+this.join("text")+")"},e.isEmpty=function(){return this.ends[d]===0&&this.ends[v]===0},e.write=function(e,t,n){var r;t.match(/^[a-eg-zA-Z]$/)?r=ot(t):(r=M[t]||_[t])?r=r(t):r=ut(t),n&&r.replaces(n),r.createLeftOf(e)},e.focus=function(){return this.jQ.addClass("hasCursor"),this.jQ.removeClass("empty"),this},e.blur=function(){return this.jQ.removeClass("hasCursor"),this.isEmpty()&&this.jQ.addClass("empty"),this}}),C=c(w,function(e,t){e.init=function(e,n){t.init.call(this,e,n||e),this.jQ=this.fold(g(),function(e,t){return t.jQ.add(e)})},e.latex=function(){return this.fold("",function(e,t){return e+t.latex()})},e.remove=function(){return this.jQ.remove(),this.each(function(e){e.postOrder(function(e){delete S[e.id]})}),this.disown()}}),L=c(N,function(e,t){e.latex=function(){return t.latex.call(this).replace(/(\\[a-z]+) (?![a-z])/ig,"$1")},e.text=function(){return this.foldChildren("",function(e,t){return e+t.text()})},e.renderLatex=function(e){var t=this.jQ;t.children().slice(1).remove(),this.ends[d]=this.ends[v]=0,delete this.cursor.selection,this.cursor.insAtRightEnd(this).writeLatex(e)},e.onKey=function(e,t){switch(e){case"Ctrl-Shift-Backspace":case"Ctrl-Backspace":while(this.cursor[d]||this.cursor.selection)this.cursor.backspace();break;case"Shift-Backspace":case"Backspace":this.cursor.backspace();break;case"Esc":case"Tab":case"Spacebar":var n=this.cursor.parent;if(n===this.cursor.root){e==="Spacebar"&&t.preventDefault();return}this.cursor.prepareMove(),n[v]?this.cursor.insAtLeftEnd(n[v]):this.cursor.insRightOf(n.parent);break;case"Shift-Tab":case"Shift-Esc":case"Shift-Spacebar":var n=this.cursor.parent;if(n===this.cursor.root){e==="Shift-Spacebar"&&t.preventDefault();return}this.cursor.prepareMove(),n[d]?this.cursor.insAtRightEnd(n[d]):this.cursor.insLeftOf(n.parent);break;case"Enter":break;case"End":this.cursor.prepareMove().insAtRightEnd(this.cursor.parent);break;case"Ctrl-End":this.cursor.prepareMove().insAtRightEnd(this);break;case"Shift-End":while(this.cursor[v])this.cursor.selectRight();break;case"Ctrl-Shift-End":while(this.cursor[v]||this.cursor.parent!==this)this.cursor.selectRight();break;case"Home":this.cursor.prepareMove().insAtLeftEnd(this.cursor.parent);break;case"Ctrl-Home":this.cursor.prepareMove().insAtLeftEnd(this);break;case"Shift-Home":while(this.cursor[d])this.cursor.selectLeft();break;case"Ctrl-Shift-Home":while(this.cursor[d]||this.cursor.parent!==this)this.cursor.selectLeft();break;case"Left":this.cursor.moveLeft();break;case"Shift-Left":this.cursor.selectLeft();break;case"Ctrl-Left":break;case"Right":this.cursor.moveRight();break;case"Shift-Right":this.cursor.selectRight();break;case"Ctrl-Right":break;case"Up":this.cursor.moveUp();break;case"Down":this.cursor.moveDown();break;case"Shift-Up":if(this.cursor[d])while(this.cursor[d])this.cursor.selectLeft();else this.cursor.selectLeft();case"Shift-Down":if(this.cursor[v])while(this.cursor[v])this.cursor.selectRight();else this.cursor.selectRight();case"Ctrl-Up":break;case"Ctrl-Down":break;case"Ctrl-Shift-Del":case"Ctrl-Del":while(this.cursor[v]||this.cursor.selection)this.cursor.deleteForward();break;case"Shift-Del":case"Del":this.cursor.deleteForward();break;case"Meta-A":case"Ctrl-A":if(this!==this.cursor.root)return;this.cursor.prepareMove().insAtRightEnd(this);while(this.cursor[d])this.cursor.selectLeft();break;default:return!1}return t.preventDefault(),!1},e.onText=function(e){return this.cursor.write(e),!1}}),A=c(x,function(e,t){e.init=function(e){t.init.call(this,"$"),this.cursor=e},e.htmlTemplate='<span class="mathquill-rendered-math">&0</span>',e.createBlocks=function(){this.ends[d]=this.ends[v]=L(),this.blocks=[this.ends[d]],this.ends[d].parent=this,this.ends[d].cursor=this.cursor,this.ends[d].write=function(e,t,n){t!=="$"?N.prototype.write.call(this,e,t,n):this.isEmpty()?(e.insRightOf(this.parent).backspace().show(),ut("\\$","$").createLeftOf(e)):e[v]?e[d]?N.prototype.write.call(this,e,t,n):e.insLeftOf(this.parent):e.insRightOf(this.parent)}},e.latex=function(){return"$"+this.ends[d].latex()+"$"}}),O=c(N,function(e){e.renderLatex=function(e){var t=this,n=t.cursor;t.jQ.children().slice(1).remove(),t.ends[d]=t.ends[v]=0,delete n.selection,n.show().insAtRightEnd(t);var r=p.regex,i=p.string,s=p.eof,o=p.all,u=i("$").then(dt).skip(i("$").or(s)).map(function(e){var t=A(n);t.createBlocks();var r=t.ends[d];return e.children().adopt(r,0,0),t}),a=i("\\$").result("$"),f=a.or(r(/^[^$]/)).map(ut),l=u.or(f).many(),c=l.skip(s).or(o.result(!1)).parse(e);if(c){for(var h=0;h<c.length;h+=1)c[h].adopt(t,t.ends[v],0);var m=t.join("html");S.jQize(m).appendTo(t.jQ),this.finalizeInsert()}},e.onKey=function(e){if(e==="Spacebar"||e==="Shift-Spacebar")return;L.prototype.onKey.apply(this,arguments)},e.onText=L.prototype.onText,e.write=function(e,t,n){n&&n.remove();if(t==="$")A(e).createLeftOf(e);else{var r;t==="<"?r="&lt;":t===">"&&(r="&gt;"),ut(t,r).createLeftOf(e)}}}),M={},_={},D,P=a,H=document.createElement("div"),B=H.style,j={transform:1,WebkitTransform:1,MozTransform:1,OTransform:1,msTransform:1},F;for(var I in j)if(I in B){F=I;break}F?D=function(e,t,n){e.css(F,"scale("+t+","+n+")")}:"filter"in B?(P=function(e){e.className=e.className},D=function(e,t,n){function i(){e.css("marginRight",(r.width()-1)*(t-1)/t+"px")}t/=1+(n-1)/2,e.css("fontSize",n+"em"),e.hasClass("matrixed-container")||e.addClass("matrixed-container").wrapInner('<span class="matrixed"></span>');var r=e.children().css("filter","progid:DXImageTransform.Microsoft.Matrix(M11="+t+",SizingMethod='auto expand')");i();var s=setInterval(i);g(window).load(function(){clearTimeout(s),i()})}):D=function(e,t,n){e.css("fontSize",n+"em")};var q=c(x,function(e,t){e.init=function(e,n,r){t.init.call(this,e,"<"+n+" "+r+">&0</"+n+">")}});_.mathrm=f(q,"\\mathrm","span",'class="roman font"'),_.mathit=f(q,"\\mathit","i",'class="font"'),_.mathbf=f(q,"\\mathbf","b",'class="font"'),_.mathsf=f(q,"\\mathsf","span",'class="sans-serif font"'),_.mathtt=f(q,"\\mathtt","span",'class="monospace font"'),_.underline=f(q,"\\underline","span",'class="non-leaf underline"'),_.overline=_.bar=f(q,"\\overline","span",'class="non-leaf overline"');var R=c(x,function(e,t){e.init=function(e,n,r){t.init.call(this,e,"<"+n+' class="non-leaf">&0</'+n+">",[r])},e.finalizeTree=function(){function e(e){var t=this.parent,n=e;do{if(n[v])return e.insLeftOf(t),!1;n=n.parent.parent}while(n!==t);return e.insRightOf(t),!1}l("SupSub is only _ and ^",this.ctrlSeq==="^"||this.ctrlSeq==="_"),this.ctrlSeq==="_"?(this.down=this.ends[d],this.ends[d].up=e):(this.up=this.ends[d],this.ends[d].down=e)},e.latex=function(){var e=this.ends[d].latex();return e.length===1?this.ctrlSeq+e:this.ctrlSeq+"{"+(e||" ")+"}"},e.redraw=function(){this[d]&&this[d].respace(),this[d]instanceof R||(this.respace(),this[v]&&!(this[v]instanceof R)&&this[v].respace())},e.respace=function(){this[d].ctrlSeq==="\\int "||this[d]instanceof R&&this[d].ctrlSeq!=this.ctrlSeq&&this[d][d]&&this[d][d].ctrlSeq==="\\int "?this.limit||(this.limit=!0,this.jQ.addClass("limit")):this.limit&&(this.limit=!1,this.jQ.removeClass("limit")),this.respaced=this[d]instanceof R&&this[d].ctrlSeq!=this.ctrlSeq&&!this[d].respaced;if(this.respaced){var e=+this.jQ.css("fontSize").slice(0,-2),t=this[d].jQ.outerWidth(),n=this.jQ.outerWidth();this.jQ.css({left:(this.limit&&this.ctrlSeq==="_"?-0.25:0)-t/e+"em",marginRight:.1-s(n,t)/e+"em"})}else this.limit&&this.ctrlSeq==="_"?this.jQ.css({left:"-.25em",marginRight:""}):this.jQ.css({left:"",marginRight:""});return this[v]instanceof R&&this[v].respace(),this}});_.subscript=_._=f(R,"_","sub","_"),_.superscript=_.supscript=_["^"]=f(R,"^","sup","**");var U=_.frac=_.dfrac=_.cfrac=_.fraction=c(x,function(e,t){e.ctrlSeq="\\frac",e.htmlTemplate='<span class="fraction non-leaf"><span class="numerator">&0</span><span class="denominator">&1</span><span style="display:inline-block;width:0">&nbsp;</span></span>',e.textTemplate=["(","/",")"],e.finalizeTree=function(){this.up=this.ends[v].up=this.ends[d],this.down=this.ends[d].down=this.ends[v]}}),z=_.over=M["/"]=c(U,function(e,t){e.createLeftOf=function(e){if(!this.replacedFragment){var n=e[d];while(n&&!(n instanceof lt||n instanceof Z||n instanceof ht||",;:".split("").indexOf(n.ctrlSeq)>-1))n=n[d];n instanceof ht&&n[v]instanceof R&&(n=n[v],n[v]instanceof R&&n[v].ctrlSeq!=n.ctrlSeq&&(n=n[v])),n!==e[d]&&(this.replaces(C(n[v]||e.parent.ends[d],e[d])),e[d]=n)}t.createLeftOf.call(this,e)}}),W=_.sqrt=_["√"]=c(x,function(e,t){e.ctrlSeq="\\sqrt",e.htmlTemplate='<span class="non-leaf"><span class="scaled sqrt-prefix">&radic;</span><span class="non-leaf sqrt-stem">&0</span></span>',e.textTemplate=["sqrt(",")"],e.parser=function(){return dt.optBlock.then(function(e){return dt.block.map(function(t){var n=V();return n.blocks=[e,t],e.adopt(n,0,0),t.adopt(n,e,0),n})}).or(t.parser.call(this))},e.redraw=function(){var e=this.ends[v].jQ;D(e.prev(),1,e.innerHeight()/+e.css("fontSize").slice(0,-2)-.1)}}),X=_.vec=c(x,function(e,t){e.ctrlSeq="\\vec",e.htmlTemplate='<span class="non-leaf"><span class="vector-prefix">&rarr;</span><span class="vector-stem">&0</span></span>',e.textTemplate=["vec(",")"]}),V=_.nthroot=c(W,function(e,t){e.htmlTemplate='<sup class="nthroot non-leaf">&0</sup><span class="scaled"><span class="sqrt-prefix scaled">&radic;</span><span class="sqrt-stem non-leaf">&1</span></span>',e.textTemplate=["sqrt[","](",")"],e.latex=function(){return"\\sqrt["+this.ends[d].latex()+"]{"+this.ends[v].latex()+"}"}}),$=c(x,function(e,t){e.init=function(e,n,r,i){t.init.call(this,"\\left"+r,'<span class="non-leaf"><span class="scaled paren">'+e+"</span>"+'<span class="non-leaf">&0</span>'+'<span class="scaled paren">'+n+"</span>"+"</span>",[e,n]),this.end="\\right"+i},e.jQadd=function(){t.jQadd.apply(this,arguments);var e=this.jQ;this.bracketjQs=e.children(":first").add(e.children(":last"))},e.latex=function(){return this.ctrlSeq+this.ends[d].latex()+this.end},e.redraw=function(){var e=this.ends[d].jQ,t=e.outerHeight()/+e.css("fontSize").slice(0,-2);D(this.bracketjQs,s(1+.2*(t-1),1.2),1.05*t)}});_.left=c(x,function(e){e.parser=function(){var e=p.regex,t=p.string,n=p.succeed,r=p.optWhitespace;return r.then(e(/^(?:[([|]|\\\{)/)).then(function(i){i.charAt(0)==="\\"&&(i=i.slice(1));var s=M[i]();return dt.map(function(e){s.blocks=[e],e.adopt(s,0,0)}).then(t("\\right")).skip(r).then(e(/^(?:[\])|]|\\\})/)).then(function(e){return e.slice(-1)!==s.end.slice(-1)?p.fail("open doesn't match close"):n(s)})})}}),_.right=c(x,function(e){e.parser=function(){return p.fail("unmatched \\right")}}),_.lbrace=M["{"]=f($,"{","}","\\{","\\}"),_.langle=_.lang=f($,"&lang;","&rang;","\\langle ","\\rangle ");var J=c($,function(e,t){e.createLeftOf=function(e){!e[v]&&e.parent.parent&&e.parent.parent.end===this.end&&!this.replacedFragment?e.insRightOf(e.parent.parent):t.createLeftOf.call(this,e)},e.placeCursor=function(e){this.ends[d].blur(),e.insRightOf(this)}});_.rbrace=M["}"]=f(J,"{","}","\\{","\\}"),_.rangle=_.rang=f(J,"&lang;","&rang;","\\langle ","\\rangle ");var K=function(e,t){e.init=function(e,n){t.init.call(this,e,n,e,n)}},Q=c($,K);_.lparen=M["("]=f(Q,"(",")"),_.lbrack=_.lbracket=M["["]=f(Q,"[","]");var G=c(J,K);_.rparen=M[")"]=f(G,"(",")"),_.rbrack=_.rbracket=M["]"]=f(G,"[","]");var Y=_.lpipe=_.rpipe=M["|"]=c(Q,function(e,t){e.init=function(){t.init.call(this,"|","|")},e.createLeftOf=J.prototype.createLeftOf}),Z=M.$=_.text=_.textnormal=_.textrm=_.textup=_.textmd=c(x,function(e,t){e.ctrlSeq="\\text",e.htmlTemplate='<span class="text">&0</span>',e.replaces=function(e){e instanceof C?this.replacedText=e.remove().jQ.text():typeof e=="string"&&(this.replacedText=e)},e.textTemplate=['"','"'],e.parser=function(){var e=this,t=p.string,n=p.regex,r=p.optWhitespace;return r.then(t("{")).then(n(/^[^}]*/)).skip(t("}")).map(function(t){e.createBlocks();var n=e.ends[d];for(var r=0;r<t.length;r+=1){var i=ut(t.charAt(r));i.adopt(n,n.ends[v],0)}return e})},e.createBlocks=function(){this.ends[d]=this.ends[v]=et(),this.blocks=[this.ends[d]],this.ends[d].parent=this},e.finalizeInsert=function(){this.ends[d].blur=function(){return delete this.blur,this},t.finalizeInsert.call(this)},e.createLeftOf=function(e){t.createLeftOf.call(this,this.cursor=e);if(this.replacedText)for(var n=0;n<this.replacedText.length;n+=1)this.ends[d].write(e,this.replacedText.charAt(n))}}),et=c(N,function(e,t){e.onKey=function(e,t){if(e==="Spacebar"||e==="Shift-Spacebar")return!1},e.deleteOutOf=function(e,t){this.isEmpty()&&t.insRightOf(this.parent)},e.write=function(e,t,n){n&&n.remove();if(t!=="$"){var r;t==="<"?r="&lt;":t===">"&&(r="&gt;"),ut(t,r).createLeftOf(e)}else if(this.isEmpty())e.insRightOf(this.parent).backspace(),ut("\\$","$").createLeftOf(e);else if(!e[v])e.insRightOf(this.parent);else if(!e[d])e.insLeftOf(this.parent);else{var i=Z();i.replaces(C(e[v],this.ends[v])),e.insRightOf(this.parent),i.adopt=function(){delete this.adopt,this.adopt.apply(this,arguments),this[d]=0},i.createLeftOf(e),i[d]=this.parent,e.insLeftOf(i)}return!1},e.blur=function(){this.jQ.removeClass("hasCursor");if(this.isEmpty()){var e=this.parent,t=e.cursor;t.parent===this?this.jQ.addClass("empty"):(t.hide(),e.remove(),t[v]===e?t[v]=e[v]:t[d]===e&&(t[d]=e[d]),t.show().parent.bubble("redraw"))}return this},e.focus=function(){t.focus.call(this);var e=this.parent;if(e[v].ctrlSeq===e.ctrlSeq){var n=this,r=e.cursor,i=e[v].ends[d];i.eachChild(function(e){e.parent=n,e.jQ.appendTo(n.jQ)}),this.ends[v]?this.ends[v][v]=i.ends[d]:this.ends[d]=i.ends[d],i.ends[d][d]=this.ends[v],this.ends[v]=i.ends[v],i.parent.remove(),r[d]?r.insRightOf(r[d]):r.insAtLeftEnd(this),r.parent.bubble("redraw")}else if(e[d].ctrlSeq===e.ctrlSeq){var r=e.cursor;r[d]?e[d].ends[d].focus():r.insAtRightEnd(e[d].ends[d])}return this}});_.em=_.italic=_.italics=_.emph=_.textit=_.textsl=tt("\\textit","i",'class="text"'),_.strong=_.bold=_.textbf=tt("\\textbf","b",'class="text"'),_.sf=_.textsf=tt("\\textsf","span",'class="sans-serif text"'),_.tt=_.texttt=tt("\\texttt","span",'class="monospace text"'),_.textsc=tt("\\textsc","span",'style="font-variant:small-caps" class="text"'),_.uppercase=tt("\\uppercase","span",'style="text-transform:uppercase" class="text"'),_.lowercase=tt("\\lowercase","span",'style="text-transform:lowercase" class="text"');var nt=M["\\"]=c(x,function(e,t){e.ctrlSeq="\\",e.replaces=function(e){this._replacedFragment=e.disown(),this.isEmpty=function(){return!1}},e.htmlTemplate='<span class="latex-command-input non-leaf">\\<span>&0</span></span>',e.textTemplate=["\\"],e.createBlocks=function(){t.createBlocks.call(this),this.ends[d].focus=function(){return this.parent.jQ.addClass("hasCursor"),this.isEmpty()&&this.parent.jQ.removeClass("empty"),this},this.ends[d].blur=function(){return this.parent.jQ.removeClass("hasCursor"),this.isEmpty()&&this.parent.jQ.addClass("empty"),this}},e.createLeftOf=function(e){t.createLeftOf.call(this,e),this.cursor=e.insAtRightEnd(this.ends[d]);if(this._replacedFragment){var n=this.jQ[0];this.jQ=this._replacedFragment.jQ.addClass("blur").bind("mousedown mousemove",function(e){return g(e.target=n).trigger(e),!1}).insertBefore(this.jQ).add(this.jQ)}this.ends[d].write=function(e,t,n){n&&n.remove(),t.match(/[a-z]/i)?ut(t).createLeftOf(e):(this.parent.renderCommand(),(t!=="\\"||!this.isEmpty())&&this.parent.parent.write(e,t))}},e.latex=function(){return"\\"+this.ends[d].latex()+" "},e.onKey=function(e,t){if(e==="Tab"||e==="Enter"||e==="Spacebar")return this.renderCommand(),t.preventDefault(),!1},e.renderCommand=function(){this.jQ=this.jQ.last(),this.remove(),this[v]?this.cursor.insLeftOf(this[v]):this.cursor.insAtRightEnd(this.parent);var e=this.ends[d].latex(),t;e||(e="backslash"),this.cursor.insertCmd(e,this._replacedFragment)}}),rt=_.binom=_.binomial=c(x,function(e,t){e.ctrlSeq="\\binom",e.htmlTemplate='<span class="paren scaled">(</span><span class="non-leaf"><span class="array non-leaf"><span>&0</span><span>&1</span></span></span><span class="paren scaled">)</span>',e.textTemplate=["choose(",",",")"],e.redraw=function(){var e=this.jQ.eq(1),t=e.outerHeight()/+e.css("fontSize").slice(0,-2),n=this.jQ.filter(".paren");D(n,s(1+.2*(t-1),1.2),1.05*t)}}),it=_.choose=c(rt,function(e){e.createLeftOf=z.prototype.createLeftOf}),st=_.vector=c(x,function(e,t){e.ctrlSeq="\\vector",e.htmlTemplate='<span class="array"><span>&0</span></span>',e.latex=function(){return"\\begin{matrix}"+this.foldChildren([],function(e,t){return e.push(t.latex()),e}).join("\\\\")+"\\end{matrix}"},e.text=function(){return"["+this.foldChildren([],function(e,t){return e.push(t.text()),e}).join()+"]"},e.createLeftOf=function(e){t.createLeftOf.call(this,this.cursor=e)},e.onKey=function(e,t){var n=this.cursor.parent;if(n.parent===this){if(e==="Enter"){var r=N();return r.parent=this,r.jQ=g("<span></span>").attr(i,r.id).insertAfter(n.jQ),n[v]?n[v][d]=r:this.ends[v]=r,r[v]=n[v],n[v]=r,r[d]=n,this.bubble("redraw").cursor.insAtRightEnd(r),t.preventDefault(),!1}if(e==="Tab"&&!n[v]){if(n.isEmpty()){if(n[d])return this.cursor.insRightOf(this),delete n[d][v],this.ends[v]=n[d],n.jQ.remove(),this.bubble("redraw"),t.preventDefault(),!1;return}var r=N();return r.parent=this,r.jQ=g("<span></span>").attr(i,r.id).appendTo(this.jQ),this.ends[v]=r,n[v]=r,r[d]=n,this.bubble("redraw").cursor.insAtRightEnd(r),t.preventDefault(),!1}if(t.which===8){if(n.isEmpty())return n[d]?(this.cursor.insAtRightEnd(n[d]),n[d][v]=n[v]):(this.cursor.insLeftOf(this),this.ends[d]=n[v]),n[v]?n[v][d]=n[d]:this.ends[v]=n[d],n.jQ.remove(),this.isEmpty()?this.cursor.deleteForward():this.bubble("redraw"),t.preventDefault(),!1;if(!this.cursor[d])return t.preventDefault(),!1}}}});_.editable=c(A,function(e,t){e.init=function(){x.prototype.init.call(this,"\\editable")},e.jQadd=function(){var e=this;t.jQadd.apply(e,arguments);var n=e.ends[d].disown(),r=e.jQ.children().detach();e.ends[d]=e.ends[v]=L(),e.blocks=[e.ends[d]],e.ends[d].parent=e,k(e.jQ,e.ends[d],!1,!0),e.cursor=e.ends[d].cursor,n.children().adopt(e.ends[d],0,0),r.appendTo(e.ends[d].jQ),e.ends[d].cursor.insAtRightEnd(e.ends[d])},e.latex=function(){return this.ends[d].latex()},e.text=function(){return this.ends[d].text()}}),_.f=f(T,"f",'<var class="florin">&fnof;</var><span style="display:inline-block;width:0">&nbsp;</span>');var ot=c(T,function(e,t){e.init=function(e,n){t.init.call(this,e,"<var>"+(n||e)+"</var>")},e.text=function(){var e=this.ctrlSeq;return this[d]&&!(this[d]instanceof ot)&&!(this[d]instanceof lt)&&(e="*"+e),this[v]&&!(this[v]instanceof lt)&&this[v].ctrlSeq!=="^"&&(e+="*"),e}}),ut=c(T,function(e,t){e.init=function(e,n){t.init.call(this,e,"<span>"+(n||e)+"</span>")}});M[" "]=f(ut,"\\:"," "),_.prime=M["'"]=f(ut,"'","&prime;");var at=c(T,function(e,t){e.init=function(e,n){t.init.call(this,e,'<span class="nonSymbola">'+(n||e)+"</span>")}});_["@"]=at,_["&"]=f(at,"\\&","&amp;"),_["%"]=f(at,"\\%","%"),_.alpha=_.beta=_.gamma=_.delta=_.zeta=_.eta=_.theta=_.iota=_.kappa=_.mu=_.nu=_.xi=_.rho=_.sigma=_.tau=_.chi=_.psi=_.omega=c(ot,function(e,t){e.init=function(e){t.init.call(this,"\\"+e+" ","&"+e+";")}}),_.phi=f(ot,"\\phi ","&#981;"),_.phiv=_.varphi=f(ot,"\\varphi ","&phi;"),_.epsilon=f(ot,"\\epsilon ","&#1013;"),_.epsiv=_.varepsilon=f(ot,"\\varepsilon ","&epsilon;"),_.piv=_.varpi=f(ot,"\\varpi ","&piv;"),_.sigmaf=_.sigmav=_.varsigma=f(ot,"\\varsigma ","&sigmaf;"),_.thetav=_.vartheta=_.thetasym=f(ot,"\\vartheta ","&thetasym;"),_.upsilon=_.upsi=f(ot,"\\upsilon ","&upsilon;"),_.gammad=_.Gammad=_.digamma=f(ot,"\\digamma ","&#989;"),_.kappav=_.varkappa=f(ot,"\\varkappa ","&#1008;"),_.rhov=_.varrho=f(ot,"\\varrho ","&#1009;"),_.pi=_["π"]=f(at,"\\pi ","&pi;"),_.lambda=f(at,"\\lambda ","&lambda;"),_.Upsilon=_.Upsi=_.upsih=_.Upsih=f(T,"\\Upsilon ",'<var style="font-family: serif">&upsih;</var>'),_.Gamma=_.Delta=_.Theta=_.Lambda=_.Xi=_.Pi=_.Sigma=_.Phi=_.Psi=_.Omega=_.forall=c(ut,function(e,t){e.init=function(e){t.init.call(this,"\\"+e+" ","&"+e+";")}});var ft=c(x,function(e){e.init=function(e){this.latex=e},e.createLeftOf=function(e){e.writeLatex(this.latex)},e.parser=function(){var e=dt.parse(this.latex).children();return p.succeed(e)}});_["¹"]=f(ft,"^1"),_["²"]=f(ft,"^2"),_["³"]=f(ft,"^3"),_["¼"]=f(ft,"\\frac14"),_["½"]=f(ft,"\\frac12"),_["¾"]=f(ft,"\\frac34");var lt=c(T,function(e,t){e.init=function(e,n,r){t.init.call(this,e,'<span class="binary-operator">'+n+"</span>",r)}}),ct=c(lt,function(e){e.init=ut.prototype.init,e.respace=function(){return this[d]?this[d]instanceof lt&&this[v]&&!(this[v]instanceof lt)?this.jQ[0].className="unary-operator":this.jQ[0].className="binary-operator":this.jQ[0].className="",this}});_["+"]=f(ct,"+","+"),_["–"]=_["-"]=f(ct,"-","&minus;"),_["±"]=_.pm=_.plusmn=_.plusminus=f(ct,"\\pm ","&plusmn;"),_.mp=_.mnplus=_.minusplus=f(ct,"\\mp ","&#8723;"),M["*"]=_.sdot=_.cdot=f(lt,"\\cdot ","&middot;"),_["="]=f(lt,"=","="),_["<"]=f(lt,"<","&lt;"),_[">"]=f(lt,">","&gt;"),_.notin=_.sim=_.cong=_.equiv=_.oplus=_.otimes=c(lt,function(e,t){e.init=function(e){t.init.call(this,"\\"+e+" ","&"+e+";")}}),_.times=f(lt,"\\times ","&times;","[x]"),_["÷"]=_.div=_.divide=_.divides=f(lt,"\\div ","&divide;","[/]"),_["≠"]=_.ne=_.neq=f(lt,"\\ne ","&ne;"),_.ast=_.star=_.loast=_.lowast=f(lt,"\\ast ","&lowast;"),_.therefor=_.therefore=f(lt,"\\therefore ","&there4;"),_.cuz=_.because=f(lt,"\\because ","&#8757;"),_.prop=_.propto=f(lt,"\\propto ","&prop;"),_["≈"]=_.asymp=_.approx=f(lt,"\\approx ","&asymp;"),_.lt=f(lt,"<","&lt;"),_.gt=f(lt,">","&gt;"),_["≤"]=_.le=_.leq=f(lt,"\\le ","&le;"),_["≥"]=_.ge=_.geq=f(lt,"\\ge ","&ge;"),_.isin=_["in"]=f(lt,"\\in ","&isin;"),_.ni=_.contains=f(lt,"\\ni ","&ni;"),_.notni=_.niton=_.notcontains=_.doesnotcontain=f(lt,"\\not\\ni ","&#8716;"),_.sub=_.subset=f(lt,"\\subset ","&sub;"),_.sup=_.supset=_.superset=f(lt,"\\supset ","&sup;"),_.nsub=_.notsub=_.nsubset=_.notsubset=f(lt,"\\not\\subset ","&#8836;"),_.nsup=_.notsup=_.nsupset=_.notsupset=_.nsuperset=_.notsuperset=f(lt,"\\not\\supset ","&#8837;"),_.sube=_.subeq=_.subsete=_.subseteq=f(lt,"\\subseteq ","&sube;"),_.supe=_.supeq=_.supsete=_.supseteq=_.supersete=_.superseteq=f(lt,"\\supseteq ","&supe;"),_.nsube=_.nsubeq=_.notsube=_.notsubeq=_.nsubsete=_.nsubseteq=_.notsubsete=_.notsubseteq=f(lt,"\\not\\subseteq ","&#8840;"),_.nsupe=_.nsupeq=_.notsupe=_.notsupeq=_.nsupsete=_.nsupseteq=_.notsupsete=_.notsupseteq=_.nsupersete=_.nsuperseteq=_.notsupersete=_.notsuperseteq=f(lt,"\\not\\supseteq ","&#8841;");var ht=c(T,function(e,t){e.init=function(e,n){t.init.call(this,e,"<big>"+n+"</big>")}});_["∑"]=_.sum=_.summation=f(ht,"\\sum ","&sum;"),_["∏"]=_.prod=_.product=f(ht,"\\prod ","&prod;"),_.coprod=_.coproduct=f(ht,"\\coprod ","&#8720;"),_["∫"]=_["int"]=_.integral=f(ht,"\\int ","&int;"),_.N=_.naturals=_.Naturals=f(ut,"\\mathbb{N}","&#8469;"),_.P=_.primes=_.Primes=_.projective=_.Projective=_.probability=_.Probability=f(ut,"\\mathbb{P}","&#8473;"),_.Z=_.integers=_.Integers=f(ut,"\\mathbb{Z}","&#8484;"),_.Q=_.rationals=_.Rationals=f(ut,"\\mathbb{Q}","&#8474;"),_.R=_.reals=_.Reals=f(ut,"\\mathbb{R}","&#8477;"),_.C=_.complex=_.Complex=_.complexes=_.Complexes=_.complexplane=_.Complexplane=_.ComplexPlane=f(ut,"\\mathbb{C}","&#8450;"),_.H=_.Hamiltonian=_.quaternions=_.Quaternions=f(ut,"\\mathbb{H}","&#8461;"),_.quad=_.emsp=f(ut,"\\quad ","    "),_.qquad=f(ut,"\\qquad ","        "),_.diamond=f(ut,"\\diamond ","&#9671;"),_.bigtriangleup=f(ut,"\\bigtriangleup ","&#9651;"),_.ominus=f(ut,"\\ominus ","&#8854;"),_.uplus=f(ut,"\\uplus ","&#8846;"),_.bigtriangledown=f(ut,"\\bigtriangledown ","&#9661;"),_.sqcap=f(ut,"\\sqcap ","&#8851;"),_.triangleleft=f(ut,"\\triangleleft ","&#8882;"),_.sqcup=f(ut,"\\sqcup ","&#8852;"),_.triangleright=f(ut,"\\triangleright ","&#8883;"),_.odot=f(ut,"\\odot ","&#8857;"),_.bigcirc=f(ut,"\\bigcirc ","&#9711;"),_.dagger=f(ut,"\\dagger ","&#0134;"),_.ddagger=f(ut,"\\ddagger ","&#135;"),_.wr=f(ut,"\\wr ","&#8768;"),_.amalg=f(ut,"\\amalg ","&#8720;"),_.models=f(ut,"\\models ","&#8872;"),_.prec=f(ut,"\\prec ","&#8826;"),_.succ=f(ut,"\\succ ","&#8827;"),_.preceq=f(ut,"\\preceq ","&#8828;"),_.succeq=f(ut,"\\succeq ","&#8829;"),_.simeq=f(ut,"\\simeq ","&#8771;"),_.mid=f(ut,"\\mid ","&#8739;"),_.ll=f(ut,"\\ll ","&#8810;"),_.gg=f(ut,"\\gg ","&#8811;"),_.parallel=f(ut,"\\parallel ","&#8741;"),_.bowtie=f(ut,"\\bowtie ","&#8904;"),_.sqsubset=f(ut,"\\sqsubset ","&#8847;"),_.sqsupset=f(ut,"\\sqsupset ","&#8848;"),_.smile=f(ut,"\\smile ","&#8995;"),_.sqsubseteq=f(ut,"\\sqsubseteq ","&#8849;"),_.sqsupseteq=f(ut,"\\sqsupseteq ","&#8850;"),_.doteq=f(ut,"\\doteq ","&#8784;"),_.frown=f(ut,"\\frown ","&#8994;"),_.vdash=f(ut,"\\vdash ","&#8870;"),_.dashv=f(ut,"\\dashv ","&#8867;"),_.longleftarrow=f(ut,"\\longleftarrow ","&#8592;"),_.longrightarrow=f(ut,"\\longrightarrow ","&#8594;"),_.Longleftarrow=f(ut,"\\Longleftarrow ","&#8656;"),_.Longrightarrow=f(ut,"\\Longrightarrow ","&#8658;"),_.longleftrightarrow=f(ut,"\\longleftrightarrow ","&#8596;"),_.updownarrow=f(ut,"\\updownarrow ","&#8597;"),_.Longleftrightarrow=f(ut,"\\Longleftrightarrow ","&#8660;"),_.Updownarrow=f(ut,"\\Updownarrow ","&#8661;"),_.mapsto=f(ut,"\\mapsto ","&#8614;"),_.nearrow=f(ut,"\\nearrow ","&#8599;"),_.hookleftarrow=f(ut,"\\hookleftarrow ","&#8617;"),_.hookrightarrow=f(ut,"\\hookrightarrow ","&#8618;"),_.searrow=f(ut,"\\searrow ","&#8600;"),_.leftharpoonup=f(ut,"\\leftharpoonup ","&#8636;"),_.rightharpoonup=f(ut,"\\rightharpoonup ","&#8640;"),_.swarrow=f(ut,"\\swarrow ","&#8601;"),_.leftharpoondown=f(ut,"\\leftharpoondown ","&#8637;"),_.rightharpoondown=f(ut,"\\rightharpoondown ","&#8641;"),_.nwarrow=f(ut,"\\nwarrow ","&#8598;"),_.ldots=f(ut,"\\ldots ","&#8230;"),_.cdots=f(ut,"\\cdots ","&#8943;"),_.vdots=f(ut,"\\vdots ","&#8942;"),_.ddots=f(ut,"\\ddots ","&#8944;"),_.surd=f(ut,"\\surd ","&#8730;"),_.triangle=f(ut,"\\triangle ","&#9653;"),_.ell=f(ut,"\\ell ","&#8467;"),_.top=f(ut,"\\top ","&#8868;"),_.flat=f(ut,"\\flat ","&#9837;"),_.natural=f(ut,"\\natural ","&#9838;"),_.sharp=f(ut,"\\sharp ","&#9839;"),_.wp=f(ut,"\\wp ","&#8472;"),_.bot=f(ut,"\\bot ","&#8869;"),_.clubsuit=f(ut,"\\clubsuit ","&#9827;"),_.diamondsuit=f(ut,"\\diamondsuit ","&#9826;"),_.heartsuit=f(ut,"\\heartsuit ","&#9825;"),_.spadesuit=f(ut,"\\spadesuit ","&#9824;"),_.oint=f(ut,"\\oint ","&#8750;"),_.bigcap=f(ut,"\\bigcap ","&#8745;"),_.bigcup=f(ut,"\\bigcup ","&#8746;"),_.bigsqcup=f(ut,"\\bigsqcup ","&#8852;"),_.bigvee=f(ut,"\\bigvee ","&#8744;"),_.bigwedge=f(ut,"\\bigwedge ","&#8743;"),_.bigodot=f(ut,"\\bigodot ","&#8857;"),_.bigotimes=f(ut,"\\bigotimes ","&#8855;"),_.bigoplus=f(ut,"\\bigoplus ","&#8853;"),_.biguplus=f(ut,"\\biguplus ","&#8846;"),_.lfloor=f(ut,"\\lfloor ","&#8970;"),_.rfloor=f(ut,"\\rfloor ","&#8971;"),_.lceil=f(ut,"\\lceil ","&#8968;"),_.rceil=f(ut,"\\rceil ","&#8969;"),_.slash=f(ut,"\\slash ","&#47;"),_.opencurlybrace=f(ut,"\\opencurlybrace ","&#123;"),_.closecurlybrace=f(ut,"\\closecurlybrace ","&#125;"),_.caret=f(ut,"\\caret ","^"),_.underscore=f(ut,"\\underscore ","_"),_.backslash=f(ut,"\\backslash ","\\"),_.vert=f(ut,"|"),_.perp=_.perpendicular=f(ut,"\\perp ","&perp;"),_.nabla=_.del=f(ut,"\\nabla ","&nabla;"),_.hbar=f(ut,"\\hbar ","&#8463;"),_.AA=_.Angstrom=_.angstrom=f(ut,"\\text\\AA ","&#8491;"),_.ring=_.circ=_.circle=f(ut,"\\circ ","&#8728;"),_.bull=_.bullet=f(ut,"\\bullet ","&bull;"),_.setminus=_.smallsetminus=f(ut,"\\setminus ","&#8726;"),_.not=_["¬"]=_.neg=f(ut,"\\neg ","&not;"),_["…"]=_.dots=_.ellip=_.hellip=_.ellipsis=_.hellipsis=f(ut,"\\dots ","&hellip;"),_.converges=_.darr=_.dnarr=_.dnarrow=_.downarrow=f(ut,"\\downarrow ","&darr;"),_.dArr=_.dnArr=_.dnArrow=_.Downarrow=f(ut,"\\Downarrow ","&dArr;"),_.diverges=_.uarr=_.uparrow=f(ut,"\\uparrow ","&uarr;"),_.uArr=_.Uparrow=f(ut,"\\Uparrow ","&uArr;"),_.to=f(lt,"\\to ","&rarr;"),_.rarr=_.rightarrow=f(ut,"\\rightarrow ","&rarr;"),_.implies=f(lt,"\\Rightarrow ","&rArr;"),_.rArr=_.Rightarrow=f(ut,"\\Rightarrow ","&rArr;"),_.gets=f(lt,"\\gets ","&larr;"),_.larr=_.leftarrow=f(ut,"\\leftarrow ","&larr;"),_.impliedby=f(lt,"\\Leftarrow ","&lArr;"),_.lArr=_.Leftarrow=f(ut,"\\Leftarrow ","&lArr;"),_.harr=_.lrarr=_.leftrightarrow=f(ut,"\\leftrightarrow ","&harr;"),_.iff=f(lt,"\\Leftrightarrow ","&hArr;"),_.hArr=_.lrArr=_.Leftrightarrow=f(ut,"\\Leftrightarrow ","&hArr;"),_.Re=_.Real=_.real=f(ut,"\\Re ","&real;"),_.Im=_.imag=_.image=_.imagin=_.imaginary=_.Imaginary=f(ut,"\\Im ","&image;"),_.part=_.partial=f(ut,"\\partial ","&part;"),_.inf=_.infin=_.infty=_.infinity=f(ut,"\\infty ","&infin;"),_.alef=_.alefsym=_.aleph=_.alephsym=f(ut,"\\aleph ","&alefsym;"),_.xist=_.xists=_.exist=_.exists=f(ut,"\\exists ","&exist;"),_.and=_.land=_.wedge=f(ut,"\\wedge ","&and;"),_.or=_.lor=_.vee=f(ut,"\\vee ","&or;"),_.o=_.O=_.empty=_.emptyset=_.oslash=_.Oslash=_.nothing=_.varnothing=f(lt,"\\varnothing ","&empty;"),_.cup=_.union=f(lt,"\\cup ","&cup;"),_.cap=_.intersect=_.intersection=f(lt,"\\cap ","&cap;"),_.deg=_.degree=f(ut,"^\\circ ","&deg;"),_.ang=_.angle=f(ut,"\\angle ","&ang;");var pt=c(T,function(e,t){e.init=function(e){t.init.call(this,"\\"+e+" ","<span>"+e+"</span>")},e.respace=function(){this.jQ[0].className=this[v]instanceof R||this[v]instanceof $?"":"non-italicized-function"}});_.ln=_.lg=_.log=_.span=_.proj=_.det=_.dim=_.min=_.max=_.mod=_.lcm=_.gcd=_.gcf=_.hcf=_.lim=pt,function(){var e=["sin","cos","tan","sec","cosec","csc","cotan","cot"];for(var t in e)_[e[t]]=_[e[t]+"h"]=_["a"+e[t]]=_["arc"+e[t]]=_["a"+e[t]+"h"]=_["arc"+e[t]+"h"]=pt}();var dt=function(){function e(e){var t=N();return e.adopt(t,0,0),t}function t(e){var t=e[0]||N();for(var n=1;n<e.length;n+=1)e[n].children().adopt(t,t.ends[v],0);return t}var n=p.string,r=p.regex,i=p.letter,s=p.any,o=p.optWhitespace,u=p.succeed,a=p.fail,f=i.map(ot),l=r(/^[^${}\\_^]/).map(ut),c=r(/^[^\\a-eg-zA-Z]/).or(n("\\").then(r(/^[a-z]+/i).or(r(/^\s+/).result(" ")).or(s))).then(function(e){var t=_[e];return t?t(e).parser():a("unknown command: \\"+e)}),h=c.or(f).or(l),d=n("{").then(function(){return g}).skip(n("}")),m=o.then(d.or(h.map(e))),g=m.many().map(t).skip(o),y=n("[").then(m.then(function(e){return e.join("latex")!=="]"?u(e):a()}).many().map(t).skip(o)).skip(n("]")),b=g;return b.block=m,b.optBlock=y,b}(),vt=c(y,function(e){function t(e,t){if(e[v][t])e.insAtLeftEnd(e[v][t]);else if(e[d][t])e.insAtRightEnd(e[d][t]);else{var r=e.parent;do{var i=r[t];if(i){typeof i=="function"&&(i=r[t](e));if(i===!1||i instanceof N){e.upDownCache[r.id]=y(e.parent,e[d],e[v]);if(i instanceof N){var s=e.upDownCache[i.id];if(s)s[v]?e.insLeftOf(s[v]):e.insAtRightEnd(s.parent);else{var o=n(e).left;e.insAtRightEnd(i),e.seekHoriz(o,i)}}break}}r=r.parent.parent}while(r)}return e.clearSelection().show()}function n(e){var t=e.jQ.removeClass("cursor").offset();return e.jQ.addClass("cursor"),t}function s(e){e.upDownCache={}}e.init=function(e){this.parent=this.root=e;var t=this.jQ=this._jQ=g('<span class="cursor">&zwj;</span>');this.blink=function(){t.toggleClass("blink")},this.upDownCache={}},e.show=function(){return this.jQ=this._jQ.removeClass("blink"),"intervalId"in this?clearInterval(this.intervalId):(this[v]?this.selection&&this.selection.ends[d][d]===this[d]?this.jQ.insertBefore(this.selection.jQ):this.jQ.insertBefore(this[v].jQ.first()):this.jQ.appendTo(this.parent.jQ),this.parent.focus()),this.intervalId=setInterval(this.blink,500),this},e.hide=function(){return"intervalId"in this&&clearInterval(this.intervalId),delete this.intervalId,this.jQ.detach(),this.jQ=g(),this},e.withDirInsertAt=function(e,t,n,r){var i=this.parent;this.parent=t,this[e]=n,this[-e]=r,i.blur()},e.insDirOf=function(e,t){return m(e),this.withDirInsertAt(e,t.parent,t[e],t),this.parent.jQ.addClass("hasCursor"),this.jQ.insDirOf(e,t.jQ),this},e.insLeftOf=function(e){return this.insDirOf(d,e)},e.insRightOf=function(e){return this.insDirOf(v,e)},e.insAtDirEnd=function(e,t){return m(e),this.withDirInsertAt(e,t,0,t.ends[e]),e===d&&t.textarea?this.jQ.insDirOf(-e,t.textarea):this.jQ.insAtDirEnd(e,t.jQ),t.focus(),this},e.insAtLeftEnd=function(e){return this.insAtDirEnd(d,e)},e.insAtRightEnd=function(e){return this.insAtDirEnd(v,e)},e.hopDir=function(e){return m(e),this.jQ.insDirOf(e,this[e].jQ),this[-e]=this[e],this[e]=this[e][e],this},e.hopLeft=function(){return this.hopDir(d)},e.hopRight=function(){return this.hopDir(v)},e.moveDirWithin=function(e,t){m(e);if(this[e])this[e].ends[-e]?this.insAtDirEnd(-e,this[e].ends[-e]):this.hopDir(e);else{if(this.parent===t)return;this.parent[e]?this.insAtDirEnd(-e,this.parent[e]):this.insDirOf(e,this.parent.parent)}},e.moveLeftWithin=function(e){return this.moveDirWithin(d,e)},e.moveRightWithin=function(e){return this.moveDirWithin(v,e)},e.moveDir=function(e){return m(e),s(this),this.selection?this.insDirOf(e,this.selection.ends[e]).clearSelection():this.moveDirWithin(e,this.root),this.show()},e.moveLeft=function(){return this.moveDir(d)},e.moveRight=function(){return this.moveDir(v)},e.moveUp=function(){return t(this,"up")},e.moveDown=function(){return t(this,"down")},e.seek=function(e,t,n){s(this);var o,u,a=this.clearSelection().show();return e.hasClass("empty")?(a.insAtLeftEnd(S[e.attr(i)]),a):(o=S[e.attr(r)],o instanceof T?(e.outerWidth()>2*(t-e.offset().left)?a.insLeftOf(o):a.insRightOf(o),a):(o||(u=S[e.attr(i)],u||(e=e.parent(),o=S[e.attr(r)],o||(u=S[e.attr(i)],u||(u=a.root)))),o?a.insRightOf(o):a.insAtRightEnd(u),a.seekHoriz(t,a.root)))},e.seekHoriz=function(e,t){var r=this,i=n(r).left-e,s;do r.moveLeftWithin(t),s=i,i=n(r).left-e;while(i>0&&(r[d]||r.parent!==t));return-i>s&&r.moveRightWithin(t),r},e.writeLatex=function(e){var t=this;s(t),t.show().deleteSelection();var n=p.all,r=p.eof,i=dt.skip(r).or(n.result(!1)).parse(e);return i&&(i.children().adopt(t.parent,t[d],t[v]),S.jQize(i.join("html")).insertBefore(t.jQ),t[d]=i.ends[v],i.finalizeInsert(),t.parent.bubble("redraw")),this.hide()},e.write=function(e){var t=this.prepareWrite();return this.insertCh(e,t)},e.insertCh=function(e,t){return this.parent.write(this,e,t),this},e.insertCmd=function(e,t){var n=_[e];return n?(n=n(e),t&&n.replaces(t),n.createLeftOf(this)):(n=Z(),n.replaces(e),n.ends[d].focus=function(){return delete this.focus,this},n.createLeftOf(this),this.insRightOf(n),t&&t.remove()),this},e.unwrapGramp=function(){var e=this.parent.parent,t=e.parent,n=e[v],r=this,i=e[d];e.disown().eachChild(function(r){if(r.isEmpty())return;r.children().adopt(t,i,n).each(function(t){t.jQ.insertBefore(e.jQ.first())}),i=r.ends[v]});if(!this[v])if(this[d])this[v]=this[d][v];else while(!this[v]){this.parent=this.parent[v];if(!this.parent){this[v]=e[v],this.parent=t;break}this[v]=this.parent.ends[d]}this[v]?this.insLeftOf(this[v]):this.insAtRightEnd(t),e.jQ.remove(),e[d]&&e[d].respace(),e[v]&&e[v].respace()},e.deleteDir=function(e){m(e),s(this),this.show();if(!this.deleteSelection())if(this[e])this[e].isEmpty()?this[e]=this[e].remove()[e]:this.selectDir(e);else if(this.parent!==this.root){if(this.parent.parent.isEmpty())return this.insDirOf(-e,this.parent.parent).deleteDir(e);this.unwrapGramp()}return this[d]&&this[d].respace(),this[v]&&this[v].respace(),this.parent.bubble("redraw"),this},e.backspace=function(){return this.deleteDir(d)},e.deleteForward=function(){return this.deleteDir(v)},e.selectFrom=function(e){var t=this,n=e;e:for(;;){for(var r=this;r!==t.parent.parent;r=r.parent.parent)if(r.parent===n.parent){s=r,o=n;break e}for(var i=e;i!==n.parent.parent;i=i.parent.parent)if(t.parent===i.parent){s=t,o=i;break e}t.parent.parent&&(t=t.parent.parent),n.parent.parent&&(n=n.parent.parent)}var s,o,u;if(s[v]!==o){for(var a=s;a;a=a[v])if(a===o[d]){u=!0;break}u||(u=o,o=s,s=u)}this.hide().selection=mt(s[d][v]||s.parent.ends[d],o[v][d]||o.parent.ends[v]),this.insRightOf(o[v][d]||o.parent.ends[v]),this.root.selectionChanged()},e.selectDir=function(e){m(e),s(this);if(this.selection)if(this.selection.ends[e]===this[-e])this[e]?this.hopDir(e).selection.extendDir(e):this.parent!==this.root&&this.insDirOf(e,this.parent.parent).selection.levelUp();else{this.hopDir(e);if(this.selection.ends[e]===this.selection.ends[-e]){this.clearSelection().show();return}this.selection.retractDir(e)}else{if(this[e])this.hopDir(e);else{if(this.parent===this.root)return;this.insDirOf(e,this.parent.parent)}this.hide().selection=mt(this[-e])}this.root.selectionChanged()},e.selectLeft=function(){return this.selectDir(d)},e.selectRight=function(){return this.selectDir(v)},e.prepareMove=function(){return s(this),this.show().clearSelection()},e.prepareEdit=function(){return s(this),this.show().deleteSelection()},e.prepareWrite=function(){return s(this),this.show().replaceSelection()},e.clearSelection=function(){return this.selection&&(this.selection.clear(),delete this.selection,this.root.selectionChanged()),this},e.deleteSelection=function(){return this.selection?(this[d]=this.selection.ends[d][d],this[v]=this.selection.ends[v][v],this.selection.remove(),this.root.selectionChanged(),delete this.selection):!1},e.replaceSelection=function(){var e=this.selection;return e&&(this[d]=e.ends[d][d],this[v]=e.ends[v][v],delete this.selection),e}}),mt=c(C,function(e,t){e.init=function(){var e=this;t.init.apply(e,arguments),e.jQwrap(e.jQ)},e.jQwrap=function(e){this.jQ=e.wrapAll('<span class="selection"></span>').parent()},e.adopt=function(){return this.jQ.replaceWith(this.jQ=this.jQ.children()),t.adopt.apply(this,arguments)},e.clear=function(){return this.jQ.replaceWith(this.jQ.children()),this},e.levelUp=function(){var e=this,t=e.ends[d]=e.ends[v]=e.ends[v].parent.parent;return e.clear().jQwrap(t.jQ),e},e.extendDir=function(e){return m(e),this.ends[e]=this.ends[e][e],this.ends[e].jQ.insAtDirEnd(e,this.jQ),this},e.extendLeft=function(){return this.extendDir(d)},e.extendRight=function(){return this.extendDir(v)},e.retractDir=function(e){m(e),this.ends[-e].jQ.insDirOf(-e,this.jQ),this.ends[-e]=this.ends[-e][e]},e.retractRight=function(){return this.retractDir(v)},e.retractLeft=function(){return this.retractDir(d)}});e.fn.mathquill=function(e,t){switch(e){case"redraw":return this.each(function(){var e=g(this).attr(i),t=e&&S[e];t&&function n(e){e.eachChild(n),e.redraw&&e.redraw()}(t)});case"revert":return this.each(function(){var e=g(this).attr(i),t=e&&S[e];t&&t.revert&&t.revert()});case"latex":if(arguments.length>1)return this.each(function(){var e=g(this).attr(i),n=e&&S[e];n&&n.renderLatex(t)});var n=g(this).attr(i),r=n&&S[n];return r&&r.latex();case"text":var n=g(this).attr(i),r=n&&S[n];return r&&r.text();case"html":return this.html().replace(/ ?hasCursor|hasCursor /,"").replace(/ class=(""|(?= |>))/g,"").replace(/<span class="?cursor( blink)?"?><\/span>/i,"").replace(/<span class="?textarea"?><textarea><\/textarea><\/span>/i,"");case"write":if(arguments.length>1)return this.each(function(){var e=g(this).attr(i),n=e&&S[e],r=n&&n.cursor;r&&r.writeLatex(t).parent.blur()});case"cmd":if(arguments.length>1)return this.each(function(){var e=g(this).attr(i),n=e&&S[e],r=n&&n.cursor;if(r){var s=r.prepareWrite();/^\\[a-z]+$/i.test(t)?r.insertCmd(t.slice(1),s):r.insertCh(t,s),r.hide().parent.blur()}});default:var s=e==="textbox",o=s||e==="editable",u=s?O:L;return this.each(function(){k(g(this),u(),s,o)})}},e(function(){e(".mathquill-editable:not(.mathquill-rendered-math)").mathquill("editable"),e(".mathquill-textbox:not(.mathquill-rendered-math)").mathquill("textbox"),e(".mathquill-embedded-latex").mathquill()})})();