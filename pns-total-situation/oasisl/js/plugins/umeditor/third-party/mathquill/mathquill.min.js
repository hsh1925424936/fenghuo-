(function(){function e(){}function t(e){var t=u.call(arguments,1);return function(){return e.apply(this,t)}}function n(e,t){if(!t)throw Error("prayer failed: "+e)}function r(e){n("a direction was passed",e===c||e===h)}function i(t,n,r,i){function s(){m=o;var e=a.selection?"$"+a.selection.latex()+"$":"";b.select(e)}function u(){l.detach()}var a,l,v,m,g,y,b,w=t.contents().detach();return r||t.addClass("mathquill-rendered-math"),n.jQ=t.attr(at,n.id),n.revert=function(){t.empty().unbind(".mathquill").removeClass("mathquill-rendered-math mathquill-editable mathquill-textbox").append(w)},a=n.cursor=it(n),n.renderLatex(w.text()),l=n.textarea=p('<span class="textarea"><textarea></textarea></span>'),v=l.children(),n.selectionChanged=function(){m===o&&(m=setTimeout(s)),O(t[0])},t.bind("selectstart.mathquill",function(e){e.target!==v[0]&&e.preventDefault(),e.stopPropagation()}),y=a.blink,t.bind("mousedown.mathquill",function(n){function r(e){return a.seek(p(e.target),e.pageX,e.pageY),(a[c]!==g[c]||a.parent!==g.parent)&&a.selectFrom(g),!1}function s(e){return delete e.target,r(e)}function u(e){g=o,a.blink=y,a.selection||(i?a.show():l.detach()),t.unbind("mousemove",r),p(e.target.ownerDocument).unbind("mousemove",s).unbind("mouseup",u)}return setTimeout(function(){v.focus()}),a.blink=e,a.seek(p(n.target),n.pageX,n.pageY),g=d(a.parent,a[c],a[h]),i||t.prepend(l),t.mousemove(r),p(n.target.ownerDocument).mousemove(s).mouseup(u),!1}),i?(b=f(v,{container:t,key:function(e,t){a.parent.bubble("onKey",e,t)},text:function(e){a.parent.bubble("onText",e)},cut:function(e){a.selection&&setTimeout(function(){a.prepareEdit(),a.parent.bubble("redraw")}),e.stopPropagation()},paste:function(e){e="$"===e.slice(0,1)&&"$"===e.slice(-1)?e.slice(1,-1):"\\text{"+e+"}",a.writeLatex(e).show()}}),t.prepend(l),t.addClass("mathquill-editable"),r&&t.addClass("mathquill-textbox"),v.focus(function(e){a.parent||a.insAtRightEnd(n),a.parent.jQ.addClass("hasCursor"),a.selection?(a.selection.jQ.removeClass("blur"),setTimeout(n.selectionChanged)):a.show(),e.stopPropagation()}).blur(function(e){a.hide().parent.blur(),a.selection&&a.selection.jQ.addClass("blur"),e.stopPropagation()}),t.bind("focus.mathquill blur.mathquill",function(e){v.trigger(e)}).blur(),o):(b=f(v,{container:t}),t.bind("cut paste",!1).bind("copy",s).prepend('<span class="selectable">$'+n.latex()+"$</span>"),v.blur(function(){a.clearSelection(),setTimeout(u)}),o)}function s(e,t,n){return a(V,{ctrlSeq:e,htmlTemplate:"<"+t+" "+n+">&0</"+t+">"})}var o,u,a,f,l,c,h,p,d,v,m,g,y,b,w,E,S,x,T,N,C,k,L,A,O,M,_,D,P,H,B,j,F,I,q,R,U,z,W,X,V,$,J,K,Q,G,Y,Z,et,tt,nt,rt,it,st,ot=window.jQuery,ut="mathquill-command-id",at="mathquill-block-id",ft=Math.min;Math.max,u=[].slice,a=function(e,t,n){function r(e){return"object"==typeof e}function i(e){return"function"==typeof e}function s(){}function o(u,a){function f(){var e=new l;return i(e.init)&&e.init.apply(e,arguments),e}function l(){}var c,h,p;return a===n&&(a=u,u=Object),f.Bare=l,c=s[e]=u[e],h=l[e]=f[e]=new s,h.constructor=f,f.mixin=function(t){return l[e]=f[e]=o(f,t)[e],f},(f.open=function(e){if(p={},i(e)?p=e.call(f,h,c,f,u):r(e)&&(p=e),r(p))for(var n in p)t.call(p,n)&&(h[n]=p[n]);return i(h.init)||(h.init=u),f})(a)}return o}("prototype",{}.hasOwnProperty),f=function(){function t(e){var t,r=e.which||e.keyCode,i=n[r],s=[];return e.ctrlKey&&s.push("Ctrl"),e.originalEvent&&e.originalEvent.metaKey&&s.push("Meta"),e.altKey&&s.push("Alt"),e.shiftKey&&s.push("Shift"),t=i||String.fromCharCode(r),s.length||i?(s.push(t),s.join("-")):t}var n={8:"Backspace",9:"Tab",10:"Enter",13:"Enter",16:"Shift",17:"Control",18:"Alt",20:"CapsLock",27:"Esc",32:"Spacebar",33:"PageUp",34:"PageDown",35:"End",36:"Home",37:"Left",38:"Up",39:"Right",40:"Down",45:"Insert",46:"Del",144:"NumLock"};return function(n,r){function i(e){S=e,clearTimeout(E),E=setTimeout(e)}function s(t){S(),S=e,clearTimeout(E),b.val(t),t&&b[0].select()}function o(){var e=b[0];return"selectionStart"in e?e.selectionStart!==e.selectionEnd:!1}function u(e){var t=b.val();b.val(""),t&&e(t)}function a(){m(t(x),x)}function f(e){x=e,T=null,a()}function l(e){x&&T&&a(),T=e,i(c)}function c(){o()||u(v)}function h(){x=T=null}function p(){b.focus(),i(d)}function d(){u(g)}var v,m,g,y,b,w,E,S,x=null,T=null;return r||(r={}),v=r.text||e,m=r.key||e,g=r.paste||e,y=r.cut||e,b=ot(n),w=ot(r.container||b),S=e,w.bind("keydown keypress input keyup focusout paste",function(){S()}),w.bind({keydown:f,keypress:l,focusout:h,cut:y,paste:p}),{select:s}}}(),l=a(function(e,t,r){function i(e,t){throw e=e?"'"+e+"'":"EOF","Parse Error: "+t+" at "+e}var s,o,u;e.init=function(e){this._=e},e.parse=function(e){function t(e,t){return t}return this.skip(u)._(e,t,i)},e.or=function(e){n("or is passed a parser",e instanceof r);var t=this;return r(function(n,r,i){function s(){return e._(n,r,i)}return t._(n,r,s)})},e.then=function(e){var t=this;return r(function(i,s,o){function u(t,i){var u=e instanceof r?e:e(i);return n("a parser is returned",u instanceof r),u._(t,s,o)}return t._(i,u,o)})},e.many=function(){var e=this;return r(function(t,n){function r(e,n){return t=e,s.push(n),!0}function i(){return!1}for(var s=[];e._(t,r,i););return n(t,s)})},e.times=function(e,t){2>arguments.length&&(t=e);var n=this;return r(function(r,i,s){function o(e,t){return c.push(t),r=e,!0}function u(e,t){return f=t,r=e,!1}function a(){return!1}var f,l,c=[],h=!0;for(l=0;e>l;l+=1)if(h=n._(r,o,u),!h)return s(r,f);for(;t>l&&h;l+=1)h=n._(r,o,a);return i(r,c)})},e.result=function(e){return this.then(o(e))},e.atMost=function(e){return this.times(0,e)},e.atLeast=function(e){var t=this;return t.times(e).then(function(e){return t.many().map(function(t){return e.concat(t)})})},e.map=function(e){return this.then(function(t){return o(e(t))})},e.skip=function(e){return this.then(function(t){return e.result(t)})},this.string=function(e){var t=e.length,n="expected '"+e+"'";return r(function(r,i,s){var o=r.slice(0,t);return o===e?i(r.slice(t),o):s(r,n)})},s=this.regex=function(e){n("regexp parser is anchored","^"===(""+e).charAt(1));var t="expected "+e;return r(function(n,r,i){var s,o=e.exec(n);return o?(s=o[0],r(n.slice(s.length),s)):i(n,t)})},o=r.succeed=function(e){return r(function(t,n){return n(t,e)})},r.fail=function(e){return r(function(t,n,r){return r(t,e)})},r.letter=s(/^[a-z]/i),r.letters=s(/^[a-z]*/i),r.digit=s(/^[0-9]/),r.digits=s(/^[0-9]*/),r.whitespace=s(/^\s+/),r.optWhitespace=s(/^\s*/),r.any=r(function(e,t,n){return e?t(e.slice(1),e.charAt(0)):n(e,"expected any character")}),r.all=r(function(e,t){return t("",e)}),u=r.eof=r(function(e,t,n){return e?n(e,"expected EOF"):t(e,e)})}),c=-1,h=1,p=a(ot,function(e){e.insDirOf=function(e,t){return e===c?this.insertBefore(t.first()):this.insertAfter(t.last())},e.insAtDirEnd=function(e,t){return e===c?this.prependTo(t):this.appendTo(t)}}),d=a(function(e){e.parent=0,e[c]=0,e[h]=0,e.init=function(e,t,n){this.parent=e,this[c]=t,this[h]=n}}),v=a(function(e){e[c]=0,e[h]=0,e.parent=0,e.init=function(){this.ends={},this.ends[c]=0,this.ends[h]=0},e.children=function(){return m(this.ends[c],this.ends[h])},e.eachChild=function(e){return this.children().each(e)},e.foldChildren=function(e,t){return this.children().fold(e,t)},e.adopt=function(e,t,n){return m(this,this).adopt(e,t,n),this},e.disown=function(){return m(this,this).disown(),this}}),m=a(function(e){function t(e,t,r){n("a parent is always present",e),n("leftward is properly set up",function(){return t?t[h]===r&&t.parent===e:e.ends[c]===r}()),n("rightward is properly set up",function(){return r?r[c]===t&&r.parent===e:e.ends[h]===t}())}e.init=function(e,t){n("no half-empty fragments",!e==!t),this.ends={},e&&(n("left end node is passed to Fragment",e instanceof v),n("right end node is passed to Fragment",t instanceof v),n("leftEnd and rightEnd have the same parent",e.parent===t.parent),this.ends[c]=e,this.ends[h]=t)},e.adopt=function(e,n,r){var i,s,o;return t(e,n,r),i=this,i.disowned=!1,(s=i.ends[c])?(o=i.ends[h],n||(e.ends[c]=s),r?r[c]=o:e.ends[h]=o,i.ends[h][h]=r,i.each(function(t){t[c]=n,t.parent=e,n&&(n[h]=t),n=t}),i):this},e.disown=function(){var e,n,r=this,i=r.ends[c];return!i||r.disowned?r:(r.disowned=!0,e=r.ends[h],n=i.parent,t(n,i[c],i),t(n,e,e[h]),i[c]?i[c][h]=e[h]:n.ends[c]=e[h],e[h]?e[h][c]=i[c]:n.ends[h]=i[c],r)},e.each=function(e){var t=this,n=t.ends[c];if(!n)return t;for(;n!==t.ends[h][h]&&e.call(t,n)!==!1;n=n[h]);return t},e.fold=function(e,t){return this.each(function(n){e=t.call(this,e,n)}),e}}),g=function(){var e=0;return function(){return e+=1}}(),y=a(v,function(e,t){e.init=function(){t.init.call(this),this.id=g(),y[this.id]=this},e.toString=function(){return"[MathElement "+this.id+"]"},e.bubble=function(e){var t,n,r=u.call(arguments,1);for(t=this;t&&(n=t[e]&&t[e].apply(t,r),n!==!1);t=t.parent);return this},e.postOrder=function(e){var t,n=u.call(arguments,1);"string"==typeof e&&(t=e,e=function(e){t in e&&e[t].apply(e,n)}),function r(t){t.eachChild(r),e(t)}(this)},e.jQ=p(),e.jQadd=function(e){this.jQ=this.jQ.add(e)},this.jQize=function(e){var t=p(e);return t.find("*").andSelf().each(function(){var e=p(this),t=e.attr("mathquill-command-id"),n=e.attr("mathquill-block-id");t&&y[t].jQadd(e),n&&y[n].jQadd(e)}),t},e.finalizeInsert=function(){var e=this;e.postOrder("finalizeTree"),e.postOrder("blur"),e.postOrder("respace"),e[h].respace&&e[h].respace(),e[c].respace&&e[c].respace(),e.postOrder("redraw"),e.bubble("redraw")}}),b=a(y,function(t,r){t.init=function(e,t,n){var i=this;r.init.call(i),i.ctrlSeq||(i.ctrlSeq=e),t&&(i.htmlTemplate=t),n&&(i.textTemplate=n)},t.replaces=function(e){e.disown(),this.replacedFragment=e},t.isEmpty=function(){return this.foldChildren(!0,function(e,t){return e&&t.isEmpty()})},t.parser=function(){var e=rt.block,t=this;return e.times(t.numBlocks()).map(function(e){t.blocks=e;for(var n=0;e.length>n;n+=1)e[n].adopt(t,t.ends[h],0);return t})},t.createLeftOf=function(e){var t=this,n=t.replacedFragment;t.createBlocks(),y.jQize(t.html()),n&&(n.adopt(t.ends[c],0,0),n.jQ.appendTo(t.ends[c].jQ)),e.jQ.before(t.jQ),e[c]=t.adopt(e.parent,e[c],e[h]),t.finalizeInsert(e),t.placeCursor(e)},t.createBlocks=function(){var e,t,n=this,r=n.numBlocks(),i=n.blocks=Array(r);for(e=0;r>e;e+=1)t=i[e]=E(),t.adopt(n,n.ends[h],0)},t.respace=e,t.placeCursor=function(e){e.insAtRightEnd(this.foldChildren(this.ends[c],function(e,t){return e.isEmpty()?e:t}))},t.remove=function(){return this.disown(),this.jQ.remove(),this.postOrder(function(e){delete y[e.id]}),this},t.numBlocks=function(){var e=this.htmlTemplate.match(/&\d+/g);return e?e.length:0},t.html=function(){var e,t,r,i=this,s=i.blocks,o=" mathquill-command-id="+i.id,u=i.htmlTemplate.match(/<[^<>]+>|[^<>]+/g);for(n("no unmatched angle brackets",u.join("")===this.htmlTemplate),e=0,t=u[0];t;e+=1,t=u[e])if("/>"===t.slice(-2))u[e]=t.slice(0,-2)+o+"/>";else if("<"===t.charAt(0)){n("not an unmatched top-level close tag","/"!==t.charAt(1)),u[e]=t.slice(0,-1)+o+">",r=1;do e+=1,t=u[e],n("no missing close tags",t),"</"===t.slice(0,2)?r-=1:"<"===t.charAt(0)&&"/>"!==t.slice(-2)&&(r+=1);while(r>0)}return u.join("").replace(/>&(\d+)/g,function(e,t){return" mathquill-block-id="+s[t].id+">"+s[t].join("html")})},t.latex=function(){return this.foldChildren(this.ctrlSeq,function(e,t){return e+"{"+(t.latex()||" ")+"}"})},t.textTemplate=[""],t.text=function(){var e=this,t=0;return e.foldChildren(e.textTemplate[t],function(n,r){t+=1;var i=r.text();return n&&"("===e.textTemplate[t]&&"("===i[0]&&")"===i.slice(-1)?n+i.slice(1,-1)+e.textTemplate[t]:n+r.text()+(e.textTemplate[t]||"")})}}),w=a(b,function(t,n){t.init=function(e,t,r){r||(r=e&&e.length>1?e.slice(1):e),n.init.call(this,e,t,[r])},t.parser=function(){return l.succeed(this)},t.numBlocks=function(){return 0},t.replaces=function(e){e.remove()},t.createBlocks=e,t.latex=function(){return this.ctrlSeq},t.text=function(){return this.textTemplate},t.placeCursor=e,t.isEmpty=function(){return!0}}),E=a(y,function(e){e.join=function(e){return this.foldChildren("",function(t,n){return t+n[e]()})},e.latex=function(){return this.join("latex")},e.text=function(){return this.ends[c]===this.ends[h]?this.ends[c].text():"("+this.join("text")+")"},e.isEmpty=function(){return 0===this.ends[c]&&0===this.ends[h]},e.write=function(e,t,n){var r;r=t.match(/^[a-eg-zA-Z]$/)?K(t):(r=C[t]||k[t])?r(t):Q(t),n&&r.replaces(n),r.createLeftOf(e)},e.focus=function(){return this.jQ.addClass("hasCursor"),this.jQ.removeClass("empty"),this},e.blur=function(){return this.jQ.removeClass("hasCursor"),this.isEmpty()&&this.jQ.addClass("empty"),this}}),S=a(m,function(e,t){e.init=function(e,n){t.init.call(this,e,n||e),this.jQ=this.fold(p(),function(e,t){return t.jQ.add(e)})},e.latex=function(){return this.fold("",function(e,t){return e+t.latex()})},e.remove=function(){return this.jQ.remove(),this.each(function(e){e.postOrder(function(e){delete y[e.id]})}),this.disown()}}),x=a(E,function(e,t){e.latex=function(){return t.latex.call(this).replace(/(\\[a-z]+) (?![a-z])/gi,"$1")},e.text=function(){return this.foldChildren("",function(e,t){return e+t.text()})},e.renderLatex=function(e){var t=this.jQ;t.children().slice(1).remove(),this.ends[c]=this.ends[h]=0,delete this.cursor.selection,this.cursor.insAtRightEnd(this).writeLatex(e)},e.onKey=function(e,t){var n;switch(e){case"Ctrl-Shift-Backspace":case"Ctrl-Backspace":for(;this.cursor[c]||this.cursor.selection;)this.cursor.backspace();break;case"Shift-Backspace":case"Backspace":this.cursor.backspace();break;case"Esc":case"Tab":case"Spacebar":if(n=this.cursor.parent,n===this.cursor.root)return"Spacebar"===e&&t.preventDefault(),o;this.cursor.prepareMove(),n[h]?this.cursor.insAtLeftEnd(n[h]):this.cursor.insRightOf(n.parent);break;case"Shift-Tab":case"Shift-Esc":case"Shift-Spacebar":if(n=this.cursor.parent,n===this.cursor.root)return"Shift-Spacebar"===e&&t.preventDefault(),o;this.cursor.prepareMove(),n[c]?this.cursor.insAtRightEnd(n[c]):this.cursor.insLeftOf(n.parent);break;case"Enter":break;case"End":this.cursor.prepareMove().insAtRightEnd(this.cursor.parent);break;case"Ctrl-End":this.cursor.prepareMove().insAtRightEnd(this);break;case"Shift-End":for(;this.cursor[h];)this.cursor.selectRight();break;case"Ctrl-Shift-End":for(;this.cursor[h]||this.cursor.parent!==this;)this.cursor.selectRight();break;case"Home":this.cursor.prepareMove().insAtLeftEnd(this.cursor.parent);break;case"Ctrl-Home":this.cursor.prepareMove().insAtLeftEnd(this);break;case"Shift-Home":for(;this.cursor[c];)this.cursor.selectLeft();break;case"Ctrl-Shift-Home":for(;this.cursor[c]||this.cursor.parent!==this;)this.cursor.selectLeft();break;case"Left":this.cursor.moveLeft();break;case"Shift-Left":this.cursor.selectLeft();break;case"Ctrl-Left":break;case"Right":this.cursor.moveRight();break;case"Shift-Right":this.cursor.selectRight();break;case"Ctrl-Right":break;case"Up":this.cursor.moveUp();break;case"Down":this.cursor.moveDown();break;case"Shift-Up":if(this.cursor[c])for(;this.cursor[c];)this.cursor.selectLeft();else this.cursor.selectLeft();case"Shift-Down":if(this.cursor[h])for(;this.cursor[h];)this.cursor.selectRight();else this.cursor.selectRight();case"Ctrl-Up":break;case"Ctrl-Down":break;case"Ctrl-Shift-Del":case"Ctrl-Del":for(;this.cursor[h]||this.cursor.selection;)this.cursor.deleteForward();break;case"Shift-Del":case"Del":this.cursor.deleteForward();break;case"Meta-A":case"Ctrl-A":if(this!==this.cursor.root)return;for(this.cursor.prepareMove().insAtRightEnd(this);this.cursor[c];)this.cursor.selectLeft();break;default:return!1}return t.preventDefault(),!1},e.onText=function(e){return this.cursor.write(e),!1}}),T=a(b,function(e,t){e.init=function(e){t.init.call(this,"$"),this.cursor=e},e.htmlTemplate='<span class="mathquill-rendered-math">&0</span>',e.createBlocks=function(){this.ends[c]=this.ends[h]=x(),this.blocks=[this.ends[c]],this.ends[c].parent=this,this.ends[c].cursor=this.cursor,this.ends[c].write=function(e,t,n){"$"!==t?E.prototype.write.call(this,e,t,n):this.isEmpty()?(e.insRightOf(this.parent).backspace().show(),Q("\\$","$").createLeftOf(e)):e[h]?e[c]?E.prototype.write.call(this,e,t,n):e.insLeftOf(this.parent):e.insRightOf(this.parent)}},e.latex=function(){return"$"+this.ends[c].latex()+"$"}}),N=a(E,function(e){e.renderLatex=function(e){var t,n,r,i,s,o,u,a,f,p,d,v=this,m=v.cursor;if(v.jQ.children().slice(1).remove(),v.ends[c]=v.ends[h]=0,delete m.selection,m.show().insAtRightEnd(v),t=l.regex,n=l.string,r=l.eof,i=l.all,s=n("$").then(rt).skip(n("$").or(r)).map(function(e){var t,n=T(m);return n.createBlocks(),t=n.ends[c],e.children().adopt(t,0,0),n}),o=n("\\$").result("$"),u=o.or(t(/^[^$]/)).map(Q),a=s.or(u).many(),f=a.skip(r).or(i.result(!1)).parse(e)){for(p=0;f.length>p;p+=1)f[p].adopt(v,v.ends[h],0);d=v.join("html"),y.jQize(d).appendTo(v.jQ),this.finalizeInsert()}},e.onKey=function(e){"Spacebar"!==e&&"Shift-Spacebar"!==e&&x.prototype.onKey.apply(this,arguments)},e.onText=x.prototype.onText,e.write=function(e,t,n){if(n&&n.remove(),"$"===t)T(e).createLeftOf(e);else{var r;"<"===t?r="&lt;":">"===t&&(r="&gt;"),Q(t,r).createLeftOf(e)}}}),C={},k={},O=e,M=document.createElement("div"),_=M.style,D={transform:1,WebkitTransform:1,MozTransform:1,OTransform:1,msTransform:1};for(P in D)if(P in _){A=P;break}A?L=function(e,t,n){e.css(A,"scale("+t+","+n+")")}:"filter"in _?(O=function(e){e.className=e.className},L=function(e,t,n){function r(){e.css("marginRight",(i.width()-1)*(t-1)/t+"px")}var i,s;t/=1+(n-1)/2,e.css("fontSize",n+"em"),e.hasClass("matrixed-container")||e.addClass("matrixed-container").wrapInner('<span class="matrixed"></span>'),i=e.children().css("filter","progid:DXImageTransform.Microsoft.Matrix(M11="+t+",SizingMethod='auto expand')"),r(),s=setInterval(r),p(window).load(function(){clearTimeout(s),r()})}):L=function(e,t,n){e.css("fontSize",n+"em")},H=a(b,function(e,t){e.init=function(e,n,r){t.init.call(this,e,"<"+n+" "+r+">&0</"+n+">")}}),k.mathrm=t(H,"\\mathrm","span",'class="roman font"'),k.mathit=t(H,"\\mathit","i",'class="font"'),k.mathbf=t(H,"\\mathbf","b",'class="font"'),k.mathsf=t(H,"\\mathsf","span",'class="sans-serif font"'),k.mathtt=t(H,"\\mathtt","span",'class="monospace font"'),k.underline=t(H,"\\underline","span",'class="non-leaf underline"'),k.overline=k.bar=t(H,"\\overline","span",'class="non-leaf overline"'),B=a(b,function(e,t){e.init=function(e,n,r){t.init.call(this,e,"<"+n+' class="non-leaf">&0</'+n+">",[r])},e.finalizeTree=function(){function e(e){var t=this.parent,n=e;do{if(n[h])return e.insLeftOf(t),!1;n=n.parent.parent}while(n!==t);return e.insRightOf(t),!1}n("SupSub is only _ and ^","^"===this.ctrlSeq||"_"===this.ctrlSeq),"_"===this.ctrlSeq?(this.down=this.ends[c],this.ends[c].up=e):(this.up=this.ends[c],this.ends[c].down=e)},e.latex=function(){var e=this.ends[c].latex();return 1===e.length?this.ctrlSeq+e:this.ctrlSeq+"{"+(e||" ")+"}"},e.redraw=function(){this[c]&&this[c].respace(),this[c]instanceof B||(this.respace(),!this[h]||this[h]instanceof B||this[h].respace())},e.respace=function(){if("\\int "===this[c].ctrlSeq||this[c]instanceof B&&this[c].ctrlSeq!=this.ctrlSeq&&this[c][c]&&"\\int "===this[c][c].ctrlSeq?this.limit||(this.limit=!0,this.jQ.addClass("limit")):this.limit&&(this.limit=!1,this.jQ.removeClass("limit")),this.respaced=this[c]instanceof B&&this[c].ctrlSeq!=this.ctrlSeq&&!this[c].respaced,this.respaced){var e=+this.jQ.css("fontSize").slice(0,-2),t=this[c].jQ.outerWidth(),n=this.jQ.outerWidth();this.jQ.css({left:(this.limit&&"_"===this.ctrlSeq?-0.25:0)-t/e+"em",marginRight:.1-ft(n,t)/e+"em"})}else this.limit&&"_"===this.ctrlSeq?this.jQ.css({left:"-.25em",marginRight:""}):this.jQ.css({left:"",marginRight:""});return this[h]instanceof B&&this[h].respace(),this}}),k.subscript=k._=t(B,"_","sub","_"),k.superscript=k.supscript=k["^"]=t(B,"^","sup","**"),j=k.frac=k.dfrac=k.cfrac=k.fraction=a(b,function(e){e.ctrlSeq="\\frac",e.htmlTemplate='<span class="fraction non-leaf"><span class="numerator">&0</span><span class="denominator">&1</span><span style="display:inline-block;width:0">&nbsp;</span></span>',e.textTemplate=["(","/",")"],e.finalizeTree=function(){this.up=this.ends[h].up=this.ends[c],this.down=this.ends[c].down=this.ends[h]}}),F=k.over=C["/"]=a(j,function(e,t){e.createLeftOf=function(e){if(!this.replacedFragment){for(var n=e[c];n&&!(n instanceof Z||n instanceof V||n instanceof tt||",;:".split("").indexOf(n.ctrlSeq)>-1);)n=n[c];n instanceof tt&&n[h]instanceof B&&(n=n[h],n[h]instanceof B&&n[h].ctrlSeq!=n.ctrlSeq&&(n=n[h])),n!==e[c]&&(this.replaces(S(n[h]||e.parent.ends[c],e[c])),e[c]=n)}t.createLeftOf.call(this,e)}}),I=k.sqrt=k["√"]=a(b,function(e,t){e.ctrlSeq="\\sqrt",e.htmlTemplate='<span class="non-leaf"><span class="scaled sqrt-prefix">&radic;</span><span class="non-leaf sqrt-stem">&0</span></span>',e.textTemplate=["sqrt(",")"],e.parser=function(){return rt.optBlock.then(function(e){return rt.block.map(function(t){var n=q();return n.blocks=[e,t],e.adopt(n,0,0),t.adopt(n,e,0),n})}).or(t.parser.call(this))},e.redraw=function(){var e=this.ends[h].jQ;L(e.prev(),1,e.innerHeight()/+e.css("fontSize").slice(0,-2)-.1)}}),k.vec=a(b,function(e){e.ctrlSeq="\\vec",e.htmlTemplate='<span class="non-leaf"><span class="vector-prefix">&rarr;</span><span class="vector-stem">&0</span></span>',e.textTemplate=["vec(",")"]}),q=k.nthroot=a(I,function(e){e.htmlTemplate='<sup class="nthroot non-leaf">&0</sup><span class="scaled"><span class="sqrt-prefix scaled">&radic;</span><span class="sqrt-stem non-leaf">&1</span></span>',e.textTemplate=["sqrt[","](",")"],e.latex=function(){return"\\sqrt["+this.ends[c].latex()+"]{"+this.ends[h].latex()+"}"}}),R=a(b,function(e,t){e.init=function(e,n,r,i){t.init.call(this,"\\left"+r,'<span class="non-leaf"><span class="scaled paren">'+e+"</span>"+'<span class="non-leaf">&0</span>'+'<span class="scaled paren">'+n+"</span>"+"</span>",[e,n]),this.end="\\right"+i},e.jQadd=function(){t.jQadd.apply(this,arguments);var e=this.jQ;this.bracketjQs=e.children(":first").add(e.children(":last"))},e.latex=function(){return this.ctrlSeq+this.ends[c].latex()+this.end},e.redraw=function(){var e=this.ends[c].jQ,t=e.outerHeight()/+e.css("fontSize").slice(0,-2);L(this.bracketjQs,ft(1+.2*(t-1),1.2),1.05*t)}}),k.left=a(b,function(e){e.parser=function(){var e=l.regex,t=l.string,n=l.succeed,r=l.optWhitespace;return r.then(e(/^(?:[([|]|\\\{)/)).then(function(i){"\\"===i.charAt(0)&&(i=i.slice(1));var s=C[i]();return rt.map(function(e){s.blocks=[e],e.adopt(s,0,0)}).then(t("\\right")).skip(r).then(e(/^(?:[\])|]|\\\})/)).then(function(e){return e.slice(-1)!==s.end.slice(-1)?l.fail("open doesn't match close"):n(s)})})}}),k.right=a(b,function(e){e.parser=function(){return l.fail("unmatched \\right")}}),k.lbrace=C["{"]=t(R,"{","}","\\{","\\}"),k.langle=k.lang=t(R,"&lang;","&rang;","\\langle ","\\rangle "),U=a(R,function(e,t){e.createLeftOf=function(e){e[h]||!e.parent.parent||e.parent.parent.end!==this.end||this.replacedFragment?t.createLeftOf.call(this,e):e.insRightOf(e.parent.parent)},e.placeCursor=function(e){this.ends[c].blur(),e.insRightOf(this)}}),k.rbrace=C["}"]=t(U,"{","}","\\{","\\}"),k.rangle=k.rang=t(U,"&lang;","&rang;","\\langle ","\\rangle "),z=function(e,t){e.init=function(e,n){t.init.call(this,e,n,e,n)}},W=a(R,z),k.lparen=C["("]=t(W,"(",")"),k.lbrack=k.lbracket=C["["]=t(W,"[","]"),X=a(U,z),k.rparen=C[")"]=t(X,"(",")"),k.rbrack=k.rbracket=C["]"]=t(X,"[","]"),k.lpipe=k.rpipe=C["|"]=a(W,function(e,t){e.init=function(){t.init.call(this,"|","|")},e.createLeftOf=U.prototype.createLeftOf}),V=C.$=k.text=k.textnormal=k.textrm=k.textup=k.textmd=a(b,function(e,t){e.ctrlSeq="\\text",e.htmlTemplate='<span class="text">&0</span>',e.replaces=function(e){e instanceof S?this.replacedText=e.remove().jQ.text():"string"==typeof e&&(this.replacedText=e)},e.textTemplate=['"','"'],e.parser=function(){var e=this,t=l.string,n=l.regex,r=l.optWhitespace;return r.then(t("{")).then(n(/^[^}]*/)).skip(t("}")).map(function(t){var n,r,i;for(e.createBlocks(),n=e.ends[c],r=0;t.length>r;r+=1)i=Q(t.charAt(r)),i.adopt(n,n.ends[h],0);return e})},e.createBlocks=function(){this.ends[c]=this.ends[h]=$(),this.blocks=[this.ends[c]],this.ends[c].parent=this},e.finalizeInsert=function(){this.ends[c].blur=function(){return delete this.blur,this},t.finalizeInsert.call(this)},e.createLeftOf=function(e){if(t.createLeftOf.call(this,this.cursor=e),this.replacedText)for(var n=0;this.replacedText.length>n;n+=1)this.ends[c].write(e,this.replacedText.charAt(n))}}),$=a(E,function(e,t){e.onKey=function(e){return"Spacebar"===e||"Shift-Spacebar"===e?!1:o},e.deleteOutOf=function(e,t){this.isEmpty()&&t.insRightOf(this.parent)},e.write=function(e,t,n){var r,i;return n&&n.remove(),"$"!==t?("<"===t?r="&lt;":">"===t&&(r="&gt;"),Q(t,r).createLeftOf(e)):this.isEmpty()?(e.insRightOf(this.parent).backspace(),Q("\\$","$").createLeftOf(e)):e[h]?e[c]?(i=V(),i.replaces(S(e[h],this.ends[h])),e.insRightOf(this.parent),i.adopt=function(){delete this.adopt,this.adopt.apply(this,arguments),this[c]=0},i.createLeftOf(e),i[c]=this.parent,e.insLeftOf(i)):e.insLeftOf(this.parent):e.insRightOf(this.parent),!1},e.blur=function(){if(this.jQ.removeClass("hasCursor"),this.isEmpty()){var e=this.parent,t=e.cursor;t.parent===this?this.jQ.addClass("empty"):(t.hide(),e.remove(),t[h]===e?t[h]=e[h]:t[c]===e&&(t[c]=e[c]),t.show().parent.bubble("redraw"))}return this},e.focus=function(){var e,n,r,i;return t.focus.call(this),e=this.parent,e[h].ctrlSeq===e.ctrlSeq?(n=this,r=e.cursor,i=e[h].ends[c],i.eachChild(function(e){e.parent=n,e.jQ.appendTo(n.jQ)}),this.ends[h]?this.ends[h][h]=i.ends[c]:this.ends[c]=i.ends[c],i.ends[c][c]=this.ends[h],this.ends[h]=i.ends[h],i.parent.remove(),r[c]?r.insRightOf(r[c]):r.insAtLeftEnd(this),r.parent.bubble("redraw")):e[c].ctrlSeq===e.ctrlSeq&&(r=e.cursor,r[c]?e[c].ends[c].focus():r.insAtRightEnd(e[c].ends[c])),this}}),k.em=k.italic=k.italics=k.emph=k.textit=k.textsl=s("\\textit","i",'class="text"'),k.strong=k.bold=k.textbf=s("\\textbf","b",'class="text"'),k.sf=k.textsf=s("\\textsf","span",'class="sans-serif text"'),k.tt=k.texttt=s("\\texttt","span",'class="monospace text"'),k.textsc=s("\\textsc","span",'style="font-variant:small-caps" class="text"'),k.uppercase=s("\\uppercase","span",'style="text-transform:uppercase" class="text"'),k.lowercase=s("\\lowercase","span",'style="text-transform:lowercase" class="text"'),C["\\"]=a(b,function(e,t){e.ctrlSeq="\\",e.replaces=function(e){this._replacedFragment=e.disown(),this.isEmpty=function(){return!1}},e.htmlTemplate='<span class="latex-command-input non-leaf">\\<span>&0</span></span>',e.textTemplate=["\\"],e.createBlocks=function(){t.createBlocks.call(this),this.ends[c].focus=function(){return this.parent.jQ.addClass("hasCursor"),this.isEmpty()&&this.parent.jQ.removeClass("empty"),this},this.ends[c].blur=function(){return this.parent.jQ.removeClass("hasCursor"),this.isEmpty()&&this.parent.jQ.addClass("empty"),this}},e.createLeftOf=function(e){if(t.createLeftOf.call(this,e),this.cursor=e.insAtRightEnd(this.ends[c]),this._replacedFragment){var n=this.jQ[0];this.jQ=this._replacedFragment.jQ.addClass("blur").bind("mousedown mousemove",function(e){return p(e.target=n).trigger(e),!1}).insertBefore(this.jQ).add(this.jQ)}this.ends[c].write=function(e,t,n){n&&n.remove(),t.match(/[a-z]/i)?Q(t).createLeftOf(e):(this.parent.renderCommand(),"\\"===t&&this.isEmpty()||this.parent.parent.write(e,t))}},e.latex=function(){return"\\"+this.ends[c].latex()+" "},e.onKey=function(e,t){return"Tab"===e||"Enter"===e||"Spacebar"===e?(this.renderCommand(),t.preventDefault(),!1):o},e.renderCommand=function(){this.jQ=this.jQ.last(),this.remove(),this[h]?this.cursor.insLeftOf(this[h]):this.cursor.insAtRightEnd(this.parent);var e=this.ends[c].latex();e||(e="backslash"),this.cursor.insertCmd(e,this._replacedFragment)}}),J=k.binom=k.binomial=a(b,function(e){e.ctrlSeq="\\binom",e.htmlTemplate='<span class="paren scaled">(</span><span class="non-leaf"><span class="array non-leaf"><span>&0</span><span>&1</span></span></span><span class="paren scaled">)</span>',e.textTemplate=["choose(",",",")"],e.redraw=function(){var e=this.jQ.eq(1),t=e.outerHeight()/+e.css("fontSize").slice(0,-2),n=this.jQ.filter(".paren");L(n,ft(1+.2*(t-1),1.2),1.05*t)}}),k.choose=a(J,function(e){e.createLeftOf=F.prototype.createLeftOf}),k.vector=a(b,function(e,t){e.ctrlSeq="\\vector",e.htmlTemplate='<span class="array"><span>&0</span></span>',e.latex=function(){return"\\begin{matrix}"+this.foldChildren([],function(e,t){return e.push(t.latex()),e}).join("\\\\")+"\\end{matrix}"},e.text=function(){return"["+this.foldChildren([],function(e,t){return e.push(t.text()),e}).join()+"]"},e.createLeftOf=function(e){t.createLeftOf.call(this,this.cursor=e)},e.onKey=function(e,t){var n,r=this.cursor.parent;if(r.parent===this){if("Enter"===e)return n=E(),n.parent=this,n.jQ=p("<span></span>").attr(at,n.id).insertAfter(r.jQ),r[h]?r[h][c]=n:this.ends[h]=n,n[h]=r[h],r[h]=n,n[c]=r,this.bubble("redraw").cursor.insAtRightEnd(n),t.preventDefault(),!1;if("Tab"===e&&!r[h])return r.isEmpty()?r[c]?(this.cursor.insRightOf(this),delete r[c][h],this.ends[h]=r[c],r.jQ.remove(),this.bubble("redraw"),t.preventDefault(),!1):o:(n=E(),n.parent=this,n.jQ=p("<span></span>").attr(at,n.id).appendTo(this.jQ),this.ends[h]=n,r[h]=n,n[c]=r,this.bubble("redraw").cursor.insAtRightEnd(n),t.preventDefault(),!1);if(8===t.which){if(r.isEmpty())return r[c]?(this.cursor.insAtRightEnd(r[c]),r[c][h]=r[h]):(this.cursor.insLeftOf(this),this.ends[c]=r[h]),r[h]?r[h][c]=r[c]:this.ends[h]=r[c],r.jQ.remove(),this.isEmpty()?this.cursor.deleteForward():this.bubble("redraw"),t.preventDefault(),!1;if(!this.cursor[c])return t.preventDefault(),!1}}}}),k.editable=a(T,function(e,t){e.init=function(){b.prototype.init.call(this,"\\editable")},e.jQadd=function(){var e,n,r=this;t.jQadd.apply(r,arguments),e=r.ends[c].disown(),n=r.jQ.children().detach(),r.ends[c]=r.ends[h]=x(),r.blocks=[r.ends[c]],r.ends[c].parent=r,i(r.jQ,r.ends[c],!1,!0),r.cursor=r.ends[c].cursor,e.children().adopt(r.ends[c],0,0),n.appendTo(r.ends[c].jQ),r.ends[c].cursor.insAtRightEnd(r.ends[c])},e.latex=function(){return this.ends[c].latex()},e.text=function(){return this.ends[c].text()}}),k.f=t(w,"f",'<var class="florin">&fnof;</var><span style="display:inline-block;width:0">&nbsp;</span>'),K=a(w,function(e,t){e.init=function(e,n){t.init.call(this,e,"<var>"+(n||e)+"</var>")},e.text=function(){var e=this.ctrlSeq;return!this[c]||this[c]instanceof K||this[c]instanceof Z||(e="*"+e),!this[h]||this[h]instanceof Z||"^"===this[h].ctrlSeq||(e+="*"),e}}),Q=a(w,function(e,t){e.init=function(e,n){t.init.call(this,e,"<span>"+(n||e)+"</span>")}}),C[" "]=t(Q,"\\:"," "),k.prime=C["'"]=t(Q,"'","&prime;"),G=a(w,function(e,t){e.init=function(e,n){t.init.call(this,e,'<span class="nonSymbola">'+(n||e)+"</span>")}}),k["@"]=G,k["&"]=t(G,"\\&","&amp;"),k["%"]=t(G,"\\%","%"),k.alpha=k.beta=k.gamma=k.delta=k.zeta=k.eta=k.theta=k.iota=k.kappa=k.mu=k.nu=k.xi=k.rho=k.sigma=k.tau=k.chi=k.psi=k.omega=a(K,function(e,t){e.init=function(e){t.init.call(this,"\\"+e+" ","&"+e+";")}}),k.phi=t(K,"\\phi ","&#981;"),k.phiv=k.varphi=t(K,"\\varphi ","&phi;"),k.epsilon=t(K,"\\epsilon ","&#1013;"),k.epsiv=k.varepsilon=t(K,"\\varepsilon ","&epsilon;"),k.piv=k.varpi=t(K,"\\varpi ","&piv;"),k.sigmaf=k.sigmav=k.varsigma=t(K,"\\varsigma ","&sigmaf;"),k.thetav=k.vartheta=k.thetasym=t(K,"\\vartheta ","&thetasym;"),k.upsilon=k.upsi=t(K,"\\upsilon ","&upsilon;"),k.gammad=k.Gammad=k.digamma=t(K,"\\digamma ","&#989;"),k.kappav=k.varkappa=t(K,"\\varkappa ","&#1008;"),k.rhov=k.varrho=t(K,"\\varrho ","&#1009;"),k.pi=k["π"]=t(G,"\\pi ","&pi;"),k.lambda=t(G,"\\lambda ","&lambda;"),k.Upsilon=k.Upsi=k.upsih=k.Upsih=t(w,"\\Upsilon ",'<var style="font-family: serif">&upsih;</var>'),k.Gamma=k.Delta=k.Theta=k.Lambda=k.Xi=k.Pi=k.Sigma=k.Phi=k.Psi=k.Omega=k.forall=a(Q,function(e,t){e.init=function(e){t.init.call(this,"\\"+e+" ","&"+e+";")}}),Y=a(b,function(e){e.init=function(e){this.latex=e},e.createLeftOf=function(e){e.writeLatex(this.latex)},e.parser=function(){var e=rt.parse(this.latex).children();return l.succeed(e)}}),k["¹"]=t(Y,"^1"),k["²"]=t(Y,"^2"),k["³"]=t(Y,"^3"),k["¼"]=t(Y,"\\frac14"),k["½"]=t(Y,"\\frac12"),k["¾"]=t(Y,"\\frac34"),Z=a(w,function(e,t){e.init=function(e,n,r){t.init.call(this,e,'<span class="binary-operator">'+n+"</span>",r)}}),et=a(Z,function(e){e.init=Q.prototype.init,e.respace=function(){return this.jQ[0].className=this[c]?this[c]instanceof Z&&this[h]&&!(this[h]instanceof Z)?"unary-operator":"binary-operator":"",this}}),k["+"]=t(et,"+","+"),k["–"]=k["-"]=t(et,"-","&minus;"),k["±"]=k.pm=k.plusmn=k.plusminus=t(et,"\\pm ","&plusmn;"),k.mp=k.mnplus=k.minusplus=t(et,"\\mp ","&#8723;"),C["*"]=k.sdot=k.cdot=t(Z,"\\cdot ","&middot;"),k["="]=t(Z,"=","="),k["<"]=t(Z,"<","&lt;"),k[">"]=t(Z,">","&gt;"),k.notin=k.sim=k.cong=k.equiv=k.oplus=k.otimes=a(Z,function(e,t){e.init=function(e){t.init.call(this,"\\"+e+" ","&"+e+";")}}),k.times=t(Z,"\\times ","&times;","[x]"),k["÷"]=k.div=k.divide=k.divides=t(Z,"\\div ","&divide;","[/]"),k["≠"]=k.ne=k.neq=t(Z,"\\ne ","&ne;"),k.ast=k.star=k.loast=k.lowast=t(Z,"\\ast ","&lowast;"),k.therefor=k.therefore=t(Z,"\\therefore ","&there4;"),k.cuz=k.because=t(Z,"\\because ","&#8757;"),k.prop=k.propto=t(Z,"\\propto ","&prop;"),k["≈"]=k.asymp=k.approx=t(Z,"\\approx ","&asymp;"),k.lt=t(Z,"<","&lt;"),k.gt=t(Z,">","&gt;"),k["≤"]=k.le=k.leq=t(Z,"\\le ","&le;"),k["≥"]=k.ge=k.geq=t(Z,"\\ge ","&ge;"),k.isin=k["in"]=t(Z,"\\in ","&isin;"),k.ni=k.contains=t(Z,"\\ni ","&ni;"),k.notni=k.niton=k.notcontains=k.doesnotcontain=t(Z,"\\not\\ni ","&#8716;"),k.sub=k.subset=t(Z,"\\subset ","&sub;"),k.sup=k.supset=k.superset=t(Z,"\\supset ","&sup;"),k.nsub=k.notsub=k.nsubset=k.notsubset=t(Z,"\\not\\subset ","&#8836;"),k.nsup=k.notsup=k.nsupset=k.notsupset=k.nsuperset=k.notsuperset=t(Z,"\\not\\supset ","&#8837;"),k.sube=k.subeq=k.subsete=k.subseteq=t(Z,"\\subseteq ","&sube;"),k.supe=k.supeq=k.supsete=k.supseteq=k.supersete=k.superseteq=t(Z,"\\supseteq ","&supe;"),k.nsube=k.nsubeq=k.notsube=k.notsubeq=k.nsubsete=k.nsubseteq=k.notsubsete=k.notsubseteq=t(Z,"\\not\\subseteq ","&#8840;"),k.nsupe=k.nsupeq=k.notsupe=k.notsupeq=k.nsupsete=k.nsupseteq=k.notsupsete=k.notsupseteq=k.nsupersete=k.nsuperseteq=k.notsupersete=k.notsuperseteq=t(Z,"\\not\\supseteq ","&#8841;"),tt=a(w,function(e,t){e.init=function(e,n){t.init.call(this,e,"<big>"+n+"</big>")}}),k["∑"]=k.sum=k.summation=t(tt,"\\sum ","&sum;"),k["∏"]=k.prod=k.product=t(tt,"\\prod ","&prod;"),k.coprod=k.coproduct=t(tt,"\\coprod ","&#8720;"),k["∫"]=k["int"]=k.integral=t(tt,"\\int ","&int;"),k.N=k.naturals=k.Naturals=t(Q,"\\mathbb{N}","&#8469;"),k.P=k.primes=k.Primes=k.projective=k.Projective=k.probability=k.Probability=t(Q,"\\mathbb{P}","&#8473;"),k.Z=k.integers=k.Integers=t(Q,"\\mathbb{Z}","&#8484;"),k.Q=k.rationals=k.Rationals=t(Q,"\\mathbb{Q}","&#8474;"),k.R=k.reals=k.Reals=t(Q,"\\mathbb{R}","&#8477;"),k.C=k.complex=k.Complex=k.complexes=k.Complexes=k.complexplane=k.Complexplane=k.ComplexPlane=t(Q,"\\mathbb{C}","&#8450;"),k.H=k.Hamiltonian=k.quaternions=k.Quaternions=t(Q,"\\mathbb{H}","&#8461;"),k.quad=k.emsp=t(Q,"\\quad ","    "),k.qquad=t(Q,"\\qquad ","        "),k.diamond=t(Q,"\\diamond ","&#9671;"),k.bigtriangleup=t(Q,"\\bigtriangleup ","&#9651;"),k.ominus=t(Q,"\\ominus ","&#8854;"),k.uplus=t(Q,"\\uplus ","&#8846;"),k.bigtriangledown=t(Q,"\\bigtriangledown ","&#9661;"),k.sqcap=t(Q,"\\sqcap ","&#8851;"),k.triangleleft=t(Q,"\\triangleleft ","&#8882;"),k.sqcup=t(Q,"\\sqcup ","&#8852;"),k.triangleright=t(Q,"\\triangleright ","&#8883;"),k.odot=t(Q,"\\odot ","&#8857;"),k.bigcirc=t(Q,"\\bigcirc ","&#9711;"),k.dagger=t(Q,"\\dagger ","&#0134;"),k.ddagger=t(Q,"\\ddagger ","&#135;"),k.wr=t(Q,"\\wr ","&#8768;"),k.amalg=t(Q,"\\amalg ","&#8720;"),k.models=t(Q,"\\models ","&#8872;"),k.prec=t(Q,"\\prec ","&#8826;"),k.succ=t(Q,"\\succ ","&#8827;"),k.preceq=t(Q,"\\preceq ","&#8828;"),k.succeq=t(Q,"\\succeq ","&#8829;"),k.simeq=t(Q,"\\simeq ","&#8771;"),k.mid=t(Q,"\\mid ","&#8739;"),k.ll=t(Q,"\\ll ","&#8810;"),k.gg=t(Q,"\\gg ","&#8811;"),k.parallel=t(Q,"\\parallel ","&#8741;"),k.bowtie=t(Q,"\\bowtie ","&#8904;"),k.sqsubset=t(Q,"\\sqsubset ","&#8847;"),k.sqsupset=t(Q,"\\sqsupset ","&#8848;"),k.smile=t(Q,"\\smile ","&#8995;"),k.sqsubseteq=t(Q,"\\sqsubseteq ","&#8849;"),k.sqsupseteq=t(Q,"\\sqsupseteq ","&#8850;"),k.doteq=t(Q,"\\doteq ","&#8784;"),k.frown=t(Q,"\\frown ","&#8994;"),k.vdash=t(Q,"\\vdash ","&#8870;"),k.dashv=t(Q,"\\dashv ","&#8867;"),k.longleftarrow=t(Q,"\\longleftarrow ","&#8592;"),k.longrightarrow=t(Q,"\\longrightarrow ","&#8594;"),k.Longleftarrow=t(Q,"\\Longleftarrow ","&#8656;"),k.Longrightarrow=t(Q,"\\Longrightarrow ","&#8658;"),k.longleftrightarrow=t(Q,"\\longleftrightarrow ","&#8596;"),k.updownarrow=t(Q,"\\updownarrow ","&#8597;"),k.Longleftrightarrow=t(Q,"\\Longleftrightarrow ","&#8660;"),k.Updownarrow=t(Q,"\\Updownarrow ","&#8661;"),k.mapsto=t(Q,"\\mapsto ","&#8614;"),k.nearrow=t(Q,"\\nearrow ","&#8599;"),k.hookleftarrow=t(Q,"\\hookleftarrow ","&#8617;"),k.hookrightarrow=t(Q,"\\hookrightarrow ","&#8618;"),k.searrow=t(Q,"\\searrow ","&#8600;"),k.leftharpoonup=t(Q,"\\leftharpoonup ","&#8636;"),k.rightharpoonup=t(Q,"\\rightharpoonup ","&#8640;"),k.swarrow=t(Q,"\\swarrow ","&#8601;"),k.leftharpoondown=t(Q,"\\leftharpoondown ","&#8637;"),k.rightharpoondown=t(Q,"\\rightharpoondown ","&#8641;"),k.nwarrow=t(Q,"\\nwarrow ","&#8598;"),k.ldots=t(Q,"\\ldots ","&#8230;"),k.cdots=t(Q,"\\cdots ","&#8943;"),k.vdots=t(Q,"\\vdots ","&#8942;"),k.ddots=t(Q,"\\ddots ","&#8944;"),k.surd=t(Q,"\\surd ","&#8730;"),k.triangle=t(Q,"\\triangle ","&#9653;"),k.ell=t(Q,"\\ell ","&#8467;"),k.top=t(Q,"\\top ","&#8868;"),k.flat=t(Q,"\\flat ","&#9837;"),k.natural=t(Q,"\\natural ","&#9838;"),k.sharp=t(Q,"\\sharp ","&#9839;"),k.wp=t(Q,"\\wp ","&#8472;"),k.bot=t(Q,"\\bot ","&#8869;"),k.clubsuit=t(Q,"\\clubsuit ","&#9827;"),k.diamondsuit=t(Q,"\\diamondsuit ","&#9826;"),k.heartsuit=t(Q,"\\heartsuit ","&#9825;"),k.spadesuit=t(Q,"\\spadesuit ","&#9824;"),k.oint=t(Q,"\\oint ","&#8750;"),k.bigcap=t(Q,"\\bigcap ","&#8745;"),k.bigcup=t(Q,"\\bigcup ","&#8746;"),k.bigsqcup=t(Q,"\\bigsqcup ","&#8852;"),k.bigvee=t(Q,"\\bigvee ","&#8744;"),k.bigwedge=t(Q,"\\bigwedge ","&#8743;"),k.bigodot=t(Q,"\\bigodot ","&#8857;"),k.bigotimes=t(Q,"\\bigotimes ","&#8855;"),k.bigoplus=t(Q,"\\bigoplus ","&#8853;"),k.biguplus=t(Q,"\\biguplus ","&#8846;"),k.lfloor=t(Q,"\\lfloor ","&#8970;"),k.rfloor=t(Q,"\\rfloor ","&#8971;"),k.lceil=t(Q,"\\lceil ","&#8968;"),k.rceil=t(Q,"\\rceil ","&#8969;"),k.slash=t(Q,"\\slash ","&#47;"),k.opencurlybrace=t(Q,"\\opencurlybrace ","&#123;"),k.closecurlybrace=t(Q,"\\closecurlybrace ","&#125;"),k.caret=t(Q,"\\caret ","^"),k.underscore=t(Q,"\\underscore ","_"),k.backslash=t(Q,"\\backslash ","\\"),k.vert=t(Q,"|"),k.perp=k.perpendicular=t(Q,"\\perp ","&perp;"),k.nabla=k.del=t(Q,"\\nabla ","&nabla;"),k.hbar=t(Q,"\\hbar ","&#8463;"),k.AA=k.Angstrom=k.angstrom=t(Q,"\\text\\AA ","&#8491;"),k.ring=k.circ=k.circle=t(Q,"\\circ ","&#8728;"),k.bull=k.bullet=t(Q,"\\bullet ","&bull;"),k.setminus=k.smallsetminus=t(Q,"\\setminus ","&#8726;"),k.not=k["¬"]=k.neg=t(Q,"\\neg ","&not;"),k["…"]=k.dots=k.ellip=k.hellip=k.ellipsis=k.hellipsis=t(Q,"\\dots ","&hellip;"),k.converges=k.darr=k.dnarr=k.dnarrow=k.downarrow=t(Q,"\\downarrow ","&darr;"),k.dArr=k.dnArr=k.dnArrow=k.Downarrow=t(Q,"\\Downarrow ","&dArr;"),k.diverges=k.uarr=k.uparrow=t(Q,"\\uparrow ","&uarr;"),k.uArr=k.Uparrow=t(Q,"\\Uparrow ","&uArr;"),k.to=t(Z,"\\to ","&rarr;"),k.rarr=k.rightarrow=t(Q,"\\rightarrow ","&rarr;"),k.implies=t(Z,"\\Rightarrow ","&rArr;"),k.rArr=k.Rightarrow=t(Q,"\\Rightarrow ","&rArr;"),k.gets=t(Z,"\\gets ","&larr;"),k.larr=k.leftarrow=t(Q,"\\leftarrow ","&larr;"),k.impliedby=t(Z,"\\Leftarrow ","&lArr;"),k.lArr=k.Leftarrow=t(Q,"\\Leftarrow ","&lArr;"),k.harr=k.lrarr=k.leftrightarrow=t(Q,"\\leftrightarrow ","&harr;"),k.iff=t(Z,"\\Leftrightarrow ","&hArr;"),k.hArr=k.lrArr=k.Leftrightarrow=t(Q,"\\Leftrightarrow ","&hArr;"),k.Re=k.Real=k.real=t(Q,"\\Re ","&real;"),k.Im=k.imag=k.image=k.imagin=k.imaginary=k.Imaginary=t(Q,"\\Im ","&image;"),k.part=k.partial=t(Q,"\\partial ","&part;"),k.inf=k.infin=k.infty=k.infinity=t(Q,"\\infty ","&infin;"),k.alef=k.alefsym=k.aleph=k.alephsym=t(Q,"\\aleph ","&alefsym;"),k.xist=k.xists=k.exist=k.exists=t(Q,"\\exists ","&exist;"),k.and=k.land=k.wedge=t(Q,"\\wedge ","&and;"),k.or=k.lor=k.vee=t(Q,"\\vee ","&or;"),k.o=k.O=k.empty=k.emptyset=k.oslash=k.Oslash=k.nothing=k.varnothing=t(Z,"\\varnothing ","&empty;"),k.cup=k.union=t(Z,"\\cup ","&cup;"),k.cap=k.intersect=k.intersection=t(Z,"\\cap ","&cap;"),k.deg=k.degree=t(Q,"^\\circ ","&deg;"),k.ang=k.angle=t(Q,"\\angle ","&ang;"),nt=a(w,function(e,t){e.init=function(e){t.init.call(this,"\\"+e+" ","<span>"+e+"</span>")},e.respace=function(){this.jQ[0].className=this[h]instanceof B||this[h]instanceof R?"":"non-italicized-function"}}),k.ln=k.lg=k.log=k.span=k.proj=k.det=k.dim=k.min=k.max=k.mod=k.lcm=k.gcd=k.gcf=k.hcf=k.lim=nt,function(){var e,t=["sin","cos","tan","sec","cosec","csc","cotan","cot"];for(e in t)k[t[e]]=k[t[e]+"h"]=k["a"+t[e]]=k["arc"+t[e]]=k["a"+t[e]+"h"]=k["arc"+t[e]+"h"]=nt}(),rt=function(){function e(e){var t=E();return e.adopt(t,0,0),t}function t(e){var t,n=e[0]||E();for(t=1;e.length>t;t+=1)e[t].children().adopt(n,n.ends[h],0);return n}var n=l.string,r=l.regex,i=l.letter,s=l.any,o=l.optWhitespace,u=l.succeed,a=l.fail,f=i.map(K),c=r(/^[^${}\\_^]/).map(Q),p=r(/^[^\\a-eg-zA-Z]/).or(n("\\").then(r(/^[a-z]+/i).or(r(/^\s+/).result(" ")).or(s))).then(function(e){var t=k[e];return t?t(e).parser():a("unknown command: \\"+e)}),d=p.or(f).or(c),v=n("{").then(function(){return g}).skip(n("}")),m=o.then(v.or(d.map(e))),g=m.many().map(t).skip(o),y=n("[").then(m.then(function(e){return"]"!==e.join("latex")?u(e):a()}).many().map(t).skip(o)).skip(n("]")),b=g;return b.block=m,b.optBlock=y,b}(),it=a(d,function(e){function t(e,t){var r,i,s,o;if(e[h][t])e.insAtLeftEnd(e[h][t]);else if(e[c][t])e.insAtRightEnd(e[c][t]);else{r=e.parent;do{if(i=r[t],i&&("function"==typeof i&&(i=r[t](e)),i===!1||i instanceof E)){e.upDownCache[r.id]=d(e.parent,e[c],e[h]),i instanceof E&&(s=e.upDownCache[i.id],s?s[h]?e.insLeftOf(s[h]):e.insAtRightEnd(s.parent):(o=n(e).left,e.insAtRightEnd(i),e.seekHoriz(o,i)));break}r=r.parent.parent}while(r)}return e.clearSelection().show()}function n(e){var t=e.jQ.removeClass("cursor").offset();return e.jQ.addClass("cursor"),t}function i(e){e.upDownCache={}}e.init=function(e){this.parent=this.root=e;var t=this.jQ=this._jQ=p('<span class="cursor">&zwj;</span>');this.blink=function(){t.toggleClass("blink")},this.upDownCache={}},e.show=function(){return this.jQ=this._jQ.removeClass("blink"),"intervalId"in this?clearInterval(this.intervalId):(this[h]?this.selection&&this.selection.ends[c][c]===this[c]?this.jQ.insertBefore(this.selection.jQ):this.jQ.insertBefore(this[h].jQ.first()):this.jQ.appendTo(this.parent.jQ),this.parent.focus()),this.intervalId=setInterval(this.blink,500),this},e.hide=function(){return"intervalId"in this&&clearInterval(this.intervalId),delete this.intervalId,this.jQ.detach(),this.jQ=p(),this},e.withDirInsertAt=function(e,t,n,r){var i=this.parent;this.parent=t,this[e]=n,this[-e]=r,i.blur()},e.insDirOf=function(e,t){return r(e),this.withDirInsertAt(e,t.parent,t[e],t),this.parent.jQ.addClass("hasCursor"),this.jQ.insDirOf(e,t.jQ),this},e.insLeftOf=function(e){return this.insDirOf(c,e)},e.insRightOf=function(e){return this.insDirOf(h,e)},e.insAtDirEnd=function(e,t){return r(e),this.withDirInsertAt(e,t,0,t.ends[e]),e===c&&t.textarea?this.jQ.insDirOf(-e,t.textarea):this.jQ.insAtDirEnd(e,t.jQ),t.focus(),this},e.insAtLeftEnd=function(e){return this.insAtDirEnd(c,e)},e.insAtRightEnd=function(e){return this.insAtDirEnd(h,e)},e.hopDir=function(e){return r(e),this.jQ.insDirOf(e,this[e].jQ),this[-e]=this[e],this[e]=this[e][e],this},e.hopLeft=function(){return this.hopDir(c)},e.hopRight=function(){return this.hopDir(h)},e.moveDirWithin=function(e,t){if(r(e),this[e])this[e].ends[-e]?this.insAtDirEnd(-e,this[e].ends[-e]):this.hopDir(e);else{if(this.parent===t)return;this.parent[e]?this.insAtDirEnd(-e,this.parent[e]):this.insDirOf(e,this.parent.parent)}},e.moveLeftWithin=function(e){return this.moveDirWithin(c,e)},e.moveRightWithin=function(e){return this.moveDirWithin(h,e)},e.moveDir=function(e){return r(e),i(this),this.selection?this.insDirOf(e,this.selection.ends[e]).clearSelection():this.moveDirWithin(e,this.root),this.show()},e.moveLeft=function(){return this.moveDir(c)},e.moveRight=function(){return this.moveDir(h)},e.moveUp=function(){return t(this,"up")},e.moveDown=function(){return t(this,"down")},e.seek=function(e,t){i(this);var n,r,s=this.clearSelection().show();return e.hasClass("empty")?(s.insAtLeftEnd(y[e.attr(at)]),s):(n=y[e.attr(ut)],n instanceof w?(e.outerWidth()>2*(t-e.offset().left)?s.insLeftOf(n):s.insRightOf(n),s):(n||(r=y[e.attr(at)],r||(e=e.parent(),n=y[e.attr(ut)],n||(r=y[e.attr(at)],r||(r=s.root)))),n?s.insRightOf(n):s.insAtRightEnd(r),s.seekHoriz(t,s.root)))},e.seekHoriz=function(e,t){var r,i=this,s=n(i).left-e;do i.moveLeftWithin(t),r=s,s=n(i).left-e;while(s>0&&(i[c]||i.parent!==t));return-s>r&&i.moveRightWithin(t),i},e.writeLatex=function(e){var t,n,r,s=this;return i(s),s.show().deleteSelection(),t=l.all,n=l.eof,r=rt.skip(n).or(t.result(!1)).parse(e),r&&(r.children().adopt(s.parent,s[c],s[h]),y.jQize(r.join("html")).insertBefore(s.jQ),s[c]=r.ends[h],r.finalizeInsert(),s.parent.bubble("redraw")),this.hide()},e.write=function(e){var t=this.prepareWrite();return this.insertCh(e,t)},e.insertCh=function(e,t){return this.parent.write(this,e,t),this},e.insertCmd=function(e,t){var n=k[e];return n?(n=n(e),t&&n.replaces(t),n.createLeftOf(this)):(n=V(),n.replaces(e),n.ends[c].focus=function(){return delete this.focus,this},n.createLeftOf(this),this.insRightOf(n),t&&t.remove()),this},e.unwrapGramp=function(){var e=this.parent.parent,t=e.parent,n=e[h],r=e[c];if(e.disown().eachChild(function(i){i.isEmpty()||(i.children().adopt(t,r,n).each(function(t){t.jQ.insertBefore(e.jQ.first())}),r=i.ends[h])}),!this[h])if(this[c])this[h]=this[c][h];else for(;!this[h];){if(this.parent=this.parent[h],!this.parent){this[h]=e[h],this.parent=t;break}this[h]=this.parent.ends[c]}this[h]?this.insLeftOf(this[h]):this.insAtRightEnd(t),e.jQ.remove(),e[c]&&e[c].respace(),e[h]&&e[h].respace()},e.deleteDir=function(e){if(r(e),i(this),this.show(),!this.deleteSelection())if(this[e])this[e].isEmpty()?this[e]=this[e].remove()[e]:this.selectDir(e);else if(this.parent!==this.root){if(this.parent.parent.isEmpty())return this.insDirOf(-e,this.parent.parent).deleteDir(e);this.unwrapGramp()}return this[c]&&this[c].respace(),this[h]&&this[h].respace(),this.parent.bubble("redraw"),this},e.backspace=function(){return this.deleteDir(c)},e.deleteForward=function(){return this.deleteDir(h)},e.selectFrom=function(e){var t,n,r,i,s,o,u=this,a=e;e:for(;;){for(t=this;t!==u.parent.parent;t=t.parent.parent)if(t.parent===a.parent){r=t,i=a;break e}for(n=e;n!==a.parent.parent;n=n.parent.parent)if(u.parent===n.parent){r=u,i=n;break e}u.parent.parent&&(u=u.parent.parent),a.parent.parent&&(a=a.parent.parent)}if(r[h]!==i){for(o=r;o;o=o[h])if(o===i[c]){s=!0;break}s||(s=i,i=r,r=s)}this.hide().selection=st(r[c][h]||r.parent.ends[c],i[h][c]||i.parent.ends[h]),this.insRightOf(i[h][c]||i.parent.ends[h]),this.root.selectionChanged()},e.selectDir=function(e){if(r(e),i(this),this.selection)if(this.selection.ends[e]===this[-e])this[e]?this.hopDir(e).selection.extendDir(e):this.parent!==this.root&&this.insDirOf(e,this.parent.parent).selection.levelUp();else{if(this.hopDir(e),this.selection.ends[e]===this.selection.ends[-e])return this.clearSelection().show(),o;this.selection.retractDir(e)}else{if(this[e])this.hopDir(e);else{if(this.parent===this.root)return;this.insDirOf(e,this.parent.parent)}this.hide().selection=st(this[-e])}this.root.selectionChanged()},e.selectLeft=function(){return this.selectDir(c)},e.selectRight=function(){return this.selectDir(h)},e.prepareMove=function(){return i(this),this.show().clearSelection()},e.prepareEdit=function(){return i(this),this.show().deleteSelection()},e.prepareWrite=function(){return i(this),this.show().replaceSelection()},e.clearSelection=function(){return this.selection&&(this.selection.clear(),delete this.selection,this.root.selectionChanged()),this},e.deleteSelection=function(){return this.selection?(this[c]=this.selection.ends[c][c],this[h]=this.selection.ends[h][h],this.selection.remove(),this.root.selectionChanged(),delete this.selection):!1},e.replaceSelection=function(){var e=this.selection;return e&&(this[c]=e.ends[c][c],this[h]=e.ends[h][h],delete this.selection),e}}),st=a(S,function(e,t){e.init=function(){var e=this;t.init.apply(e,arguments),e.jQwrap(e.jQ)},e.jQwrap=function(e){this.jQ=e.wrapAll('<span class="selection"></span>').parent()},e.adopt=function(){return this.jQ.replaceWith(this.jQ=this.jQ.children()),t.adopt.apply(this,arguments)},e.clear=function(){return this.jQ.replaceWith(this.jQ.children()),this},e.levelUp=function(){var e=this,t=e.ends[c]=e.ends[h]=e.ends[h].parent.parent;return e.clear().jQwrap(t.jQ),e},e.extendDir=function(e){return r(e),this.ends[e]=this.ends[e][e],this.ends[e].jQ.insAtDirEnd(e,this.jQ),this},e.extendLeft=function(){return this.extendDir(c)},e.extendRight=function(){return this.extendDir(h)},e.retractDir=function(e){r(e),this.ends[-e].jQ.insDirOf(-e,this.jQ),this.ends[-e]=this.ends[-e][e]},e.retractRight=function(){return this.retractDir(h)},e.retractLeft=function(){return this.retractDir(c)}}),ot.fn.mathquill=function(e,t){var n,r,s,o,u;switch(e){case"redraw":return this.each(function(){var e=p(this).attr(at),t=e&&y[e];t&&function n(e){e.eachChild(n),e.redraw&&e.redraw()}(t)});case"revert":return this.each(function(){var e=p(this).attr(at),t=e&&y[e];t&&t.revert&&t.revert()});case"latex":return arguments.length>1?this.each(function(){var e=p(this).attr(at),n=e&&y[e];n&&n.renderLatex(t)}):(n=p(this).attr(at),r=n&&y[n],r&&r.latex());case"text":return n=p(this).attr(at),r=n&&y[n],r&&r.text();case"html":return this.html().replace(/ ?hasCursor|hasCursor /,"").replace(/ class=(""|(?= |>))/g,"").replace(/<span class="?cursor( blink)?"?><\/span>/i,"").replace(/<span class="?textarea"?><textarea><\/textarea><\/span>/i,"");case"write":if(arguments.length>1)return this.each(function(){var e=p(this).attr(at),n=e&&y[e],r=n&&n.cursor;r&&r.writeLatex(t).parent.blur()});case"cmd":if(arguments.length>1)return this.each(function(){var e,n=p(this).attr(at),r=n&&y[n],i=r&&r.cursor;i&&(e=i.prepareWrite(),/^\\[a-z]+$/i.test(t)?i.insertCmd(t.slice(1),e):i.insertCh(t,e),i.hide().parent.blur())});default:return s="textbox"===e,o=s||"editable"===e,u=s?N:x,this.each(function(){i(p(this),u(),s,o)})}},ot(function(){ot(".mathquill-editable:not(.mathquill-rendered-math)").mathquill("editable"),ot(".mathquill-textbox:not(.mathquill-rendered-math)").mathquill("textbox"),ot(".mathquill-embedded-latex").mathquill()})})();