define(["tpl/filter/filter_bd","tpl/filter/filter","tpl/filter/filter_sub","lodash","oasisUf"],function(e,t,n,r){"use strict";var i=".oas-choose-btn",s=".mixchoose-btn",o=".mixchoose-quit",u=".mixchoose-confirm",a=".searchbox-toggle",f=".search-term-close",l=".search-box-bd";$.oasUiFactory("oasFilter",{VERSION:"1.0.0",options:{type:"tree",data:null,isOpen:!0,onChange:null},events:{"click .searchbox-toggle":function(e,t){var n=$(e),r=this.$el;n.hasClass("closed")?(n.removeClass("closed"),n.text("收起筛选"),r.find(l).css("display","block")):(n.addClass("closed"),n.text("展开筛选"),r.find(l).css("display","none"))},"click .mixchoose-btn":function(e,t){var n=$(e),r=n.parent(".oas-connection-item");this._openMutiSelectMode(r)},"click .mixchoose-quit":function(e,t){var n=$(e),r=n.parent(".oas-connection-item");this._quitMutiSelectMode(r,!1)},"click .mixchoose-confirm":function(e,t){var n=$(e),r=n.parent(".oas-connection-item");this._quitMutiSelectMode(r,!0)},"click .oas-choose-btn":function(e,t){var n=$(e),r=n.parent(".oas-connection-item");!n.hasClass("active")&&!r.hasClass("oas-mixchoose")&&this._singleSelectLogic(n,t),n.hasClass("active")&&!r.hasClass("oas-mixchoose")&&t.preventDefault()},"click .search-term-close":function(e,t){var n=$(e),r=n.closest(".search-term"),i;i=r.data("searchBoxItem"),i.find(".oas-choose-btn").removeClass("active").find("input").prop("checked",!1),this._clearSub(i),r.remove()}},_openMutiSelectMode:function(e){var t=this.$el,n=t.find(".oas-mixchoose");this._quitMutiSelectMode(n,!1),e.addClass("oas-mixchoose")},_quitMutiSelectMode:function(e,t){t?(e.find(i).each(function(e,t){var n=$(t);n.removeClass("active").find("input").prop("checked")&&n.addClass("active")}),this._clearSub(e),this._updateTopWrap(e)):e.find(i).each(function(e,t){var n=$(t);n.hasClass("active")?n.find("input").prop("checked",!0):n.find("input").prop("checked",!1)}),e.removeClass("oas-mixchoose")},_singleSelectLogic:function(e,t){var n=this.options.data,s=this.options.onChange,o=e.closest(".oas-connection-item"),u=$(i).index(e),a=e.attr("data-id"),f=r.find(n,"id",a);e.siblings(i).removeClass("active").end().addClass("active"),e.siblings(i).find("input").prop("checked",!1).end().end().find("input").prop("checked",!0),this._clearSub(o,u),s?s(f,o):this._renderSubData(f,o),this._updateTopWrap(o)},_renderSubData:function(e,t,i){var s=this.options.data,o=i?i:r.filter(s,"pid",e.id),u;o.length>0&&(u=n({list:o}),t.after(u))},_convertObjToTree:function(e){var t=0,n=e.length,r,i=[],s=function(e,t,n){var r,o,u,a;r=e.name,o=e.label,i.push({pid:t,id:n,name:r,label:o}),console.log("pid:"+t+" "+"id:"+n+" "+r+":"+o),u=n;if(e.children)for(var f=0;f<e.children.length;f++)a=u+"-"+(f+1),s(e.children[f],u,a)};for(;t<n;t++)r=t+1+"",s(e[t],"0",r);return i},_createDom:function(){var n=this.$el,r=this.options.data,r=r&&this._adjustData(r),i,s;s=e({isOpen:this.options.isOpen}),n.addClass("oas-search-box").html(s),i=t(r),n.find(".search-box-bd").html(i)},_adjustData:function(){var e=this.options.data,t=this.options.type,n=[];return t==="obj"&&(e=this.options.data=this._convertObjToTree(e)),r.filter(e,"pid","0").map(function(t){var i=r.filter(e,"pid",t.id);n.push({name:t.name,label:t.label,id:t.id,pid:t.pid,children:i})}),{list:n}},_create:function(){var e=this.options,t=this.$el,n=e.isOpen,r=e.data,i=t.find(a);r&&this._createDom(),t.find(".seachbox-item").each(function(e,t){var n=$(t).find(".labels").text();$(t).attr("data-filter-name",n),$(t).find(".oas-connection-item:gt(0)").addClass("sub").css("display","none")})},_clearSub:function(e){var t=e.nextAll();e.hasClass("seachbox-item")?e.find(".oas-connection-item:gt(0)").find(i).find("input").prop("checked",!1).end().removeClass("active").end().css("display","none"):t.remove()},_updateTopWrap:function(e){var t=e.closest(".seachbox-item"),n=t.find(".labels").text(),r=this._getSearchBox(t),i=this.$el.find(".search-term-wrap"),s=r.filterName,o,u,a="";i.find("[data-filter-name='"+s+"']").remove(),r.data.map(function(e){e.length>0&&(a=a+e.join("，")+"&nbsp;&nbsp;")}),a=r.name+a,u='<span class="search-term" data-filter-name="'+s+'">'+"<span>"+a+"</span>"+'<a href="javascript:;" class="search-term-close glyphicon glyphicon-remove-sign"></a>'+"</span>",o=$(u).data("searchBoxItem",t),i.append(o)},_getSelectedObj:function(){var e=this.options,t=this.$el,n=this.options.data,r=[];return t.find(".seachbox-item").each(function(){var e=[],t=$(this),n=t.find(".labels").text().slice(0,-1);t.find(".oas-connection-item").each(function(){var t=[],n=$(this);n.find(".oas-choose-btn.active").each(function(){var e=$(this),n;n=e.data(),t.push(n)}),t.length>0&&e.push(t)}),r.push({name:n,tree:e})}),r},_getSearchBox:function(e){var t=e.find(".labels").text(),n=e.attr("data-filter-name"),r=[];return e.find(".oas-connection-item").each(function(){var e=[],t=$(this);$(this).find(".oas-choose-btn.active").each(function(){var t=$(this);e.push(t.text())}),e&&r.push(e)}),{name:t,filterName:n,data:r}},invoke:{setSubData:function(e,t,n){this._renderSubData(e,t,n)},getSelectedObj:function(){return this._getSelectedObj()}}})});