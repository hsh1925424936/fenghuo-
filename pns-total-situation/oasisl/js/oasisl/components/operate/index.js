define(["Position","oasisUf","tpl/operate/panel","oasOverlay"],function(e,t,n){"use strict";$.oasUiFactory("oasOperate",{options:{trigger:"click",delay:150,data:[],target:"",offset:[0,0],placement:"auto",position:null,content:null},events:{"mouseover .expand-menu>li":function(e,t){if(this.options.trigger=="hover"){var n=$(e).attr("index"),r=this.mainList[n].id;$(e).siblings(".open").children(".second-menu").remove();if($(e).hasClass("oas-disable"))return;$(e).addClass("open"),this.subOneList=this._createList(r),this.layoutRule.vertical="bottom",this._createSubDom(this._preRenderData(this.subOneList,1,e),e)}},"mouseleave .oas-operate":function(e,t){},"mouseover .first-menu>li":function(e,t){this.options.trigger=="hover"&&$(e).parent().next().find("li.open").children(".second-menu").remove()},"mouseover .second-menu>li":function(e,t){if(this.options.trigger=="hover"){var n=$(e).attr("index"),r=this.subOneList[n].id;$(e).siblings(".open").children(".third-menu").remove();if($(e).hasClass("oas-disable"))return;this.subOneList[n].hasChild&&($(e).addClass("open"),this.subTwoList=this._createList(r),this.layoutRule.vertical="bottom",this._createSubDom(this._preRenderData(this.subTwoList,2,e),e))}},"click .expand-menu>li":function(e,t){if(this.options.trigger=="click"){var n=$(e).attr("index"),r=this.mainList[n].id;$(e).siblings(".open").children(".second-menu").remove();if($(e).hasClass("oas-disable"))return;$(e).addClass("open"),this.subOneList=this._createList(r),this.layoutRule.vertical="bottom",this._createSubDom(this._preRenderData(this.subOneList,1,e),e)}return!1},"click .first-menu>li":function(e,t){var n=$(e).attr("index");$(e).parent().next().find("li.open").children(".second-menu").remove();if($(e).hasClass("oas-disable"))return;return this._emit("selected",[this.mainList[n],this.$target]),this._iCall("close"),!1},"click .second-menu>li":function(e,t){var n=$(e).attr("index"),r=this.subOneList[n].id;if(this.options.trigger=="click"){$(e).siblings(".open").children(".third-menu").remove();if($(e).hasClass("oas-disable"))return;this.subOneList[n].hasChild?($(e).addClass("open"),this.subTwoList=this._createList(r),this.layoutRule.vertical="bottom",this._createSubDom(this._preRenderData(this.subTwoList,2,e),e)):(this._emit("selected",[this.subOneList[n],this.$target]),this._iCall("close"))}else if(this.options.trigger=="hover"){if($(e).hasClass("oas-disable"))return;this.subOneList[n].hasChild||(this._emit("selected",[this.subOneList[n],this.$target]),this._iCall("close"))}return!1},"click .third-menu>li":function(e,t){if($(e).hasClass("oas-disable"))return;var n=$(e).attr("index");return this._emit("selected",[this.subTwoList[n],this.$target]),this._iCall("close"),!1}},_create:function(){this.$target=null,this.options.data!=null&&this.options.data.length>0&&(this.options.position?(this.openType=0,this._initData(),this._openByPosition(),this._bindOuterClick()):(this.openType=1,this._initData(),this._openOverLay(),this.$target=$(this.options.target)))},_bindOuterClick:function(){var e=this;$(document).on("click.oasOperate",function(t){$(t.target).parents(".oas-operate").size()<1&&!$(t.target).is(".oas-operate")&&$(t.target).parents(".oas-operate").size()<1&&!$(t.target).is(".oas-operate")&&(e._iCall("close"),$(document).off("click.oasOperate"))})},_initData:function(){this._initParam(),this._tidyData()},_initParam:function(){this.layoutRule={horizontal:"right",vertical:"bottom"},this.mainList=[],this.subOneList=[],this.subTwoList=[]},_tidyData:function(){this.mainList=this._createList("0"),this._createDom(this._preRenderData(this.mainList,0))},_createList:function(e){var t=this.options.data,n=[],r=[],i=0,s=null;for(var o=0,u=t.length;o<u;o++)t[o].pid==e&&n.push(t[o]);for(var o=0,u=n.length;o<u;o++){for(var a=0,f=t.length;a<f;a++)if(n[o].id==t[a].pid){n[o].hasChild=!0;break}n[o].hasChild?r.push(n[o]):r.unshift(n[o])}n=[];for(var o=0;o<r.length;o++)r[o].hasChild||(n.push(r[o]),i++);return n.reverse(),r.splice(0,i),n.concat(r)},_preRenderData:function(e,t,n){var r=this.options,i=!1,s={};for(var o=0,u=e.length;o<u;o++)if(e[o].hasChild){i=!0;break}return n&&this._judgeLayOut(n,e),s={hasChild:i,list:e,level:t,layout:this.layoutRule}},_createDom:function(e){var t=n(e),r=this.options.content;if(this.openType){var i=this.$el;i.addClass("oas-operate").addClass("opt-panel"),i.empty().append(t),r?r.append(i):$("body").append(i)}else this.$el.addClass("oas-operate").addClass("opt-panel").empty().append(t),r?r.append(i):$("body").append(this.$el)},_createSubDom:function(e,t){var r=n(e),i=this.$el;$(t).has("ul").length==0&&$(r).appendTo($(t))},_openByPosition:function(){var e=this.options.position,t=this.$el,n=e.left,r=e.top,i=t.outerHeight(),s=t.outerWidth(),o=e.left,u=e.top,a={height:$(window).height(),width:$(window).width(),scrollTop:$(window).scrollTop(),scrollLeft:$(window).scrollLeft()};t.find(".operate-arrow").removeClass("left-arrow right-arrow bottom-arrow opposite").addClass("left-arrow"),a.width+a.scrollLeft-n-s<0&&(t.find(".operate-arrow").removeClass("left-arrow right-arrow bottom-arrow opposite").addClass("right-arrow"),o=n-s),a.height+a.scrollTop-r-i<0&&(t.find(".operate-arrow").removeClass("left-arrow right-arrow bottom-arrow opposite").addClass("left-arrow"),u=r-i,t.find(".operate-arrow").addClass("opposite")),a.height+a.scrollTop-r-i<0&&a.width+a.scrollLeft-n-s<0&&(t.find(".operate-arrow").removeClass("left-arrow right-arrow bottom-arrow opposite").addClass("right-arrow"),o=n-s,u=r-i,t.find(".operate-arrow").addClass("opposite")),t.css("left",o),t.css("top",u)},_judgeLayOut:function(t,n){var r=e.location(t,"fixed"),i={},s=this.layoutRule;r.right-191>=0?i.right=!0:i.right=!1,r.left-191>=0?i.left=!0:i.left=!1,r.top-((n.length-1)*30+6)>=0?i.top=!0:i.top=!1,r.bottom-((n.length-1)*30+6)>=0?i.bottom=!0:i.bottom=!1,s.horizontal=="right"&&(i.right?s.horizontal="right":i.left?s.horizontal="left":s.horizontal="right"),s.horizontal=="left"&&(i.left?s.horizontal="left":i.right?s.horizontal="right":s.horizontal="left"),s.vertical=="bottom"&&(i.bottom?s.vertical="bottom":i.top?s.vertical="top":s.vertical="bottom"),s.vertical=="top"&&(i.top?s.vertical="top":i.bottom?s.vertical="bottom":s.vertical="top")},_openOverLay:function(){var e=this.options,t=this.$el,n=this,r=e.target,i=e.trigger,s=e.delay,o=this.options.placement,u=this.$el.outerHeight(),a=this.$el.outerWidth(),f=e.offset[0],l=e.offset[1],c=e.content,h={height:$(window).height(),width:$(window).width(),scrollTop:$(window).scrollTop(),scrollLeft:$(window).scrollLeft()};t.oasOverlay({target:$(r),triggerType:i,delay:s,parentNode:c,align:{baseElement:r,baseXY:[0,0],direction:"v",alignType:-1,centerDist:10,isSuitable:!0}}).on("close.oasOverlay",function(){n._iCall("close")}).on("afterSetPosition.oasOverlay",function(e,n,r){var i,s,o={right:"left",left:"right",top:"bottom",bottom:"top"};r&&r.direction&&r.alignType&&(i=r.direction.toLowerCase(),s=r.alignType,t.find(".operate-arrow").removeClass("left-arrow bottom-arrow opposite").addClass(o[i]+"-arrow"),r.alignType===-1&&t.find(".operate-arrow").addClass("opposite"))}).on("beforeOpen.oasOverlay",function(e,r,i){return;var s,c,p,d,v,m,g,b})},invoke:{open:function(){var e=this,t=setTimeout(function(){e._create(),e._emit("open"),e.$el.show()},50)},close:function(){this._emit("close"),this.$el.find(".second-menu,.third-menu").remove(),this.$el.hide(),$("body").find(".oas-mask-opacity").hide()},data:function(e){this.options.data=e,this._create()},position:function(e){this.options.position&&(this.options.position=e,this._create())},target:function(e){e&&(this.$target=e)}}})});