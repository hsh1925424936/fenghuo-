define(["oasisUf","template","util","tpl/select/select","oasDropdown"],function(e,t,n,r){"use strict";$.oasUiFactory("oasSelect",{VERSION:"1.0.0",options:{width:250,dropWidth:!1,height:181,placeholder:"请选择",render:null,offset:[0,0],align:"left",disabled:!1,data:[],container:null},_create:function(){this._preRenderData(),this._createDom()},events:{target:function(){return this.options.container?$(this.options.container).find("."+this.randomClass):this.$select_el},"click .select-bd-li":function(e,t){if($(e).hasClass("disabled"))return!1;var n=$(e).index(),r=$(e).parents(".select-optgroup-li").size()?$(e).parents(".select-optgroup-li").find(".group-value").text():null;this._select(n,r),this._reload()},"mouseover .select-bd-li":function(e,t){if($(e).hasClass("disabled"))return!1;$(e).closest(".oas-select-bd").find(".select-bd-li").removeClass("focus"),$(e).addClass("focus")}},_preRenderData:function(){var e=this.options;this.$el.is("select")?(this.type=0,this._initData=this._convertData(this.$el)):(this.type=1,this._initData={list:e.data,disabled:e.disabled,placeholder:e.placeholder}),this._processData(this._initData)},_processData:function(e){var t=null,n=this,r=null;$.isArray(e)?r=e:(this._renderData=$.extend(!0,{},n._initData),r=this._renderData.list),_.forEach(r,function(e,t){e.children?_.forEach(e.children,function(e,t){n._convertRenderDate(e)}):n._convertRenderDate(e)}),t=_.find(r,{children:[{selected:!0}]}),this._renderData.chosen=_.find(r,{selected:!0})||(t?_.find(t.children,{selected:!0}):undefined),this._renderData.list=r},_convertRenderDate:function(e){e.render?e.renderData=e.render(e):this.options.render&&(e.renderData=this.options.render(e))},_convertData:function(e){var t=e[0].options,n=t.length,r=0,i=[],s=null,o={},u={},a=null;for(;r<n;r++)a=t[r],o={value:a.value,text:a.text,selected:a.selected,disabled:a.disabled},t[r].parentNode.getAttribute("label")?(s!==t[r].parentNode.getAttribute("label")&&(s=t[r].parentNode.getAttribute("label"),u={},u.text=s,u.children=[],i.push(u)),u.children.push(o)):i.push(o);return{list:i,disabled:e.prop("disabled"),placeholder:e.attr("placeholder")||this.options.placeholder}},_createDom:function(){var e=this.options;this.type?(this.$el.addClass("oas-select dropdown").empty().html(r(this._renderData)),this.$select_el=this.$el):(this.$el.hide().after($('<div class="oas-select dropdown">'+r(this._renderData)+"</div>")),this.$select_el=this.$el.next(".oas-select")),this.$select_el.css({width:e.width}),this._dropDown()},_select:function(e,t){var n=arguments,r=this._renderData.list,i=_.find(r,"children"),s=null,o=null;n[1]&&(i=_.find(r,{text:n[1]}),_.isObject(n[0])&&(i=_.where(r,{children:[]}))),_.isNumber(n[0])?s=i?_.at(i.children,n[0])[0]:_.at(r,n[0])[0]:_.isObject(n[0])?i?_.forEach(i,function(e){_.find(e.children,n[0])&&(s=_.find(e.children,n[0]))}):s=_.find(r,n[0]):console.warn(this.uiName+"设置选择必须为json或者数字"),s&&s.disabled!=1&&(o=$.extend(!0,{},s),this._renderData.chosen&&(this._renderData.chosen.selected=!1),s.selected=!0,this._renderData.chosen={},this._renderData.chosen=s,o.selected||this._emit("change",[this.$select_el,s]),this._emit("select",[this.$select_el,s]))},_dropDown:function(){var e=this,t=this.options.align,n,r={};if(this._renderData.disabled){this.$select_el.addClass("disabled");return}this.options.container&&(this.randomClass=(new Date).getTime()+""),this.$select_el.find(".select-hd").oasDropdown({isClickable:!0,miss:!0,container:this.options.container?$(this.options.container):null,randomClass:this.randomClass?this.randomClass:""}),n=this.$select_el.find(".select-hd").outerHeight(),r={width:+this.options.dropWidth&&this.options.dropWidth>0?this.options.dropWidth:this.options.width,maxHeight:this.options.height,left:+this.options.offset[0]?+this.options.offset[0]:0,top:+this.options.offset[1]?+this.options.offset[1]+n:n},t=="right"&&(r.left="inherit",r.right=+this.options.offset[0]?0- +this.options.offset[0]:0),this.options.container?this.$select_bd=$(this.options.container).find("."+this.randomClass).css(r):this.$select_bd=this.$select_el.find(".oas-select-bd").css(r),this.$select_el.find(".select-hd").on("show.oasDropdown",function(t,n){e._emit("open",[e.$select_el])}),this.$select_el.find(".select-hd").on("hide.oasDropdown",function(t,n){e._emit("close",[e.$select_el])})},_destroyDropDown:function(){this.$select_el.find(".select-hd").data("oasDropdown")&&this.$select_el.find(".select-hd").oasDropdown("destroy")},_reload:function(){this._destroyDropDown(),this.$select_el.html(r(this._renderData)),this._dropDown(),this.options.container&&this._bindUiEvents()},invoke:{reset:function(){var e=this;this._processData(this._initData),this._reload()},reload:function(){this.$el.is("select")&&(this._renderData=this._convertData(this.$el)),this._reload()},open:function(){this.$select_el.find(".select-hd").data("oasDropdown")?this.$select_el.find(".select-hd").oasDropdown("open"):console.warn("disabled状态下不可操作面板")},close:function(){this.$select_el.find(".select-hd").data("oasDropdown")?this.$select_el.find(".select-hd").oasDropdown("close"):console.warn("disabled状态下不可操作面板")},data:function(e){var t=this.options;if(!e)return this._renderData.list;_.isArray(e)?this._processData(e):console.warn(this.uiName+'("data")方法的参数不是一个数组'),this._reload()},select:function(e,t){var n={};if(!e&&!_.isNumber(e))return n=$.extend(!0,{},this._renderData.chosen),n;this._select(e,t),this._reload()},disabled:function(e){_.isBoolean(e)?this._renderData.disabled=e:this._renderData.disabled=!0,this._reload()}}})});