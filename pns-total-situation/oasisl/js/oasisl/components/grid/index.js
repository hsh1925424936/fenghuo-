define(["lodash","oasisUf","tpl/grid/table","tpl/grid/thead","tpl/grid/tbody","tpl/grid/simpleTable","tpl/grid/simpleThead","tpl/grid/simpleTbody","tpl/grid/tbodyNoData","template","oasSticky"],function(e,t,n,r,i,s,o,u,a,f){"use strict";$.oasUiFactory("oasGrid",{options:{type:"normal",head:null,body:null,autoRender:!1,checkbox:!1,height:"auto",width:"auto",opts:null,colOpts:{data:null,type:"normal",width:150},striped:!1,nowrap:!0,settings:{},headSettings:{fixedColumn:!1,multiSort:!1,isColDrag:!1,headFixed:{show:!1,fixedTop:10}},nodataTpl:null},events:{"click .oas-grid-checkbox":function(e,t){var n=this.$el,r=this.checkedArray=[];if(!$(t.target).is("input[type=checkbox]"))return;var i=$(t.target),s=i.prop("checked"),o=i.closest("tr").index();if(!$(e).closest(".grid-front-fixed").size())return;var u=n.find(".oas-grid-tbody").find(".grid-front-fixed").find(".oas-grid-checkbox").find("input[type=checkbox]"),a=n.find(".oas-grid-tbody").find("table");if(!$(e).closest(".oas-grid-thead").size())s?a.find("tr:eq("+o+")").addClass("oas-grid-active"):a.find("tr:eq("+o+")").removeClass("oas-grid-active");else{s?u.not(":disabled").prop("checked",!0):u.not(":disabled").prop("checked",!1);var f=[];u.filter(":not(:disabled):checked").each(function(){f.push($(this).closest("tr").index())}),s?$.each(f,function(e,t){a.find("tr:eq("+t+")").addClass("oas-grid-active")}):a.find("tr").removeClass("oas-grid-active")}this._updateCheckArray(),this._emit("checkedChange",[this._iCall("getCheckedIndex")])},"click .sort-icon":function(e,t){var n=$(e).closest("th").addClass("is-sorted"),r=n.index(),i=e.className.match(/sort|asc|desc/g)[1],s,o=$(e).closest("th").attr("name");this.options.headSettings.multiSort||this.$el.find("th").not(n).removeClass("is-sorted").find(".sort-icon").removeClass("oasicon-desc oasicon-asc").addClass("oasicon-sort");switch(i){case"sort":$(e).removeClass("oasicon-sort").addClass("oasicon-desc"),s="desc";break;case"desc":$(e).removeClass("oasicon-desc").addClass("oasicon-asc"),s="asc";break;default:$(e).removeClass("oasicon-asc").addClass("oasicon-desc"),s="desc"}this._emit("sort",[o,s]),t.preventDefault()},"click .oas-grid-opt-btn":function(e,t){if(!$(e).hasClass("oas-disabled")){var n=$(e).index();this._emit("optsClick",[this.options.opts[n],this.checkedArray])}},"click .oas-grid-operator":function(e,t){var n=this.options,r=$(t.target),i=$(t.target).closest("a"),s=$(e).parent().index();if(!i.size())return;!i.hasClass("oas-disabled")&&this._emit("colOptsClick",[s,n.body[s],n.colOpts.data[s]])},"mouseover tr":function(e,t){var n=this.$el.find(".oas-grid-tbody");if(!!$(e).closest(".oas-grid-tbody").size()){n.find("tr").removeClass("oas-grid-hover");var r=$(e).index();n.find("table").each(function(e,t){$(this).find("tr").eq(r).addClass("oas-grid-hover")})}},"mouseout tr":function(e,t){!!$(e).closest(".oas-grid-tbody").size()&&this.$el.find(".oas-grid-tbody tr").removeClass("oas-grid-hover")},"mousedown #grid-search-btn":function(e,t){var n=$(e).prev().val();this._emit("search",[n])},"mouseenter #grid-search-btn":function(e,t){$(e).closest(".oas-grid-search").addClass("focus")},"mouseleave #grid-search-btn":function(e,t){$(e).closest(".oas-grid-search").removeClass("focus")},"keypress #grid-search-input":function(e,t){t.which==13&&$(e).next().trigger("mousedown")}},_create:function(){var e=this.options;this._setGridProp(),e.autoRender&&this.render()},_setGridProp:function(){var e=this.$el,t=this.options,n=t.nowrap;e.addClass("oas-grid"),n&&e.addClass("oas-grid-nowrap"),t.striped&&e.addClass("grid-striped")},render:function(){this._createTable(),this.renderdy=!0},_createTable:function(){var e=this,t=this.$el,n=this.options;this._adjustColumnWidth(),!this.renderdy&&this._renderGrid(),this._renderHead(),n.body&&this._renderBody(),this._updateCheckArray(),this._adjustGrid(),this._bindEvent(),!this.minWidth&&n.headSettings.isColDrag&&this._colDragEvent(1)},_updateCheckArray:function(){var e=this.$el,t=this.checkedArray=[],n=e.find(".oas-grid-tbody").find(".grid-front-fixed").find(".oas-grid-checkbox").find("input[type=checkbox]"),r=n.filter("input:not(:disabled)"),i=r.size(),s=e.find(".oas-grid-thead").find(".grid-front-fixed").find(".oas-grid-checkbox").find("input[type=checkbox]");n.filter(":checked").size()===i&&i!==0?s.prop("checked",!0):s.prop("checked",!1),$.each(n,function(e,n){$(this).prop("checked")&&t.push(e)})},_bindEvent:function(){var e=this,t=this.$el,n=this.options,r,i=$(window).width(),s=$(window).height();t.find(".oas-grid-scroll-h").off("scroll.oas-grid"),t.find(".oas-grid-scroll-h").on("scroll.oas-grid",function(){t.find(".grid-main table").css("margin-left",0-$(this).scrollLeft()),e._emit("scrolling")});var o=e._isScrollExist();$(window).resize(function(){r&&clearTimeout(r),r=setTimeout(function(){var n=$(window).width(),r=$(window).height(),u=!o||o!=e._isScrollExist();if(i!==n||s!==r){e._adjustGrid(),t.hasClass("has-scrollh-fixed")?e._resetScrollOuterWidth():0,o=e._isScrollExist();if(!e.colObject||!e.colObject.currentCol||!e.options.headSettings.isColDrag)return;u&&(e._calculateColArray(),e._setColArray(e.colObject.currentCol)),e._resetScrollInnerWidth()}},80)})},_renderGrid:function(){var e=this._renderData={},t=this.options;e.opts=t.opts,e.settings=t.settings,this._createDom()},_renderHead:function(){var e=this._renderData,t=this.options;this._adjustHeadData(),e.headFront=e.headFront||[],e.headFinale=e.headFinale||[],e.headCenter=e.headCenter||[],e.checkbox=t.checkbox,this._renderData.colOpts=t.colOpts,e.isStickWidth=this.isStickWidth,t.type=="simple"?this.$el.find(".oas-grid").empty().append(o(this._renderData)):this.$el.find(".oas-grid-thead").empty().append(r(this._renderData))},_renderBody:function(){var e=this.options,t=e.body,n=this.$el.find(".oas-grid-tbody");this.checkedArray=[],this._adjustBodyData(),this._renderData.tempBody=this.tempBody,this._renderData.colOpts=this._convertColOpts(e.colOpts);if(e.type=="simple"){if(t.length<=0)return this.$el.find(".oas-grid").addClass("no-data").html(this.options.nodataTpl||a()),!1;this.$el.find(".oas-grid").hasClass("no-data")&&(this.$el.find(".oas-grid").removeClass("no-data"),this.$el.find(".oas-grid").empty().append(o(this._renderData))),this.$el.find("table").find("tbody").remove().end().append(u(this._renderData))}else{if(t.length<=0)return n.empty().addClass("no-data").append(this.options.nodataTpl||a()),!1;n.empty().removeClass("no-data").append(i(this._renderData))}this.$el.find(".oas-grid-thead").find(".oas-grid-checkbox").find("input[type=checkbox]").prop("checked",!1),this._updateCheckArray(),this.options.striped?this._renderTrstriped(!0):this._renderTrstriped(!1)},_convertColOpts:function(t){var n=this.options,r=n.body,i=t.data;if(e.isArray(i)&&i.length===1)for(var s=1,o=r.length;s<o;s++)i[s]=i[0];return t},_createDom:function(){this.options.type=="simple"?this.$el.empty().append(s()):this.$el.empty().append(n(this._renderData))},_adjustColumnWidth:function(){var e=this.options,t=0,n=e.head,r=[],i=[],s=!1,o,u=this.colObject={},a=$('<div class="outWindow" style="font-weight:bold;"></div>').appendTo($("body"));if(!e.head||e.head.length===0)return;for(var f=0,l=n.length;f<l;f++){var c=n[f],h=$('<span style="float:left;white-space:nowrap;"></span>'),p,d;c.width==="minwidth"&&(s=f),!c.width||c.width===""||isNaN(c.width)?c.width=10:c.width=parseInt(c.width,10),h.html(c.label),a.append(h),p=h.text(),d=h.width()+20,c.sort&&c.sort!=="false"&&(d+=40),c.width<d&&(c.width=d),i.push(d),r.push(c.width),t+=c.width,c.isStickWidth&&(this.isStickWidth=!0)}a.remove(),s!==!1&&(this.minWidthCol=s,this.minWidth=n[this.minWidthCol].minWidth=!0),u.initialMinCol=i,u.initialCol=r},_convertBodyData:function(){var e=this,t=this.options,n=t.body,r=this.tempBody=$.extend(!0,n,{}),i=t.head;n=t.body=[];for(var s=0,o=r.length;s<o;s++){var u=r[s],a=[];for(var l=0,c=i.length;l<c;l++){var h=i[l],p=u[h.name],d=h.dataRender;d&&typeof d=="string"?p=f.compile(d)(u):d&&typeof d=="function"&&(p=f.compile(d(u))(u)),a.push(p)}n.push(a)}},_adjustHeadData:function(){var t=this.options,n=t.headSettings.fixedColumn,r=n[0],i=n[1],s=t.head,o=this._renderData;o.colOptsWidth=null;if(!e.isArray(n)||r+i>=s.length||!$.isNumeric(r)||!$.isNumeric(i))n=[0,0];r=n[0],i=n[1],o.headFront=e.slice(s,0,r),o.headCenter=e.slice(s,r,s.length-i),o.headFinale=e.slice(s,s.length-i,s.length),this.colObject.initialCol=e.slice(this.colObject.initialCol,r,s.length-i);var u=0,a=0,f=0,l=o.headWidthArray=[],c=t.checkbox?40:0,h=t.colOpts.data?t.colOpts.type==="panel"?100:o.colOptsWidth=t.colOpts.width:0;u+=c,o.headFront&&$.each(o.headFront,function(e,t){u+=t.width}),o.headCenter&&$.each(o.headCenter,function(e,t){a+=t.width}),o.headFinale&&$.each(o.headFinale,function(e,t){f+=t.width})&&(f+=h),l.push(u),l.push(a),l.push(f)},_adjustBodyData:function(){this.options.body&&$.type(this.options.body[0])=="object"&&this._convertBodyData();var t=this.options,n=t.headSettings.fixedColumn,r=t.head,i=t.body,s=n[0],o=n[1],u=this._renderData;if(!e.isArray(n)||s+o>=r.length||!$.isNumeric(s)||!$.isNumeric(o))n=[0,0];s=n[0],o=n[1],u.bodyFront=[],u.bodyCenter=[],u.bodyFinale=[],$.each(i,function(t,n){u.bodyFront.push(e.slice(n,0,s)),u.bodyCenter.push(e.slice(n,s,r.length-o)),u.bodyFinale.push(e.slice(n,r.length-o,r.length))})},_adjustGrid:function(){var e=this,t=this.options,n=this.$el,r=t.head,i=t.body,s=this._renderData,o=t.headSettings.headFixed;this._adjustWidth(),this._adjustHeight(),r&&i&&i.length>0&&o.show&&t.type!=="simple"&&this._setHeadFixed(1),this.minWidth&&n.find(".grid-main table").css("min-width",s.headWidthArray[1])},_adjustWidth:function(){var e=this.$el,t=0,n=0,r=this,i=this._renderData,s=i.headWidthArray[0],o=i.headWidthArray[1],u=i.headWidthArray[2],a=0;e.find(".grid-front-fixed").outerWidth(s),e.find(".grid-finale-fixed").outerWidth(u),e.find(".grid-main").css({left:s,right:u}),e.find(".oas-grid-scroll-h").css({marginLeft:s,marginRight:u}).scrollLeft(0).find("div").width(o)},_adjustHeight:function(){var e=this.$el,t=this.options,n=t.height,r=e.find(".oas-grid-tbody"),i=r.find(".grid-main tr"),s=r.find(".grid-front-fixed tr"),o=r.find(".grid-finale-fixed tr");$.each(i,function(e,t){var n=s.eq(e),r=$(this),i=o.eq(e),u=[n.outerHeight(),r.outerHeight(),i.outerHeight()],a=Math.max.apply(null,u);n.outerHeight(a),r.outerHeight(a),i.outerHeight(a)});if(n==="auto"&&t.type!=="simple"){var u=e.find(".oas-table-nodata").size()>0?e.find(".oas-table-nodata").outerHeight()+1:e.find(".grid-main").eq(1).outerHeight();e.find(".oas-grid-tbody").outerHeight(u)}},_adjustScroll:function(){var e=this.$el,t=this.$el.offset().top,n=$(window).height(),r=$(document).scrollTop();r+n>t&&r<t+e.height()-n?(e.addClass("has-scrollh-fixed"),this._resetScrollOuterWidth()):(e.removeClass("has-scrollh-fixed"),e.find(".oas-grid-scroll-h").outerWidth("auto"))},_renderTrstriped:function(e){var t=this.$el,n=t.find(".oas-grid-tbody table");e?n.find("tr:odd").addClass("oas-striped"):n.find("tr:odd").removeClass("oas-striped")},_colDragEvent:function(e){var t=this,n=this.$el,r=this.options;switch(e){case 1:r.headSettings.isColDrag=!0,n.find(".oas-col-line").css("cursor","col-resize"),$(this.$el).on("mousedown.oasGridColDrag",".oas-col-line",function(e){var n=this,r,i=$(n).closest("th"),s,o,u=t.colDragInfo={coldrag:!0,$srcElement:$(e.target),dragLeft:$(n).offset().left,dragColIndex:i.index()};$(this).closest("th").addClass("colDragging"),r=u.dragColIndex,s=t.colObject.initialMinCol,u.dragMaxCol=i.offset().left+i.outerWidth()-s[r],u.dragMinCol=i.prev().offset().left+s[r-1],t._setColArray(o=t.colObject.currentCol=t._getColArray()),t.colObject.dragColWidth=o[r-1]+o[r]}),$(this.$el).on("mousemove.oasGridColDrag","table",function(e){var r=this,i=t.colObject,s=t.colDragInfo;if(!s)return;document.selection&&document.selection.empty(),window.getSelection&&window.getSelection().removeAllRanges(),t.setCapture&&t.setCapture();if(s.coldrag&&s.$srcElement){var o=e.clientX-s.dragLeft,u=s.dragColIndex,a=n.find(".oas-grid-thead .grid-main col"),f=n.find(".oas-grid-tbody .grid-main col"),l=i.initialMinCol,c=i.currentCol;if(e.clientX>s.dragMaxCol||e.clientX<s.dragMinCol)return 0;if(o>0){if(c[u]-o<l[u])return;c[u]="*",a.each(function(e){e==u-1?($(this).attr("width",c[e]+o),c[e]=c[e]+o):$(this).attr("width",c[e])}),$.each(c,function(e,t){$(f.get(e)).attr("width",t)}),t._resetColArray(u,"right")}else{if(c[u-1]+o<l[u-1])return;c[u-1]="*",a.each(function(e){e==u?($(this).attr("width",c[e]-o),c[e]=c[e]-o):$(this).attr("width",c[e])}),$.each(c,function(e,t){$(f.get(e)).attr("width",t)}),t._resetColArray(u-1,"left")}}s.dragLeft=e.clientX}),$(document).on("mouseup.oasGridColDrag",function(e){t.releaseCapture&&t.releaseCapture(),t.colDragInfo&&t.colDragInfo.coldrag&&(t.colDragInfo.coldrag=!1,n.find("th.colDragging").removeClass("colDragging"))});break;case 0:r.headSettings.isColDrag=!1,n.find(".oas-col-line").css("cursor","auto"),$(this.$el).off(".oasGridColDrag"),$(document).off(".oasGridColDrag")}},_getColArray:function(){var e=this.$el.find(".oas-grid-thead .grid-main th"),t=[];return $.each(e,function(n,r){t.push($(e.get(n)).width())}),t},_setColArray:function(e){var t=this.$el.find(".oas-grid-thead .grid-main col"),n=this.$el.find(".oas-grid-tbody .grid-main col");$.each(e,function(e,r){t.eq(e).attr("width",r),n.eq(e).attr("width",r)})},_resetColArray:function(e,t){var n=this.$el.find(".oas-grid-thead .grid-main col"),r=this.$el.find(".oas-grid-tbody .grid-main col"),i=this.colObject.currentCol,s=this.colObject.dragColWidth;t=="right"?i[e]=s-i[e-1]:i[e]=s-i[e+1],n.eq(e).attr("width",i[e]),r.eq(e).attr("width",i[e])},_calculateColArray:function(){var e=this.colObject.initialMinCol,t=this.colObject.currentCol,n=[],r=[],i;$.each(t,function(n,i){r.push(t[n]/e[n])}),i=Math.min.apply(null,r),$.each(t,function(e,t){n.push(Math.round(t/i))}),this.colObject.currentCol=n},_isScrollExist:function(){var e=this.$el,t=e.find(".oas-grid-scroll-h"),n=t.outerWidth(),r=t.find("div").outerWidth();return r+2>n},_resetScrollOuterWidth:function(){var e=this.$el,t=e.find(".oas-grid-thead .grid-main"),n=t.outerWidth()+2,r=t.offset().left;e.find(".oas-grid-scroll-h").outerWidth(n).offset({left:r-1})},_resetScrollInnerWidth:function(){var e=this.$el,t=this.colObject.currentCol,n=0;$.each(t,function(e,t){n+=t}),e.find(".oas-grid-scroll-h").find("div").outerWidth(n)},_setHeadFixed:function(e){var t=this,n=this.options,r=this.$el,i=n.headSettings.headFixed,s=i.fixedTop,o,i=this.options.headSettings.headFixed;o=r.offset().top+r.outerHeight()-r.find(".oas-grid-head").outerHeight()-r.find(".oas-grid-thead").outerHeight()-s;switch(e){case 1:i.show=!0,r.find(".oas-grid-head").oasSticky({topSpacing:s,stoptionsp:o}),r.find(".oas-grid-thead").oasSticky({topSpacing:s+r.find(".oas-grid-head").outerHeight(),stoptionsp:o}),$('<style>.oas-issticky .oas-grid-head:after{content:"";position:absolute;right:0;bottom:40px;left:0;height:'+s+"px;background-color:#fff}</style>").appendTo("head"),$(window).on("scroll.oas-grid",function(){t._adjustScroll()}),setTimeout(function(){t._adjustScroll()},40);break;case 0:i.show=!1,r.find(".oas-grid-head").oasSticky("unstick"),r.find(".oas-grid-thead").oasSticky("unstick"),$(window).off("scroll.oas-grid"),r.removeClass("has-scrollh-fixed"),r.find(".oas-grid-scroll-h").outerWidth("auto")}},invoke:{data:function(e,t){var n=this.$el,r=this.options;arguments.length===1&&(t=e,e=null),this.isStickWidth=!1;if(t&&!e){r.body=t;if(!r.autoRender&&!this.renderdy)return;return this._iCall("colOpts",[r.colOpts.data]),this._renderBody(),this._adjustGrid(),this}if(t&&e){r.body=t,r.head=e;if(!r.autoRender&&!this.renderdy)return;return this._createTable(),this}},colOpts:function(e){var t=this.options,n=t.colOpts.data,r=t.body;if(!e||!r)return;t.colOpts.data=e;if(!t.autoRender&&!this.renderdy)return;!n&&this._renderHead(),this._renderBody(),this._adjustGrid()},getCheckedIndex:function(){var e=this.checkedArray,t,n,r=[];if(this.tempBody&&e)for(t=0,n=e.length;t<n;t++)r.push(this.tempBody[e[t]]);var i={selectIndexs:e,selectRows:r};return i},render:function(){var e=this.options;if(!e.autoRender&&this.renderdy)return;this.render()},getSearchKeyword:function(){return this.$el.find("#grid-search-input").val()},setColDrag:function(e){var t=e?1:0;if(this.minWidth)return;this._colDragEvent(t)},setHeadFixed:function(e,t){var n=this.options.headSettings.headFixed,r=e?1:0;if(this.options.type==="simple"||n.show==!!e)return;e&&(n.fixedTop=t||0),this._setHeadFixed(r)}}})});