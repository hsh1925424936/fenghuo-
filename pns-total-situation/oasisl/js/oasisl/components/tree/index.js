define(["oasisUf","template","util","tpl/tree/tree","tpl/tree/tree_root","lodash"],function(e,t,n,r,i){"use strict";$.oasUiFactory("oasTree",{VERSION:"1.0.0",options:{root:null,data:[],dataType:"array",checkType:null,disable:!1,checkedIds:[],returnPartChecked:!1,noDataStyle:0,checkboxEffect:{Y:"ps",N:"ps"},showType:1,height:"auto",width:"auto"},_create:function(){this.bakData=$.extend(!0,[],this.options.data),this.bakRoot=$.extend(!0,{},this.options.root),this.triggerFlag=!1,this.triggerValue=undefined,this.selectedNodeId="",this.nodesString=[],this.onceCheckChangeNodes=[],this.checkedNodes=[],this.arrayTypeData=[],this._tidyData(),this._concatChecked(),this._generateKv(),this._preRenderData(),this._createDom(this._renderData),this._generateKv()},_tidyData:function(){var e=this.bakData;this.options.dataType==="tree"&&(this._tree2Array(e),this.bakData=this.arrayTypeData)},_tree2Array:function(e){for(var t=0;t<e.length;t++)this.arrayTypeData.push(e[t]),e[t].childList&&e[t].childList.length>0&&this._tree2Array(e[t].childList)},_concatChecked:function(){var e=this.bakData,t=this.options.checkedIds,n=this;_.forEach(e,function(e,r){n.options.dataType==="tree"&&e.childList&&delete e.childList,n.options.disable&&(e.disabled=!0),_.forEach(t,function(t,n){if(e.id===t)return e.checked=!0,!1})})},events:{target:function(){return this.$el},"click li>span":function(e,t){var n=$(e)[0].className;if(n.indexOf("docu")!=-1)return!1;n.indexOf("open")!=-1&&($(e).removeClass(n).addClass(n.split("-")[0]+"-close"),$(e).closest("li").find(">ul").hide());if(n.indexOf("close")!=-1){$(e).removeClass(n).addClass(n.split("-")[0]+"-open"),$(e).closest("li").find(">ul").show();if(this.bigData){var r=this.kvNodes,i=$(e).closest("li"),s=i.attr("nodeid"),o=r[s],u=i.find("ul"),a=[];o.childList.forEach(function(e,t,n){e.isFirstNode=t==0?!0:!1,e.isLastNode=t==n.length-1?!0:!1}),o&&!i.data("hasRendered")&&(this._appendNodes(u,o.childList),i.data("hasRendered",!0))}}},"click li>a":function(e,t){if($(e).closest("li").hasClass("node-disabled"))return;this.$el.find("a").removeClass("current"),$(e).addClass("current"),this.selectedNodeId=$(e).closest("li").attr("nodeid"),this._emit("select",[this._iCall("getSelectedNode")])},"click .oastree-root>a":function(e,t){if($(e).closest(".oastree-root").hasClass("node-disabled"))return;this.$el.find("a").removeClass("current"),$(e).addClass("current"),this.selectedNodeId="",this._emit("select",[this.bakRoot])},"dblclick .oastree-root>a":function(e,t){if(this._renderData.length===0)return;this.$el.find(".oastree-nodes").toggle(),this.$el.find(".oastree-root>span").toggleClass("show")},"click li>input[type=checkbox]":function(e,t){var n=this.kvNodes[$(e).closest("li").attr("nodeid")],r=$(e).prop("checked");this.triggerFlag&&(r=this.triggerValue),this.onceCheckChangeNodes=[],r?(n.checked=!0,_.find(this.checkedNodes,{id:n.id})||this.onceCheckChangeNodes.push(n),_.remove(this.checkedNodes,{id:n.id}),this.checkedNodes.push(n),this.options.checkboxEffect.Y.indexOf("p")>-1&&this._judgeParentNode(n.pid),this.options.checkboxEffect.Y.indexOf("s")>-1&&(n.isParent?this._makeChildrenDone(n,r):undefined)):(n.checked=!1,_.remove(this.checkedNodes,{id:n.id}),this.onceCheckChangeNodes.push(n),this.options.checkboxEffect.N.indexOf("p")>-1&&this._judgeParentNode(n.pid),this.options.checkboxEffect.N.indexOf("s")>-1&&(n.isParent?this._makeChildrenDone(n,r):undefined)),this._emit("checkChange",[this._iCall("getCheckedNodes"),r,this.onceCheckChangeNodes]),this.triggerFlag=!1,this.triggerValue=undefined},"click li>input[type=radio]":function(e,t){var n=this.kvNodes[$(e).closest("li").attr("nodeid")],r=$(e).prop("checked");this.checkedNodes.length===1?this.checkedNodes[0].id!==n.id&&(_.remove(this.checkedNodes,{id:this.checkedNodes[0].id}),this.checkedNodes.push(n),this._emit("checkChange",[this._iCall("getCheckedNodes")])):(this.checkedNodes.length=0,this.checkedNodes.push(n),this._emit("checkChange",[this._iCall("getCheckedNodes")]))}},_judgeParentNode:function(e){var t=this.kvNodes[""+e];if(!t||!t.childList||t.childList.length===0)return;var n=[],r=0;_.forEach(t.childList,function(e,t){e.disabled||(n.push(e),e.checked?r++:undefined)}),r===n.length?(t.checked=!0,_.find(this.checkedNodes,{id:e})||this.onceCheckChangeNodes.push(t),_.remove(this.checkedNodes,{id:e}),this.checkedNodes.push(t),this.$el.find('li[nodeid="'+e+'"]>input[type=checkbox]').prop("checked",!0),this._judgeParentNode(t.pid)):r<n.length&&t.checked&&(t.checked=!1,_.remove(this.checkedNodes,{id:e}),this.onceCheckChangeNodes.push(t),this.$el.find('li[nodeid="'+e+'"]>input[type=checkbox]').prop("checked",!1),this._judgeParentNode(t.pid))},_makeChildrenDone:function(e,t){var n=this;this.$el.find('li[nodeid="'+e.id+'"] input[type=checkbox]').prop("checked",t),_.forEach(e.childList,function(e,r){e.checked!==t&&(n.onceCheckChangeNodes.push(e),t?n.checkedNodes.push(e):_.remove(n.checkedNodes,{id:e.id})),e.checked=t,e.isParent&&e.childList&&e.childList.length>0&&n._makeChildrenDone(e,t)})},_convert:function(){var e=this.bakData,t=[];for(var n=0;n<e.length;n++){var r=e[n];e[n].checkType=this.options.checkType;for(var i=0;i<e.length;i++){e[i].isParent=!1;for(var s=0;s<e.length;s++)if(e[s].pid==e[i].id){e[i].isParent=!0;break}}if(r.pid!=null&&r.pid!="null"&&r.pid!=-1)for(var i=0;i<e.length;i++){var o=e[i];if(o.id==r.pid){o.childList=o.childList?o.childList:[],o.childList.push(r);break}}(r.pid==undefined||r.pid==null||r.pid=="null"||r.pid==-1||this.kvNodes[""+r.pid]===undefined)&&t.push(r)}return t},_transformTozTreeFormat:function(){var e=this.bakData,t,n,r=[],i=[];for(t=0,n=e.length;t<n;t++)e[t].checkType=this.options.checkType,e[t].isParent=!1,i[e[t].id]=e[t];for(t=0,n=e.length;t<n;t++)i[e[t].pid]&&e[t]["id"]!=e[t]["pid"]?(i[e[t].pid].isParent=!0,i[e[t].pid].childList||(i[e[t].pid].childList=[]),i[e[t].pid].childList.push(e[t])):r.push(e[t]);return r},_appendNodes:function(e,t){var n=0,i=t.length,s,o=0;while(o*1e3<i)s=t.slice(o*1e3,1e3*++o),function(e,t){setTimeout(function(){var n=[];t.forEach(function(e){n.push(r(e)),n.push("</li></ul>")}),e.append(n.join(""))},o*100)}(e,s)},_appendHtml:function(e,t){var n=0,r=t.length,i,s=0;while(s*1e3<r)i=t.slice(s*1e3,1e3*++s),function(e,t){setTimeout(function(){e.append(t)},s*100)}(e,i)},_generateKv:function(){var e=this.bakData,t=this;this.kvNodes={},_.forEach(e,function(e,n){e.selected&&t.selectedNodeId===""&&(t.selectedNodeId=""+e.id),e.checked&&(_.remove(t.checkedNodes,{id:e.id}),t.checkedNodes.push(e)),t.kvNodes[""+e.id]=e})},_getParentNode:function(e){return this.kvNodes[""+this.kvNodes[""+e].pid]},_createDom:function(e){var t=this.$el,n={};n.hasRoot=!1,n.nodata=!1,this.bakRoot!=null&&!$.isEmptyObject(this.bakRoot)&&(n.hasRoot=!0,n.root=this.bakRoot,this.options.disable&&(n.root.disabled=!0),e.length===0?n.showLine=!1:n.showLine=!0,e.length>0&&(e[0].isParent?n.lg=!1:n.lg=!0,e.length===1?n.multiTop=!1:n.multiTop=!0));if(e.length===0){n.nodata=!0,n.noDataStyle=this.options.noDataStyle,t.empty().append(i(n)).addClass("oas-tree");return}t.empty().append(i(n)).addClass("oas-tree"),this.nodeLevel=0,e.length>1?e[0].mutiTop=!0:e[0].mutiTop=!1,this.bigData=!!this.options.bigData;for(var r=0;r<e.length;r++)e[r].isFirstNode=r==0?!0:!1,e[r].isLastNode=r==e.length-1?!0:!1,this._loopNodes(e[r],0,this.bigData);this.bigData?this._appendHtml(t.find(".oastree-nodes"),this.nodesString):t.find(".oastree-nodes").append(this.nodesString.join("")),_.isNumber(this.options.width)?t.width(this.options.width):undefined,_.isNumber(this.options.height)?t.height(this.options.height):undefined},_loopNodes:function(e,t,n){t||(this.nodeLevel=0,e.level=this.nodeLevel),e.isOpen=!n,this.nodesString.push(r(e));if(e.childList&&e.childList.length>0){this.nodeLevel++;for(var i=0;i<e.childList.length;i++)e.childList[i].level=this.nodeLevel,e.childList[i].isFirstNode=i==0?!0:!1,e.childList[i].isLastNode=i==e.childList.length-1?!0:!1;if(!n)for(var s=0;s<e.childList.length;s++)this._loopNodes(e.childList[s],1)}this.nodesString.push("</ul></li>")},_preRenderData:function(){this._renderData=this._transformTozTreeFormat()},invoke:{data:function(e){this.options.data=e,this._create()},getCheckedNodes:function(){var e=this;if(this.options.returnPartChecked){var t=$.extend(!0,[],this.checkedNodes),n=function(r){var i=e._getParentNode(r.id);i&&(t.push(i),n(i))};return _.forEach(this.checkedNodes,function(e,t){n(e)}),_.uniq(t,"id")}return this.checkedNodes},getSelectedNode:function(){return this.options.root&&this.$el.find(".oastree-root>a").hasClass("current")?this.options.root:this.kvNodes[""+this.selectedNodeId]?this.kvNodes[""+this.selectedNodeId]:null},selectNode:function(e){if(e===""||e===null||e===undefined)return;this.selectedNodeId!==""&&this.$el.find('li[nodeid="'+this.selectedNodeId+'"]>a').removeClass("current"),e==="root"&&this.options.root?(this.selectedNodeId="",this.$el.find(".oastree-root>a").addClass("current"),this._emit("select",[this.options.root])):(this.selectedNodeId=e+"",this.$el.find('li[nodeid="'+e+'"]>a').addClass("current"),this._emit("select",[this._iCall("getSelectedNode")]))},changeCheckedStatus:function(e,t){if(e===""||e===null||e===undefined)return;var n=this.$el.find('li[nodeid="'+e+'"]>input'),r=n.prop("checked");r!==t&&(this.options.checkType==="checkbox"?(this.triggerFlag=!0,this.triggerValue=t,n.trigger("click")):this.options.checkType==="radio"&&(n.prop("checked",t),this.checkedNodes.length=0,t&&this.checkedNodes.push(this.kvNodes[""+e]),this._emit("checkChange",[this._iCall("getCheckedNodes")])))},disable:function(e){this.options.disable=e,this._create()},getAllTreeNodes:function(){return this._renderData}}})});