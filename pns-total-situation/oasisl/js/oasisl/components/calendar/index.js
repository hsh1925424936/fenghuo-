define(["lodash","tpl/calendar/calendar_daysTpl","tpl/calendar/calendar_monthsTpl","tpl/calendar/calendar_yearsTpl","tpl/calendar/calendar_mainTpl","oasisUf"],function(e,t,n,r,i){"use strict";var s=".oas-calendar-select-table",o=".oas-calendar-hd",u=".oas-calendar-year-number",a=".oas-calendar-year-wrap",f=".oas-calendar-month-number",l=".oas-calendar-month-wrap",c=".oas-calendar-start-year-number",h=".oas-calendar-end-year-number",p=".oas-calendar-pre",d=".oas-calendar-next",v=".table-month-item",m=".table-year-item",g=".oas-calendar-time-item-hour",y=".oas-calendar-time-item-minute",b=".oas-calendar-time-item-second";$.oasUiFactory("oasCalendar",{VERSION:"1.0.0",options:{defaultDate:new Date,defaultDisplay:!1,triggerSelector:null,range:[new Date(1900,0,1),new Date(2100,0,1)],specialDate:[],specialStyle:[],isShowTime:!1,container:$("body"),isStatic:!1,isChineseCalendar:!1,startFrom:0,triggerElem:null,type:"single"},events:{target:function(){return this.$calendar},"click .pre-month-day":function(e){var t=$(e),n=t.data("year"),r=t.data("month"),i=t.data("date");return this.displayYear=n-0,this.displayMonth=r-0,this.displayDate=i-0,t.hasClass("disable-item")||(this.selectedDate=new Date(n,r,i)),this._getPreMonth(),this._renderYearMonthHd(),!1},"click .next-month-day":function(e){var t=$(e),n=t.data("year"),r=t.data("month"),i=t.data("date");return this.displayYear=n-0,this.displayMonth=r-0,this.displayDate=i-0,t.hasClass("disable-item")||(this.selectedDate=new Date(n,r,i)),this._getNextMonth(),this._renderYearMonthHd(),!1},"click .current-month-day":function(e){var t=$(e),n=t.data("year"),r=t.data("month"),i=t.data("date"),s;return t.hasClass("disable-item")?!1:(this.displayYear=n-0,this.displayMonth=r-0,this.displayDate=i-0,this.selectedDate=new Date(n,r,i),this.options.isShowTime&&(s=this._getInputTime(),this.selectedDate=new Date(n,r,i,s.hour,s.minute,s.second)),this.$calendar.find(".selected").removeClass("selected"),t.addClass("selected"),!1)},"dblclick .current-month-day":function(e){var t=$(e);return t.hasClass("disable-item")?!1:(this._confirmDate(),this.options.isStatic||this._close(),!1)},"click .oas-calendar-opt-confirm":function(){var e=this.selectedDate.getFullYear(),t=this.selectedDate.getMonth(),n=this.selectedDate.getDate(),r;return this.selectedDate=new Date(e,t,n),this.options.isShowTime&&(r=this._getInputTime(),this.selectedDate=new Date(e,t,n,r.hour,r.minute,r.second)),this._confirmDate(),this.options.isStatic||this._close(),!1},"click .oas-calendar-opt-today":function(){var e,t=new Date,n=t.getFullYear(),r=t.getMonth(),i=t.getDate(),s=t.getHours(),o=t.getMinutes(),u=t.getSeconds();this.selectedDate=t,this.options.isShowTime&&(this.selectedDate=new Date(n,r,i,s,o,u)),this._confirmDate(),this.options.isStatic||this._close()},"click .oas-calendar-opt-clear":function(){this.isStatic||(this.$el.val(""),this._emit("clear"))},"click .oas-calendar-pre":function(){this._getPreDate()[this.changeType](),this._renderYearMonthHd()},"click .oas-calendar-next":function(){this._getNextDate()[this.changeType](),this._renderYearMonthHd()},"click .oas-calendar-month-wrap":function(){this._createMonths(),this.changeType="year",this._typeChange()},"click .table-month-item":function(e){var t=$(e),n=t.data("month"),r=this.displayYear,i=new Date(r,n,1);this.changeType="month",this._typeChange(),this.displayMonth=n-0,this._createDays(i),this._renderYearMonthHd()},"click .oas-calendar-year-wrap":function(){this._createYears(this.displayYear),this.changeType="tenYear",this._typeChange()},"click .table-year-item":function(e){var t=$(e),n=t.data("year");this.changeType="year",this._typeChange(),this.displayYear=n-0,this._createMonths(),this._renderYearMonthHd()},"click .oas-calendar-time-item-hour":function(){this._openSelect("hour")},"click .oas-calendar-time-item-minute":function(){this._openSelect("minute")},"click .oas-calendar-time-item-second":function(){this._openSelect("second")},"click .oas-calendar-time-quick-select>li":function(e){var t=$(e),n=this.$calendar,r;t.data("select-hour")!==undefined?(r=t.data("select-hour"),n.find(g).val(r)):t.data("select-minute")!==undefined?(r=t.data("select-minute"),n.find(y).val(r)):(r=t.data("select-second"),n.find(b).val(r))},"keydown .oas-calendar-time-item>input":function(e,t){if(!(t.keyCode>=48&&t.keyCode<=57)&&!(t.keyCode>=96&&t.keyCode<=105)&&t.keyCode!==8)return!1},"keyup .oas-calendar-time-item>input":function(e,t){var n=$(e).val()-0,r=$(e).data("max-number")-0;if(!(t.keyCode>=48&&t.keyCode<=57||t.keyCode>=96&&t.keyCode<=105))return!1;n>r?$(e).val(r):n<0&&$(e).val(0)}},_create:function(){var e=this.options,t=e.isShowTime,n=e.triggerSelector,r=e.defaultDate;if(e.type=="range"){var i=this.$el.find("input").eq(0),s=this.$el.find("input").eq(1);this.events={},i.oasCalendar({defaultDate:r,defaultDisplay:this.options.defaultDisplay,startFrom:0,isStatic:!1,triggerSelector:Object.prototype.toString.call(n)==="[object Array]"?n[0]:null,isShowTime:t,container:e.container}).on("select.oasCalendar",function(e,t,n){s.oasCalendar("setStart",n)}),s.oasCalendar({defaultDate:r,defaultDisplay:this.options.defaultDisplay,startFrom:0,isStatic:!1,triggerSelector:Object.prototype.toString.call(n)==="[object Array]"?n[1]:null,isShowTime:t,container:e.container}).on("select.oasCalendar",function(e,t,n){i.oasCalendar("setEnd",n)}),this.rangeObj=[i,s],this.invoke.getSelectDate=function(){return[i.oasCalendar("getSelectDate"),s.oasCalendar("getSelectDate")]}}else e.type=="time"?(this.selectedDate=r,this.options.isShowTime=!0,this.displayYear=0,this.displayMonth=0,this.displayDate=1,this._createMainDom(),this._createTimePart(),this._createDays(r),this.$calendar.find(".oas-calendar-hd").css("display","none"),this.$calendar.find(".oas-calendar-select-table").css("display","none")):(this.selectedDate=r,this.displayYear=r.getFullYear(),this.displayMonth=r.getMonth()+1,this.displayDate=r.getDate(),this._createMainDom(),e.isShowTime&&this._createTimePart(),this._createDays(r))},_createMainDom:function(){var e=this.options,t=e.defaultDate,n=t.getTime(),r=t.getMonth(),s=t.getFullYear(),o=this.$el,u=this,a,f=e.container,l=e.isStatic,c=e.isShowTime,h=Math.floor(s/10)*10,p=i({time:n,isStatic:l,year:s,month:this._numberToChinese[r],startYear:h,endYear:h+9,hours:new Array(24),minutes:new Array(12),seconds:new Array(12),isShowTime:c});l?(o.append(p),o.addClass("oas-calendar").addClass("oas-calendar-id"+n),this.$calendar=o):(this.$calendar=$(p),a=this.$calendar,f.append(this.$calendar),a.addClass("dynamic"),o.on("click.oasCalendar",function(){u._open(this.value),u._adjustInput()}),e.triggerSelector&&$(e.triggerSelector).on("click.oasCalendar",function(e){o.trigger("click"),e.stopPropagation()}),e.defaultDisplay&&o.val(this._dateFormat(t)),o.attr("readonly","readonly"),$(document).on("click.oasCalendar",function(e){var t=$(e.target);if(t.hasClass(v)||t.hasClass(m)||t.closest(v).length>0||t.closest(m).length>0)return;!t.is(a)&&t.closest(a).length===0&&!t.is(o)&&u._close()})),this.changeType="month"},_createTimePart:function(){var e=this.selectedDate||this.options.defaultDate,t=e.getHours(),n=e.getMinutes(),r=e.getSeconds(),i=this.$calendar;i.find(g).val(t),i.find(y).val(n),i.find(b).val(r),$(document).on("click.oasCalendar",function(e){var t=$(e.target);!t.hasClass("oas-calendar-time-item-hour")&&!t.hasClass("oas-calendar-time-item-minute")&&!t.hasClass("oas-calendar-time-item-second")&&i.find(".oas-calendar-time-quick-select-wrap").css("display","none")})},_adjustInput:function(){var e=this.$el,t=this.$calendar,n=e.offset().left,r=e.offset().top,i=e.outerHeight();t.offset({top:r+i+5,left:n})},_createDays:function(e){var n=this.options,r=e.getFullYear(),i=e.getMonth(),o=new Date(r,i,1,0,0,0),u=o.getDay(),a=o.getDate(),f=this._getDayInMonth(r,i),l=n.startFrom,c=l<u?u-l:7-(l-u),h=1-c,p=1-c,d=f+1,v=[],m,g,y,b=this._getWeekArr(),w=this.options.range,E=!1,S=0;this.displayYear=r,this.displayMonth=i;for(;S<42;S++)m=new Date(r,i,p,23,59,59),g=new Date(r,i,p,0,0,0),m>=w[0]&&(E=!0),g>w[1]&&(E=!1),y={isAvailable:this._checkAvailable("day",m),dateObj:m,dateFormat:this._dateFormat(m),date:m.getDate(),year:m.getFullYear(),month:m.getMonth(),disableState:E},p<1&&(y.type="pre"),p>=1&&p<=f&&(y.type="current"),p>f&&(y.type="next"),p++,v.push(y);return this.$calendar.find(s).html(t({arr:v,week:b,year:r,month:i})),this._setSelectedDate(),v},_createMonths:function(){var e=0,t=this.options.range[0],r=t.getFullYear(),i=t.getMonth(),t=new Date(r,i,1),o=this.options.range[1],u=o.getFullYear(),a=o.getMonth(),o=new Date(u,a+1,0),f=this.displayYear,l,c=!1,h=[];for(;e<12;e++)l=new Date(f,e,1),l>=t&&(c=!0),l>o&&(c=!1),h.push({name:this._numberToChinese[e]+"月",month:e,year:f,disableState:c});this.$calendar.find(s).html(n({arr:h})),this._setSelectedMonth()},_createYears:function(e){var t=0,n=[],i=Math.floor(e/10)*10-1,o=!1,u=this.options.range[0].getFullYear(),a=this.options.range[1].getFullYear(),f=0;for(;t<12;t++)f=i+t,u<=f&&(o=!0),a<f&&(o=!1),n.push({year:f,disableState:o});this.$calendar.find(s).html(r({arr:n,startYear:i+1,endYear:i+10})),this._setSelectedYear()},_setSelectedDate:function(){var e=this.selectedDate,t=this.$calendar,n=e.getFullYear(),r=e.getMonth(),e=e.getDate();t.find('[data-year="'+n+'"][data-month="'+r+'"][data-date="'+e+'"]').addClass("selected")},_setSelectedMonth:function(){var e=this.selectedDate,t=this.$calendar,n=e.getFullYear(),r=e.getMonth();t.find('[data-year="'+n+'"][data-month="'+r+'"]').addClass("selected")},_setSelectedYear:function(){var e=this.selectedDate,t=this.$calendar,n=e.getFullYear();t.find('[data-year="'+n+'"]').addClass("selected")},_getDays:function(e,t){var n=[];return n},_checkAvailable:function(e,t){return!0},_getDayInMonth:function(e,t){var n=[31,undefined,31,30,31,30,31,31,30,31,30,31];return t===1?e%400===0?29:e%4===0&&e%100!==0?29:28:n[t]},_dateFormat:function(e){var t=e.getFullYear(),n=e.getMonth()+1,n=n>=10?n:"0"+n,r=e.getDate(),r=r>=10?r:"0"+r,i=e.getHours(),i=i>=10?i:"0"+i,s=e.getMinutes(),s=s>=10?s:"0"+s,o=e.getSeconds(),o=o>=10?o:"0"+o;return this.options.isShowTime?this.options.type==="time"?i+":"+s+":"+o:t+"-"+n+"-"+r+" "+i+":"+s+":"+o:t+"-"+n+"-"+r},_getWeekArr:function(){var e=this.options.startFrom,t=[],n=0;if(this.hasExcGetWeek)return this.week;this.hasExcGetWeek=!0;for(;n<7;n++)e===7&&(e=0),t.push({weekName:this._numberToWeek[e]}),e++;return this.week=t,t},_getNextMonth:function(){var e=this.displayYear,t=this.displayMonth,n=1,n=new Date(e,t,n);this._createDays(n)},_getPreMonth:function(){var e=this.displayYear,t=this.displayMonth,n=1,n=new Date(e,t,n);this._createDays(n)},_getNextYear:function(){this.displayYear++,this._createMonths()},_getPreYear:function(){this.displayYear--,this._createMonths()},_getNextTenYear:function(){this.displayYear=this.displayYear+10,this._createYears(this.displayYear)},_getPreTenYear:function(){this.displayYear=this.displayYear-10,this._createYears(this.displayYear)},_getPreDate:function(){var e=this,t={month:function(){e.displayMonth--,e._getPreMonth()},year:function(){e._getPreYear()},tenYear:function(){e._getPreTenYear()}};return t},_getNextDate:function(){var e=this,t={month:function(){e.displayMonth++,e._getNextMonth()},year:function(){e._getNextYear()},tenYear:function(){e._getNextTenYear()}};return t},_getInputTime:function(){var e=this.$calendar,t=e.find(g).val(),n=e.find(y).val(),r=e.find(b).val();return{hour:t,minute:n,second:r}},_renderYearMonthHd:function(e){var t=e?this.selectedDate.getFullYear():this.displayYear,n=e?this.selectedDate.getMonth():this.displayMonth,r=Math.floor(t/10)*10,i=this.$calendar;i.find(u).text(t),i.find(f).text(this._numberToChinese[n]),i.find(c).text(r),i.find(h).text(r+9)},_typeChange:function(){var e=this.changeType,t=this.$calendar;t.find(o).removeClass("year-type").removeClass("month-type").removeClass("tenYear-type").addClass(e+"-type")},_close:function(){var e=this.$calendar;e.css("display","none"),e.find(o).removeClass("year-type").removeClass("tenYear-type").addClass("month-type")},_open:function(e){var t=this.$calendar,n=this.options.isShowTime,r=this.options.range,i=new Date,s=this.selectedDate;e&&this.options.type!=="time"&&(s=this.selectedDate=this._convertStringToDate(e)),r[0]<=i&&r[1]>=i?t.find(".oas-calendar-opt-today").removeClass("disable-now"):(t.find(".oas-calendar-opt-today").addClass("disable-now"),r[0]>i&&(s=this.selectedDate=r[0]),r[1]<i&&(s=this.selectedDate=r[1])),this._renderYearMonthHd(!0),this._createDays(s),n&&this._createTimePart(),t.css("display","block")},_convertStringToDate:function(e){var t=e,n="";return this.options.isShowTime&&(t=e.split(" ")[0],n=e.split(" ")[1]),t=t.split("-"),n=n.split(":"),this.options.isShowTime?new Date(t[0],t[1]-1,t[2],n[0],n[1],n[2]):new Date(t[0],t[1]-1,t[2])},_confirmDate:function(){var e=this.selectedDate,t=this.options.isStatic,n=this._dateFormat(e),r=this.options.range,i=this.$el;if(e<r[0]||e>r[1])return;return this._emit("select",[this.$el,e]),t||i.val(n),n},_openSelect:function(e){var t=this.$calendar,n;t.find(".oas-calendar-time-quick-select").parent().css("display","none"),t.find(".oas-calendar-time-quick-select-"+e).parent().css("display","block"),n=t.find(".oas-calendar-time-item-"+e).val(),t.find(".oas-calendar-time-quick-select-"+e).find("li").removeClass("selected"),t.find(".oas-calendar-time-quick-select-"+e).find("[data-select-"+e+'="'+n+'"]').addClass("selected")},_setInputTime:function(e){typeof e=="string"?this.$el.val(str):Object.prototype.toString.call(e)=="[object Date]"&&this.$el.val(this._dateFormat(e))},_numberToWeek:{0:"日",1:"一",2:"二",3:"三",4:"四",5:"五",6:"六"},_numberToChinese:{0:"一",1:"二",2:"三",3:"四",4:"五",5:"六",6:"七",7:"八",8:"九",9:"十",10:"十一",11:"十二"},invoke:{getSelectDate:function(){return this.selectedDate},getSelectDateObj:function(){var e=this.selectedDate,t=this.options.isShowTime,n={year:e.getFullYear(),month:e.getMonth()+1,date:e.getDate()};return t&&(n.hour=e.getHours(),n.minute=e.getMinutes(),n.second=e.getSeconds()),n},getRange:function(){var e=this.rangeObj;if(e)return[e[0].oasCalendar("getSelectDate"),e[1].oasCalendar("getSelectDate")]},setStart:function(e){Object.prototype.toString.call(e)=="[object Date]"&&(this.options.range[0]=e)},setEnd:function(e){Object.prototype.toString.call(e)=="[object Date]"&&(this.options.range[1]=e)},setInputTime:function(e,t){this.options.type==="single"?this._setInputTime(e):this.options.type==="range"&&(this.rangeObj[0].oasCalendar("setInputTime",e),this.rangeObj[1].oasCalendar("setInputTime",t))}}})});