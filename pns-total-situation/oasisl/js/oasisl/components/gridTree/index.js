define(["oasisUf","template","util","tpl/gridTree/gridTree","tpl/gridTree/gridTree_root","lodash"],function(e,t,n,r,i){"use strict";$.oasUiFactory("oasGridTree",{VERSION:"1.0.0",options:{root:null,head:null,data:[],dataType:"array",noDataStyle:0,showType:1},_create:function(){this.bakData=$.extend(!0,[],this.options.data),this.nodesString=[],this.arrayTypeData=[],this._tidyData(),this._generateKv(),this._preRenderData(),this._createDom(this._renderData),this._generateKv()},_tidyData:function(){var e=this.bakData,t=this;this.options.dataType==="tree"&&(this._tree2Array(e),this.bakData=this.arrayTypeData),_.forEach(this.bakData,function(e,n){t.options.dataType==="tree"&&e.childList&&delete e.childList})},_tree2Array:function(e){for(var t=0;t<e.length;t++)this.arrayTypeData.push(e[t]),e[t].childList&&e[t].childList.length>0&&this._tree2Array(e[t].childList)},events:{target:function(){return this.$el},"click td.td-first>a":function(e,t){var n=$(e).closest("tr").attr("isparent"),r=null;n==="true"&&(r=$(e).closest("tr").nextAll("[pid="+$(e).closest("tr").attr("tid")+"]"),$(e).closest("tr").toggleClass("open"),$(e).closest("tr").hasClass("open")?(r.removeClass("tr-hide"),this._findNexts(r)):(r.addClass("tr-hide"),this._findNexts(r,1)))},"click td.td-root>a":function(e,t){var n=$(e).closest("tr").nextAll("[tlevel=0]");$(e).closest("tr").toggleClass("open"),$(e).closest("tr").hasClass("open")?(n.removeClass("tr-hide"),this._findNexts(n)):(n.addClass("tr-hide"),this._findNexts(n,1))}},_findNexts:function(e,t){var n=$.extend(!0,[],e),r=this;_.forEach(n,function(e,n){var i=$(e).attr("isparent"),s=$(e).hasClass("open");if(i==="true"){var o=$(e).nextAll("[pid="+$(e).attr("tid")+"]");t?o.addClass("tr-hide"):s?o.removeClass("tr-hide"):o.addClass("tr-hide"),t?r._findNexts(o,1):r._findNexts(o)}})},_convert:function(){var e=this.bakData,t=[];for(var n=0;n<e.length;n++){var r=e[n];e[n].checkType=this.options.checkType;for(var i=0;i<e.length;i++){e[i].isParent=!1;for(var s=0;s<e.length;s++)if(e[s].pid==e[i].id){e[i].isParent=!0;break}}if(r.pid!=null&&r.pid!="null"&&r.pid!=-1)for(var i=0;i<e.length;i++){var o=e[i];if(o.id==r.pid){o.childList=o.childList?o.childList:[],o.childList.push(r);break}}(r.pid==undefined||r.pid==null||r.pid=="null"||r.pid==-1||this.kvNodes[""+r.pid]===undefined)&&t.push(r)}return t},_transformTozTreeFormat:function(){var e=this.bakData,t,n,r=[],i=[];for(t=0,n=e.length;t<n;t++)e[t].checkType=this.options.checkType,e[t].isParent=!1,i[e[t].id]=e[t];for(t=0,n=e.length;t<n;t++)i[e[t].pid]&&e[t]["id"]!=e[t]["pid"]?(i[e[t].pid].isParent=!0,i[e[t].pid].childList||(i[e[t].pid].childList=[]),i[e[t].pid].childList.push(e[t])):r.push(e[t]);return r},_generateKv:function(){var e=this.bakData,t=this;this.kvNodes={},_.forEach(e,function(e,n){t.kvNodes[""+e.id]=e})},_getParentNode:function(e){return this.kvNodes[""+this.kvNodes[""+e].pid]},_createDom:function(e){var t=this.$el,n={};n.hasRoot=!1,n.nodata=!1,n.head=this.options.head,this.options.root!=null&&(n.hasRoot=!0,n.root=this.options.root);if(e.length===0){n.nodata=!0,n.noDataStyle=this.options.noDataStyle,t.empty().append(i(n));return}t.empty().append(i(n)),this.nodeLevel=0;for(var r=0;r<e.length;r++)e[r].isFirstNode=r==0?!0:!1,e[r].isLastNode=r==e.length-1?!0:!1,this._loopNodes(e[r],0);t.find(".gridTree-root")&&t.find(".gridTree-root").size()>0?t.find(".gridTree-root").after(this.nodesString.join("")):t.find("tbody").append(this.nodesString.join(""))},_loopNodes:function(e,t){t||(this.nodeLevel=0,e.level=this.nodeLevel),e.isOpen=!1,this.nodesString.push(r(this._tidyTreeData(e)));if(e.childList&&e.childList.length>0){this.nodeLevel=e.level,this.nodeLevel++;for(var n=0;n<e.childList.length;n++)e.childList[n].level=this.nodeLevel,e.childList[n].isHide=e.isOpen?!1:!0,e.childList[n].isFirstNode=n==0?!0:!1,e.childList[n].isLastNode=n==e.childList.length-1?!0:!1;for(var i=0;i<e.childList.length;i++)this._loopNodes(e.childList[i],1)}},_tidyTreeData:function(e){var n={},r=[];n.node=e;var i=this.options.head;r.push(e);for(var s=1;s<i.length;s++){var o=i[s].dataRender;if(o&&typeof o=="string"){var u=t.compile(o)(e);r.push(u)}else r.push(e[i[s].name])}return n.data=r,n},_preRenderData:function(){this._renderData=this._transformTozTreeFormat()},invoke:{data:function(e){this.options.data=e,this._create()}}})});