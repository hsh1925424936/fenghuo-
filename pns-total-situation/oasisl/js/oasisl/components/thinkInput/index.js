define(["position","tpl/thinkInput/bodyTplA","tpl/thinkInput/main","tpl/thinkInput/bodyTplB","tpl/thinkInput/bodyTplC","oasisUf","oasPagin"],function(e,t,n,r,i){"use strict";$.oasUiFactory("oasThinkInput",{VERSION:"1.0.0",options:{data:[],isBatch:!0,parentEl:null,paginInfo:{type:"little",current:1,total:0,pageItems:8,pageNoChange:function(e,t,n){}},blankDom:"",fillField:"",nodataTip:"没有找到类似数据"},events:{target:function(){return this.$think_el},"click .associate-item":function(e,t){return this.options.fillField?this.triggerEle.val(this.currentList[this.hoverIndex][this.options.fillField]):this.triggerEle.val(this.currentList[this.hoverIndex].label),this.inputValue=this.triggerEle.val(),this._emit("onSelect",[this.currentList[this.hoverIndex]]),this.$think_el.hide(),this.isOpen=!1,!1},"mouseover .associate-item":function(e,t){return this.$think_el.find(".associate-item").removeClass("current"),$(e).addClass("current"),this.hoverIndex=$(e).attr("index"),!1},"mouseout .associate-item":function(e,t){return this.$think_el.find(".associate-item").removeClass("current"),$(e).removeClass("current"),this.hoverIndex=-1,!1}},_adjustPanel:function(){var e=this.options,t=this.triggerEle,n=this.$think_el,r=this,i=n.outerHeight(),s=n.outerWidth(),o={height:$(window).height(),width:$(window).width(),scrollTop:$(window).scrollTop(),scrollLeft:$(window).scrollLeft()};n.show()},_create:function(){var e=this;this.triggerEle=this.$el,this.triggerEle.addClass("oasThinkInput"),!this.triggerEle.attr("placeholder")&&!this.options.isBatch&&this.triggerEle.attr("placeholder","多项匹配以空格隔开"),this.hoverIndex=-1,this.currentList=[],this.inputValue="",this.isShowFt=!0,s.allThinkInput.push(this),this.isOpen=!1;if(!this.options.isBatch)this.allData=this.options.data,this._dealData(),this._dataByIndex(parseInt(this.options.paginInfo.current,10)-1),this.options.paginInfo.pageNoChange=function(t,n,r){e.options.paginInfo.current=parseInt(n),e._onPageNoChage(n-1,r)};else{this.currentList=this.options.data;var t=this.options.paginInfo.pageItems-this.currentList.length;if(this.currentList.length<this.options.paginInfo.pageItems)for(var n=0;n<t;n++)this.currentList.push({label:"",num:"",value:""})}this._preRenderData(),this._createDom(),this._bindChange(),this._showAndHide(),this.triggerEle.live("click",function(){e._emit("onClick")})},_preRenderData:function(e){var t=this.options,n=!1,r=t.blankDom,i={};n=t.paginInfo.total==0||t.data.length==0?!0:!1,this._tidyMatchLabel(),this._renderData=i={list:this.matchList,isNoData:n,blankDom:r,nodataTip:t.nodataTip},this.isNoData=n,this.isShowFt=!this.isNoData},_createDom:function(e){var r;e==1?(r=t(this._renderData),this.$think_el.append(r),this.$think_el.find(".associate-pagin").oasPagin(this.options.paginInfo).on("pageNoChange.oasPagin",this.options.paginInfo.pageNoChange)):(r=n(this._renderData),this.$think_el=$(r),this.options.parentEl?$(this.options.parentEl).append(this.$think_el):$("body").append(this.$think_el),this.$think_el.find(".associate-pagin").oasPagin(this.options.paginInfo).on("pageNoChange.oasPagin",this.options.paginInfo.pageNoChange)),this.options.paginInfo.total==0?this.options.blankDom==""&&this.$think_el.find(".associate-bd").height(21):this.$think_el.find(".associate-bd").height(this.options.paginInfo.pageItems*30),this.options.paginInfo.total<=this.options.paginInfo.pageItems&&(this.$think_el.find(".associate-ft").hide(),this.isShowFt=!1,this.$think_el.find(".associate-bd").addClass("no-bottom"));var i=this.triggerEle.width()<228?228:this.triggerEle.width();this.$think_el.width(i),e==1&&this._adjustPanel()},_bindChange:function(){var e=this,t="";this.triggerEle.keyup(function(){t=$(this).val();if(e.inputValue===t)return;e.inputValue=t,e._emit("onChange",[$(this).val()]);if(!e.options.isBatch){var n=e.allData,r=[];for(var i=0;i<n.length;i++)(e.matchInput(t,n[i].label)||n[i].num&&e.matchInput(t,n[i].num)||n[i].value&&e.matchInput(t,n[i].value))&&r.push(n[i]);e._iCall("data",[r,r.length,!0])}})},_tidyMatchLabel:function(){var e=this.triggerEle.val(),t=this.currentList,n=$.extend(!0,[],t),r=e.split(" ");for(var i=0;i<n.length;i++)for(var s=0;s<r.length;s++){var o=n[i].label.toUpperCase().indexOf(r[s].toUpperCase());o!=-1&&(n[i].label=n[i].label.substring(0,o)+"<span>"+n[i].label.substring(o,o+r[s].length)+"</span>"+n[i].label.substring(o+r[s].length,n[i].label.length))}this.matchList=n},_setPosition:function(t,n,r){var i=e.getPosition(t,n,r);i.top-=10;if(this.options.parentEl){var s=$(this.options.parentEl).offset(),o=this.triggerEle.offset(),u={};u.top=o.top-s.top+this.triggerEle.outerHeight(),u.left=o.left-s.left-(n.outerWidth()-this.triggerEle.outerWidth())/2,n.css(u)}else n.offset(i)},_showAndHide:function(){var e=this.options,t=this.triggerEle,n=this.$think_el,r="bottom",i=this,s=n.outerHeight(),o=n.outerWidth(),u={height:$(window).height(),width:$(window).width(),scrollTop:$(window).scrollTop(),scrollLeft:$(window).scrollLeft()};t.on("click",function(){n.show(),i._setPosition(t,n,r),i.isOpen=!0}),$(window).on("click",function(e){var t=$(e.target);t.is(".oas-associate-panel,.oas-associate-panel *, .oasThinkInput")||(n.hide(),i.isOpen=!1)})},_onPageNoChage:function(e,t){this._dataByIndex(e),this._tidyMatchLabel();var n={list:this.matchList},i=r(n);this.$think_el.find(".associate-bd").html("").html(i)},_dealData:function(){var e=this.options.data,t=e.length,n=this.options.paginInfo.pageItems,r=Math.ceil(t/n),i=t%n,s={};if(t>0)if(r==1)s[0]=e;else{for(var o=0;o<r-1;o++){var u=[];for(var a=0;a<n;a++)u.push(e[o*n+a]);s[o+""]=u}var f=[];i=i==0?n:i;for(var l=0;l<i;l++)f.push(e[(r-1)*n+l]);s[r-1+""]=f}else t==0&&(s[0]=[]);this.pageNum=r,this.dataByIndex=s,this.total=t},_dataByIndex:function(e){this.currentList=this.dataByIndex[e+""],this.currentList||(this.currentList=this.dataByIndex[0]),this.currentTrueLength=this.currentList.length;if(this.currentList.length<this.options.paginInfo.pageItems)for(var t=0;t<this.options.paginInfo.pageItems-this.currentList.length;t++)this.currentList.push({label:"",num:"",value:""});this.currentPage=e},matchInput:function(e,t){var n=e.split(" "),r=0;for(var i=0;i<n.length;i++){var s=t.toLowerCase().indexOf(n[i].toLowerCase());s!=-1&&r++}return r==n.length?!0:!1},_dealIsBatch:function(){var e=this,t=this.triggerEle.val();if(!this.options.isBatch){var n=this.allData,r=[];for(var i=0;i<n.length;i++)(e.matchInput(t,n[i].label)||n[i].num&&e.matchInput(t,n[i].num)||e.matchInput(t,n[i].value))&&r.push(n[i]);this._iCall("data",[r,r.length,!0,!0])}},_renderCurrentPage:function(){var e=this.$think_el;e.find(".associate-item").text(""),$.each(this.currentList,function(t,n){e.find(".associate-item[index="+t+"]").text(n.label)})},_liUp:function(e){var t=this,n=t.hoverIndex,r=this.$think_el;return t.isOpen&&n!=-1&&n>0&&(e.preventDefault(),t.hoverIndex--,this.$think_el.find('.associate-item[index="'+t.hoverIndex+'"]').trigger("mouseover")),!1},_liDown:function(e){var t=this,n=t.hoverIndex,r=this.$think_el;return t.isOpen&&n<t.currentTrueLength-1&&(e.preventDefault(),t.hoverIndex++,this.$think_el.find('.associate-item[index="'+t.hoverIndex+'"]').trigger("mouseover")),!1},_click:function(){this.hoverIndex!=-1&&(this.triggerEle.blur(),this.$think_el.find('.associate-item[index="'+this.hoverIndex+'"]').trigger("click"))},invoke:{data:function(e,t,n,i){var s=this,o=this.$think_el;this.options.data=e,t!=undefined&&(this.options.paginInfo.total=t,this.$think_el.find(".associate-pagin").oasPagin("total",t));if(this.options.isBatch){this.hoverIndex=-1,this.currentList=this.options.data;if(this.isNoData&&this.currentList.length>0){this.currentList=this.options.data;var u=this.options.paginInfo.pageItems-this.currentList.length;if(this.currentList.length<this.options.paginInfo.pageItems)for(var a=0;a<u;a++)this.currentList.push({label:"",num:"",value:""});var f={list:this.currentList},l=r(f);o.find(".associate-bd").html("").html(l),o.find(".associate-bd").removeClass("no-bottom"),o.find(".associate-bd").height(this.options.paginInfo.pageItems*30)}else if(!this.isNoData&&this.currentList.length>0)o.find(".associate-item").text(""),$.each(this.options.data,function(e,t){var n=o.find(".associate-item[index="+e+"]");n.html(t.label).attr("title",t.title)});else if(this.currentList.length==0){var f={isNoData:!0,blankDom:this.options.blankDom,nodataTip:this.options.nodataTip},l=bodyTplC(f);o.find(".associate-bd").html("").html(l),o.find(".associate-bd").addClass("no-bottom"),this.options.blankDom==""&&o.find(".associate-bd").height(21)}this.options.paginInfo.total<=this.options.paginInfo.pageItems?(this.$think_el.find(".associate-ft").hide(),this.isShowFt=!1,this.$think_el.find(".associate-bd").addClass("no-bottom")):(this.$think_el.find(".associate-ft").show(),this.isShowFt=!0,this.$think_el.find(".associate-bd").removeClass("no-bottom"))}else{n||(this.allData=this.options.data),this.$think_el.html(""),this.hoverIndex=-1,this.currentList=[];var c=this.pageNum;this._dealData(),c!=this.pageNum?(this._dataByIndex(0),this.options.paginInfo.current=1):this._dataByIndex(parseInt(this.options.paginInfo.current,10)-1),this._preRenderData(i),this._createDom(1),!n}this.isNoData=this.options.paginInfo.total==0||this.options.data.length==0?!0:!1,this.isShowFt=!this.isNoData},current:function(e){var t=parseInt(e,10);this.options.paginInfo.current=t,this.$think_el.find(".associate-pagin").oasPagin("current",t)},open:function(){this._emit("onOpen"),this.$think_el.show()},close:function(){this.isOpen=!1,this._emit("onClose"),this.$think_el.hide()},showLoading:function(){this.$think_el.find(".associate-bd").hide(),this.$think_el.find(".associate-ft").hide(),this.$think_el.find(".associate-loading").show()},hideLoading:function(){this.$think_el.find(".associate-bd").show(),this.isShowFt?this.$think_el.find(".associate-ft").show():this.$think_el.find(".associate-ft").hide(),this.$think_el.find(".associate-loading").hide()}}});var s={};s.allThinkInput=[],$(document).off("keydown.oasThinkInput"),$(document).on("keydown.oasThinkInput",function(e){switch(e.keyCode){case 38:$.each(s.allThinkInput,function(t,n){n.isOpen&&n._liUp(e)});break;case 40:$.each(s.allThinkInput,function(t,n){n.isOpen&&n._liDown(e)});break;case 13:$.each(s.allThinkInput,function(t,n){n.isOpen&&n._click(e)});break;default:}})});